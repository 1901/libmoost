<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>libmoost: /home/mhx/git/github/libmoost/test/kvds/ikvds.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>


</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">libmoost
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('ikvds_8cpp.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">/home/mhx/git/github/libmoost/test/kvds/ikvds.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="ikvds_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* vim:set ts=3 sw=3 sts=3 et: */</span>
<a name="l00028"></a>00028 <span class="comment">// Include boost test framework required headers</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;boost/test/unit_test.hpp&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;boost/test/test_tools.hpp&gt;</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="comment">// Include CRT/STL required header(s)</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;stdexcept&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;vector&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;set&gt;</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;boost/cstdint.hpp&gt;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;../../include/moost/testing/test_directory_creator.hpp&quot;</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="comment">// Include thrift headers</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="comment">// Include application required header(s)</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;../../include/moost/kvds.hpp&quot;</span>
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="comment">// Imported required namespace(s)</span>
<a name="l00047"></a>00047 <span class="keyword">using</span> boost::uint32_t;
<a name="l00048"></a>00048 <span class="keyword">using namespace </span>moost::kvds;
<a name="l00049"></a>00049 <span class="keyword">using namespace </span>moost::testing;
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="comment">// Name the test suite</span>
<a name="l00052"></a>00052 BOOST_AUTO_TEST_SUITE( ikvdsTest )
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="comment">// Define the test fixture</span>
<a name="l00055"></a>00055 struct <a class="code" href="struct_fixture.html">Fixture</a>
<a name="l00056"></a>00056 {
<a name="l00057"></a><a class="code" href="struct_fixture.html#acb7770047754824e858c00cf836ca741">00057</a>    <a class="code" href="classmoost_1_1testing_1_1test__directory__creator.html">test_directory_creator</a> <a class="code" href="struct_fixture.html#acb7770047754824e858c00cf836ca741">tdc</a>;
<a name="l00058"></a>00058 
<a name="l00059"></a>00059    <span class="comment">// C_tor</span>
<a name="l00060"></a><a class="code" href="struct_fixture.html#a7bd87f852602d02a205b4a811530dfe4">00060</a>    Fixture()
<a name="l00061"></a>00061    {
<a name="l00062"></a>00062    }
<a name="l00063"></a>00063 
<a name="l00064"></a>00064    <span class="comment">// D_tor</span>
<a name="l00065"></a><a class="code" href="struct_fixture.html#af2dff56606d5787ed05b3153aea927c3">00065</a>    ~Fixture()
<a name="l00066"></a>00066    {
<a name="l00067"></a>00067    }
<a name="l00068"></a>00068 };
<a name="l00069"></a>00069 
<a name="l00070"></a><a class="code" href="class_i_kvds_tester.html">00070</a> <span class="keyword">class </span><a class="code" href="class_i_kvds_tester.html">IKvdsTester</a>
<a name="l00071"></a>00071 {
<a name="l00072"></a>00072    <span class="comment">// NB. We use BOOST_REQUIRE since each test is dependent on the previous one working.</span>
<a name="l00073"></a>00073    <span class="comment">//     This is to avoid having to re-populate the datastore for each test (save time).</span>
<a name="l00074"></a>00074 
<a name="l00075"></a><a class="code" href="class_i_kvds_tester.html#a938a5919404db250822fab42834ad5d0">00075</a>    <span class="keyword">typedef</span> IKvds <a class="code" href="class_i_kvds_tester.html#a938a5919404db250822fab42834ad5d0">kvds_type</a>;
<a name="l00076"></a>00076 
<a name="l00077"></a><a class="code" href="class_i_kvds_tester.html#aec47c036c04a1c1d5f9d3cb03227171a">00077</a>    <span class="keyword">static</span> uint32_t <span class="keyword">const</span> val0_mask = 0xF1E2D3C4;
<a name="l00078"></a><a class="code" href="class_i_kvds_tester.html#a4cd736fbf8839943f3d88d95994e61a7">00078</a>    <span class="keyword">static</span> uint32_t <span class="keyword">const</span> val1_mask = 0x12345678;
<a name="l00079"></a>00079 
<a name="l00080"></a>00080 
<a name="l00081"></a><a class="code" href="class_i_kvds_tester.html#a1f8814ab868481fb923d725faa4f7010">00081</a>    <span class="keywordtype">void</span> test_get_noexist(<a class="code" href="class_i_kvds_tester.html#a938a5919404db250822fab42834ad5d0">kvds_type</a> &amp; kvds)
<a name="l00082"></a>00082    {
<a name="l00083"></a>00083       <span class="comment">// These should ALL fail.</span>
<a name="l00084"></a>00084       uint32_t val_get = 0;
<a name="l00085"></a>00085       <span class="keywordtype">size_t</span> val_get_size = <span class="keyword">sizeof</span>(val_get);
<a name="l00086"></a>00086 
<a name="l00087"></a>00087       <span class="keywordflow">for</span>(uint32_t key = 1 ; key != 0 ; key &lt;&lt;= 1)
<a name="l00088"></a>00088       {
<a name="l00089"></a>00089          <span class="keywordflow">for</span>(uint32_t val_put = 1 ; val_put != 0 ; val_put &lt;&lt;= 1)
<a name="l00090"></a>00090          {
<a name="l00091"></a>00091             BOOST_REQUIRE(!kvds.get(&amp;key, <span class="keyword">sizeof</span>(key), &amp;val_get, val_get_size));
<a name="l00092"></a>00092          }
<a name="l00093"></a>00093       }
<a name="l00094"></a>00094    }
<a name="l00095"></a>00095 
<a name="l00096"></a><a class="code" href="class_i_kvds_tester.html#a06a8ea09f2ee25bd5934d8ed834928cc">00096</a>    <span class="keywordtype">void</span> test_siz(<a class="code" href="class_i_kvds_tester.html#a938a5919404db250822fab42834ad5d0">kvds_type</a> &amp; kvds, <span class="keywordtype">size_t</span> <span class="keyword">const</span> cnt, <span class="keywordtype">bool</span> <span class="keyword">const</span> bExists = <span class="keyword">true</span>)
<a name="l00097"></a>00097    {
<a name="l00098"></a>00098       <span class="keywordtype">size_t</span> <span class="keyword">const</span> size = <span class="keyword">sizeof</span>(uint32_t) * cnt;
<a name="l00099"></a>00099 
<a name="l00100"></a>00100       <span class="keywordflow">for</span>(uint32_t key = 1 ; key != 0 ; key &lt;&lt;= 1)
<a name="l00101"></a>00101       {
<a name="l00102"></a>00102          <span class="keywordtype">size_t</span> vsize;
<a name="l00103"></a>00103          BOOST_REQUIRE(bExists == kvds.siz(&amp;key, <span class="keyword">sizeof</span>(key), vsize));
<a name="l00104"></a>00104 
<a name="l00105"></a>00105          <span class="keywordflow">if</span>(bExists)
<a name="l00106"></a>00106          {
<a name="l00107"></a>00107             BOOST_REQUIRE(size == vsize);
<a name="l00108"></a>00108          }
<a name="l00109"></a>00109       }
<a name="l00110"></a>00110    }
<a name="l00111"></a>00111 
<a name="l00112"></a><a class="code" href="class_i_kvds_tester.html#a1fa88db2ef2f38461561aadad39cf275">00112</a>    <span class="keywordtype">void</span> test_add_cnt_get(<a class="code" href="class_i_kvds_tester.html#a938a5919404db250822fab42834ad5d0">kvds_type</a> &amp; kvds)
<a name="l00113"></a>00113    {
<a name="l00114"></a>00114       uint32_t <span class="keyword">const</span> val_add_mask = val1_mask;
<a name="l00115"></a>00115       boost::uint64_t ecnt = 0;
<a name="l00116"></a>00116 
<a name="l00117"></a>00117       <span class="keywordflow">for</span>(uint32_t key = 1 ; key != 0 ; key &lt;&lt;= 1)
<a name="l00118"></a>00118       {
<a name="l00119"></a>00119          uint32_t <span class="keyword">const</span> val_add = key ^ val_add_mask;
<a name="l00120"></a>00120          uint32_t val_get = 0;
<a name="l00121"></a>00121          <span class="keywordtype">size_t</span> val_get_size1 = <span class="keyword">sizeof</span>(val_get);
<a name="l00122"></a>00122          <span class="keywordtype">size_t</span> val_get_size2 = <span class="keyword">sizeof</span>(val_get) + 2;
<a name="l00123"></a>00123          <span class="keywordtype">size_t</span> val_get_size3 = 1;
<a name="l00124"></a>00124 
<a name="l00125"></a>00125          boost::uint64_t cnt = 0;
<a name="l00126"></a>00126          BOOST_REQUIRE(kvds.cnt(cnt));
<a name="l00127"></a>00127          BOOST_REQUIRE(ecnt == cnt);
<a name="l00128"></a>00128          BOOST_REQUIRE(kvds.add(&amp;key, <span class="keyword">sizeof</span>(key), &amp;val_add, <span class="keyword">sizeof</span>(val_add)));
<a name="l00129"></a>00129          BOOST_REQUIRE(kvds.cnt(cnt));
<a name="l00130"></a>00130          BOOST_REQUIRE(++ecnt == cnt);
<a name="l00131"></a>00131 
<a name="l00132"></a>00132          BOOST_REQUIRE(kvds.get(&amp;key, <span class="keyword">sizeof</span>(key), &amp;val_get, val_get_size1));
<a name="l00133"></a>00133          BOOST_REQUIRE(<span class="keyword">sizeof</span>(val_get) == val_get_size1);
<a name="l00134"></a>00134          BOOST_REQUIRE(val_add == val_get);
<a name="l00135"></a>00135 
<a name="l00136"></a>00136          BOOST_REQUIRE(kvds.get(&amp;key, <span class="keyword">sizeof</span>(key), &amp;val_get, val_get_size2));
<a name="l00137"></a>00137          BOOST_REQUIRE(<span class="keyword">sizeof</span>(val_get) == val_get_size2);
<a name="l00138"></a>00138          BOOST_REQUIRE(val_add == val_get);
<a name="l00139"></a>00139 
<a name="l00140"></a>00140          BOOST_REQUIRE(kvds.get(&amp;key, <span class="keyword">sizeof</span>(key), &amp;val_get, val_get_size3));
<a name="l00141"></a>00141          BOOST_REQUIRE(1 == val_get_size3);
<a name="l00142"></a>00142          BOOST_REQUIRE(val_add == val_get);
<a name="l00143"></a>00143       }
<a name="l00144"></a>00144    }
<a name="l00145"></a>00145 
<a name="l00146"></a><a class="code" href="class_i_kvds_tester.html#a6c6aa0fc527b1a21ea614134c4d38231">00146</a>    <span class="keywordtype">void</span> test_put_cnt_get(<a class="code" href="class_i_kvds_tester.html#a938a5919404db250822fab42834ad5d0">kvds_type</a> &amp; kvds, <span class="keywordtype">bool</span> bCheckCnt = <span class="keyword">true</span>)
<a name="l00147"></a>00147    {
<a name="l00148"></a>00148       uint32_t <span class="keyword">const</span> val_put_mask = val0_mask;
<a name="l00149"></a>00149       boost::uint64_t ecnt = 0;
<a name="l00150"></a>00150 
<a name="l00151"></a>00151       <span class="keywordflow">for</span>(uint32_t key = 1 ; key != 0 ; key &lt;&lt;= 1)
<a name="l00152"></a>00152       {
<a name="l00153"></a>00153          uint32_t <span class="keyword">const</span> val_put = key ^ val_put_mask;
<a name="l00154"></a>00154          uint32_t val_get = 0;
<a name="l00155"></a>00155          <span class="keywordtype">size_t</span> val_get_size1 = <span class="keyword">sizeof</span>(val_get);
<a name="l00156"></a>00156          <span class="keywordtype">size_t</span> val_get_size2 = <span class="keyword">sizeof</span>(val_get) + 2;
<a name="l00157"></a>00157          <span class="keywordtype">size_t</span> val_get_size3 = 1;
<a name="l00158"></a>00158 
<a name="l00159"></a>00159          BOOST_REQUIRE(kvds.put(&amp;key, <span class="keyword">sizeof</span>(key), &amp;val_put, <span class="keyword">sizeof</span>(val_put)));
<a name="l00160"></a>00160 
<a name="l00161"></a>00161          <span class="keywordflow">if</span>(bCheckCnt)
<a name="l00162"></a>00162          {
<a name="l00163"></a>00163             boost::uint64_t cnt = 0;
<a name="l00164"></a>00164             BOOST_REQUIRE(kvds.cnt(cnt));
<a name="l00165"></a>00165             BOOST_REQUIRE(++ecnt == cnt);
<a name="l00166"></a>00166          }
<a name="l00167"></a>00167 
<a name="l00168"></a>00168          BOOST_REQUIRE(kvds.get(&amp;key, <span class="keyword">sizeof</span>(key), &amp;val_get, val_get_size1));
<a name="l00169"></a>00169          BOOST_REQUIRE(<span class="keyword">sizeof</span>(val_get) == val_get_size1);
<a name="l00170"></a>00170          BOOST_REQUIRE(val_put == val_get);
<a name="l00171"></a>00171 
<a name="l00172"></a>00172          BOOST_REQUIRE(kvds.get(&amp;key, <span class="keyword">sizeof</span>(key), &amp;val_get, val_get_size2));
<a name="l00173"></a>00173          BOOST_REQUIRE(<span class="keyword">sizeof</span>(val_get) == val_get_size2);
<a name="l00174"></a>00174          BOOST_REQUIRE(val_put == val_get);
<a name="l00175"></a>00175 
<a name="l00176"></a>00176          BOOST_REQUIRE(kvds.get(&amp;key, <span class="keyword">sizeof</span>(key), &amp;val_get, val_get_size3));
<a name="l00177"></a>00177          BOOST_REQUIRE(1 == val_get_size3);
<a name="l00178"></a>00178          BOOST_REQUIRE(val_put == val_get);
<a name="l00179"></a>00179       }
<a name="l00180"></a>00180    }
<a name="l00181"></a>00181 
<a name="l00182"></a><a class="code" href="class_i_kvds_tester.html#ac0777a39c6f57eb6811b7abc5c2b5f6f">00182</a>    <span class="keywordtype">void</span> test_add_all(<a class="code" href="class_i_kvds_tester.html#a938a5919404db250822fab42834ad5d0">kvds_type</a> &amp; kvds)
<a name="l00183"></a>00183    {
<a name="l00184"></a>00184       <span class="keywordflow">for</span>(uint32_t key = 1 ; key != 0 ; key &lt;&lt;= 1)
<a name="l00185"></a>00185       {
<a name="l00186"></a>00186          uint32_t <span class="keyword">const</span> val_add = key ^ val1_mask;
<a name="l00187"></a>00187          uint32_t val_get[2] = { 0 };
<a name="l00188"></a>00188          <span class="keywordtype">size_t</span> val_get_size = <span class="keyword">sizeof</span>(val_get);
<a name="l00189"></a>00189 
<a name="l00190"></a>00190          BOOST_REQUIRE(kvds.add(&amp;key, <span class="keyword">sizeof</span>(key), &amp;val_add, <span class="keyword">sizeof</span>(val_add)));
<a name="l00191"></a>00191          BOOST_REQUIRE(kvds.all(&amp;key, <span class="keyword">sizeof</span>(key), &amp;val_get, val_get_size));
<a name="l00192"></a>00192          BOOST_REQUIRE(<span class="keyword">sizeof</span>(val_get) == val_get_size);
<a name="l00193"></a>00193          BOOST_REQUIRE((key ^ val0_mask) == val_get[0]);
<a name="l00194"></a>00194          BOOST_REQUIRE((key ^ val1_mask) == val_get[1]);
<a name="l00195"></a>00195       }
<a name="l00196"></a>00196    }
<a name="l00197"></a>00197 
<a name="l00198"></a><a class="code" href="class_i_kvds_tester.html#a39e182caf1e068d21c563a04d29e857d">00198</a>    <span class="keywordtype">void</span> test_beg_nxt_end(<a class="code" href="class_i_kvds_tester.html#a938a5919404db250822fab42834ad5d0">kvds_type</a> &amp; kvds)
<a name="l00199"></a>00199    {
<a name="l00200"></a>00200       uint32_t key = 0;
<a name="l00201"></a>00201       <span class="keywordtype">size_t</span> key_size = <span class="keyword">sizeof</span>(key);
<a name="l00202"></a>00202 
<a name="l00203"></a>00203       <span class="comment">// Not called beg() yet so this should signal end!</span>
<a name="l00204"></a>00204       BOOST_REQUIRE(kvds.end());
<a name="l00205"></a>00205       BOOST_REQUIRE(!kvds.nxt(&amp;key, key_size));
<a name="l00206"></a>00206       BOOST_REQUIRE(0 == key_size);
<a name="l00207"></a>00207 
<a name="l00208"></a>00208       <span class="comment">// Keys come out in no particular order, so we need</span>
<a name="l00209"></a>00209       <span class="comment">// to build a set of keys we expect to see</span>
<a name="l00210"></a>00210       std::set&lt;uint32_t&gt; keySet;
<a name="l00211"></a>00211 
<a name="l00212"></a>00212       <span class="comment">// Build a set of all they keys we expect to see</span>
<a name="l00213"></a>00213       <span class="keywordflow">for</span>(key = 1 ; key != 0 ; key &lt;&lt;= 1)
<a name="l00214"></a>00214       {
<a name="l00215"></a>00215          keySet.insert(key);
<a name="l00216"></a>00216       }
<a name="l00217"></a>00217 
<a name="l00218"></a>00218       BOOST_REQUIRE(kvds.beg());
<a name="l00219"></a>00219       <span class="keywordflow">for</span>(uint32_t cnt = 1 ; cnt != 0 ; cnt &lt;&lt;= 1)
<a name="l00220"></a>00220       {
<a name="l00221"></a>00221          <span class="keywordflow">for</span>(<span class="keywordtype">int</span> testcase = 0; testcase &lt; 2 ; ++testcase)
<a name="l00222"></a>00222          {
<a name="l00223"></a>00223             BOOST_REQUIRE(!kvds.end());
<a name="l00224"></a>00224 
<a name="l00225"></a>00225             <span class="keywordflow">switch</span>(testcase)
<a name="l00226"></a>00226             {
<a name="l00227"></a>00227             <span class="keywordflow">case</span> 0: <span class="comment">// Key too small, this should NOT progress the iterator</span>
<a name="l00228"></a>00228                {
<a name="l00229"></a>00229                   key_size = 0;
<a name="l00230"></a>00230                   BOOST_REQUIRE(!kvds.end());
<a name="l00231"></a>00231                   BOOST_REQUIRE(!kvds.nxt(&amp;key, key_size));
<a name="l00232"></a>00232                   BOOST_REQUIRE(<span class="keyword">sizeof</span>(key) == key_size);
<a name="l00233"></a>00233                }
<a name="l00234"></a>00234                <span class="keywordflow">break</span>;
<a name="l00235"></a>00235             <span class="keywordflow">case</span> 1: <span class="comment">// This should work and progress the iterator</span>
<a name="l00236"></a>00236                {
<a name="l00237"></a>00237                   <span class="comment">// This should work and progress the iterator</span>
<a name="l00238"></a>00238                   key_size = <span class="keyword">sizeof</span>(key);
<a name="l00239"></a>00239                   BOOST_REQUIRE(!kvds.end());
<a name="l00240"></a>00240                   BOOST_REQUIRE(kvds.nxt(&amp;key, key_size));
<a name="l00241"></a>00241                   BOOST_REQUIRE(<span class="keyword">sizeof</span>(key) == key_size);
<a name="l00242"></a>00242                   BOOST_REQUIRE(keySet.find(key) != keySet.end());
<a name="l00243"></a>00243 
<a name="l00244"></a>00244                   <span class="comment">// Found it now remove it, we shouldn&#39;t see it again</span>
<a name="l00245"></a>00245                   keySet.erase(key);
<a name="l00246"></a>00246                }
<a name="l00247"></a>00247                <span class="keywordflow">break</span>;
<a name="l00248"></a>00248             <span class="keywordflow">default</span>:
<a name="l00249"></a>00249                <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;Unknown test case for test_beg_nxt_end()&quot;</span>);
<a name="l00250"></a>00250             }
<a name="l00251"></a>00251          }
<a name="l00252"></a>00252       }
<a name="l00253"></a>00253 
<a name="l00254"></a>00254       <span class="comment">// We should now be at the end of the iteration</span>
<a name="l00255"></a>00255       <span class="comment">// Not called beg() yet so this should signal end!</span>
<a name="l00256"></a>00256       BOOST_REQUIRE(kvds.end());
<a name="l00257"></a>00257       BOOST_REQUIRE(!kvds.nxt(&amp;key, key_size));
<a name="l00258"></a>00258       BOOST_REQUIRE(0 == key_size);
<a name="l00259"></a>00259 
<a name="l00260"></a>00260       <span class="comment">// We populated out keySet with all the keys we expected</span>
<a name="l00261"></a>00261       <span class="comment">// to see if there are any left something when wrong</span>
<a name="l00262"></a>00262       BOOST_REQUIRE(keySet.empty());
<a name="l00263"></a>00263    }
<a name="l00264"></a>00264 
<a name="l00265"></a><a class="code" href="class_i_kvds_tester.html#a88b8b32463f3d763a0ef23337b71d88d">00265</a>    <span class="keywordtype">void</span> test_get_all(<a class="code" href="class_i_kvds_tester.html#a938a5919404db250822fab42834ad5d0">kvds_type</a> &amp; kvds)
<a name="l00266"></a>00266    {
<a name="l00267"></a>00267       <span class="keywordflow">for</span>(uint32_t key = 1 ; key != 0 ; key &lt;&lt;= 1)
<a name="l00268"></a>00268       {
<a name="l00269"></a>00269          <span class="keywordflow">for</span>(<span class="keywordtype">int</span> testcase = 0 ; testcase &lt; 4 ; ++testcase)
<a name="l00270"></a>00270          {
<a name="l00271"></a>00271             uint32_t val_all[2] = { 0 };
<a name="l00272"></a>00272             <span class="keywordtype">size_t</span> val_all_size = <span class="keyword">sizeof</span>(val_all);
<a name="l00273"></a>00273 
<a name="l00274"></a>00274             <span class="keywordflow">switch</span>(testcase)
<a name="l00275"></a>00275             {
<a name="l00276"></a>00276             <span class="keywordflow">case</span> 0 : <span class="comment">// key not found</span>
<a name="l00277"></a>00277                {
<a name="l00278"></a>00278                   uint32_t badkey = ~key;
<a name="l00279"></a>00279                   BOOST_REQUIRE(!kvds.all(&amp;badkey, <span class="keyword">sizeof</span>(badkey), &amp;val_all, val_all_size));
<a name="l00280"></a>00280                   BOOST_REQUIRE(0 == val_all_size);
<a name="l00281"></a>00281                }
<a name="l00282"></a>00282                <span class="keywordflow">break</span>;
<a name="l00283"></a>00283             <span class="keywordflow">case</span> 1 : <span class="comment">// key found but value too small</span>
<a name="l00284"></a>00284                {
<a name="l00285"></a>00285                   uint32_t bad_val_all[1] = { 0 };
<a name="l00286"></a>00286                   val_all_size = <span class="keyword">sizeof</span>(bad_val_all);
<a name="l00287"></a>00287                   BOOST_REQUIRE(!kvds.all(&amp;key, <span class="keyword">sizeof</span>(key), &amp;bad_val_all, val_all_size));
<a name="l00288"></a>00288                   BOOST_REQUIRE(<span class="keyword">sizeof</span>(val_all) == val_all_size);
<a name="l00289"></a>00289                }
<a name="l00290"></a>00290                <span class="keywordflow">break</span>;
<a name="l00291"></a>00291             <span class="keywordflow">case</span> 2 : <span class="comment">// key found and value correct size</span>
<a name="l00292"></a>00292                {
<a name="l00293"></a>00293                   BOOST_REQUIRE(kvds.all(&amp;key, <span class="keyword">sizeof</span>(key), &amp;val_all, val_all_size));
<a name="l00294"></a>00294                   BOOST_REQUIRE(<span class="keyword">sizeof</span>(val_all) == val_all_size);
<a name="l00295"></a>00295                   BOOST_REQUIRE((key ^ val0_mask) == val_all[0]);
<a name="l00296"></a>00296                   BOOST_REQUIRE((key ^ val1_mask) == val_all[1]);
<a name="l00297"></a>00297                }
<a name="l00298"></a>00298                <span class="keywordflow">break</span>;
<a name="l00299"></a>00299             <span class="keywordflow">case</span> 3 : <span class="comment">// key found but value larger than required</span>
<a name="l00300"></a>00300                {
<a name="l00301"></a>00301                   uint32_t good_val_all[3] = { 0 };
<a name="l00302"></a>00302                   val_all_size = <span class="keyword">sizeof</span>(good_val_all);
<a name="l00303"></a>00303                   BOOST_REQUIRE(kvds.all(&amp;key, <span class="keyword">sizeof</span>(key), &amp;good_val_all, val_all_size));
<a name="l00304"></a>00304                   BOOST_REQUIRE(<span class="keyword">sizeof</span>(val_all) == val_all_size);
<a name="l00305"></a>00305                   BOOST_REQUIRE((key ^ val0_mask) == good_val_all[0]);
<a name="l00306"></a>00306                   BOOST_REQUIRE((key ^ val1_mask) == good_val_all[1]);
<a name="l00307"></a>00307                }
<a name="l00308"></a>00308                <span class="keywordflow">break</span>;
<a name="l00309"></a>00309             <span class="keywordflow">default</span>:
<a name="l00310"></a>00310                <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;Unknown test case for test_get_all()&quot;</span>);
<a name="l00311"></a>00311             }
<a name="l00312"></a>00312          }
<a name="l00313"></a>00313       }
<a name="l00314"></a>00314    }
<a name="l00315"></a>00315 
<a name="l00316"></a><a class="code" href="class_i_kvds_tester.html#a56a502cc075acbd868f928ea806640f4">00316</a>    <span class="keywordtype">void</span> test_xst_del(<a class="code" href="class_i_kvds_tester.html#a938a5919404db250822fab42834ad5d0">kvds_type</a> &amp; kvds)
<a name="l00317"></a>00317    {
<a name="l00318"></a>00318       <span class="keywordflow">for</span>(uint32_t key = 1 ; key != 0 ; key &lt;&lt;= 1)
<a name="l00319"></a>00319       {
<a name="l00320"></a>00320          BOOST_REQUIRE(kvds.xst(&amp;key, <span class="keyword">sizeof</span>(key)));
<a name="l00321"></a>00321          BOOST_REQUIRE(kvds.del(&amp;key, <span class="keyword">sizeof</span>(key)));
<a name="l00322"></a>00322          BOOST_REQUIRE(!kvds.xst(&amp;key, <span class="keyword">sizeof</span>(key)));
<a name="l00323"></a>00323       }
<a name="l00324"></a>00324    }
<a name="l00325"></a>00325 
<a name="l00326"></a><a class="code" href="class_i_kvds_tester.html#abaec0afe113b991b4807e8a81e5e53d1">00326</a>    <span class="keywordtype">void</span> test_nil(<a class="code" href="class_i_kvds_tester.html#a938a5919404db250822fab42834ad5d0">kvds_type</a> &amp; kvds, <span class="keywordtype">bool</span> <span class="keyword">const</span> nil = <span class="keyword">true</span>)
<a name="l00327"></a>00327    {
<a name="l00328"></a>00328       <span class="keywordtype">bool</span> isnil = <span class="keyword">false</span>;
<a name="l00329"></a>00329       BOOST_REQUIRE(kvds.nil(isnil));
<a name="l00330"></a>00330       BOOST_REQUIRE(isnil == nil);
<a name="l00331"></a>00331    }
<a name="l00332"></a>00332 
<a name="l00333"></a><a class="code" href="class_i_kvds_tester.html#a6c8f93b389ff39340c29f449eb20a3dc">00333</a>    <span class="keywordtype">void</span> test_clr_nil(<a class="code" href="class_i_kvds_tester.html#a938a5919404db250822fab42834ad5d0">kvds_type</a> &amp; kvds)
<a name="l00334"></a>00334    {
<a name="l00335"></a>00335       BOOST_REQUIRE(kvds.clr());
<a name="l00336"></a>00336 
<a name="l00337"></a>00337       <span class="keywordtype">bool</span> isnil = <span class="keyword">false</span>;
<a name="l00338"></a>00338       BOOST_REQUIRE(kvds.nil(isnil));
<a name="l00339"></a>00339       BOOST_REQUIRE(isnil);
<a name="l00340"></a>00340    }
<a name="l00341"></a>00341 
<a name="l00342"></a><a class="code" href="class_i_kvds_tester.html#a528a5899cac827683c433e68b1eab03d">00342</a>    <span class="keywordtype">void</span> test_put_add_get(<a class="code" href="class_i_kvds_tester.html#a938a5919404db250822fab42834ad5d0">kvds_type</a> &amp; kvds)
<a name="l00343"></a>00343    {
<a name="l00344"></a>00344       uint32_t key = {0xF0F0F0F0};
<a name="l00345"></a>00345       uint32_t put_vals[] = {0x29292929, 0xABABABAB};
<a name="l00346"></a>00346 
<a name="l00347"></a>00347       BOOST_REQUIRE(kvds.put(&amp;key, <span class="keyword">sizeof</span>(key), &amp;put_vals[0], <span class="keyword">sizeof</span>(put_vals[0])));
<a name="l00348"></a>00348 
<a name="l00349"></a>00349       uint32_t get_val = 0;
<a name="l00350"></a>00350       <span class="keywordtype">size_t</span> get_val_size = <span class="keyword">sizeof</span>(get_val);
<a name="l00351"></a>00351 
<a name="l00352"></a>00352       BOOST_REQUIRE(kvds.get(&amp;key, <span class="keyword">sizeof</span>(key), &amp;get_val, get_val_size));
<a name="l00353"></a>00353       BOOST_REQUIRE(<span class="keyword">sizeof</span>(get_val) == get_val_size);
<a name="l00354"></a>00354       BOOST_REQUIRE(get_val == put_vals[0]);
<a name="l00355"></a>00355 
<a name="l00356"></a>00356       BOOST_REQUIRE(kvds.add(&amp;key, <span class="keyword">sizeof</span>(key), &amp;put_vals[1], <span class="keyword">sizeof</span>(put_vals[2])));
<a name="l00357"></a>00357 
<a name="l00358"></a>00358       uint32_t all_vals[2] = { 0 };
<a name="l00359"></a>00359       <span class="keywordtype">size_t</span> all_val_size = <span class="keyword">sizeof</span>(all_vals);
<a name="l00360"></a>00360 
<a name="l00361"></a>00361       BOOST_REQUIRE(kvds.all(&amp;key, <span class="keyword">sizeof</span>(key), all_vals, all_val_size));
<a name="l00362"></a>00362       BOOST_REQUIRE(<span class="keyword">sizeof</span>(all_vals) == all_val_size);
<a name="l00363"></a>00363       BOOST_REQUIRE(all_vals[0] == put_vals[0]);
<a name="l00364"></a>00364       BOOST_REQUIRE(all_vals[1] == put_vals[1]);
<a name="l00365"></a>00365    }
<a name="l00366"></a>00366 
<a name="l00367"></a>00367 <span class="keyword">public</span>:
<a name="l00368"></a>00368 
<a name="l00369"></a><a class="code" href="class_i_kvds_tester.html#a1eaecf6aa073d283c5b0d506f1109e77">00369</a>    <span class="keywordtype">void</span> operator()(<a class="code" href="class_i_kvds_tester.html#a938a5919404db250822fab42834ad5d0">kvds_type</a> &amp; kvds)
<a name="l00370"></a>00370    {
<a name="l00371"></a>00371       <span class="comment">// Since tests are dependent on each other to build up the</span>
<a name="l00372"></a>00372       <span class="comment">// datastore if any test fails we fail them all.</span>
<a name="l00373"></a>00373       <span class="comment">// All tests MUST be run in the order presented!</span>
<a name="l00374"></a>00374 
<a name="l00375"></a>00375       test_nil(kvds);
<a name="l00376"></a>00376       test_siz(kvds, 0, <span class="keyword">false</span>);
<a name="l00377"></a>00377       test_put_add_get(kvds);
<a name="l00378"></a>00378       test_clr_nil(kvds);
<a name="l00379"></a>00379       test_get_noexist(kvds);
<a name="l00380"></a>00380       test_add_cnt_get(kvds);
<a name="l00381"></a>00381       test_nil(kvds, <span class="keyword">false</span>);
<a name="l00382"></a>00382       test_put_cnt_get(kvds, <span class="keyword">false</span>);
<a name="l00383"></a>00383       test_nil(kvds, <span class="keyword">false</span>);
<a name="l00384"></a>00384       test_clr_nil(kvds);
<a name="l00385"></a>00385       test_put_cnt_get(kvds);
<a name="l00386"></a>00386       test_nil(kvds, <span class="keyword">false</span>);
<a name="l00387"></a>00387       test_siz(kvds, 1);
<a name="l00388"></a>00388       test_add_all(kvds);
<a name="l00389"></a>00389       test_nil(kvds, <span class="keyword">false</span>);
<a name="l00390"></a>00390       test_siz(kvds, 2);
<a name="l00391"></a>00391       test_get_all(kvds);
<a name="l00392"></a>00392       test_beg_nxt_end(kvds);
<a name="l00393"></a>00393       test_xst_del(kvds);
<a name="l00394"></a>00394    }
<a name="l00395"></a>00395 };
<a name="l00396"></a>00396 
<a name="l00397"></a>00397 
<a name="l00398"></a><a class="code" href="ikvds_8cpp.html#adf22ed3b8988a8092e1bd6a7d078c479">00398</a> <a class="code" href="configurable_8cpp.html#a4999d8ccf2e242974a3ff975a9d4647c">BOOST_FIXTURE_TEST_CASE</a>( test_kvds_bbt, <a class="code" href="struct_fixture.html">Fixture</a> )
<a name="l00399"></a>00399 {
<a name="l00400"></a>00400    <a class="code" href="classmoost_1_1kvds_1_1_kvds_bdb.html" title="*** This class is NOT thread safe ***">KvdsBbt</a> kvds;
<a name="l00401"></a>00401    kvds.<a class="code" href="classmoost_1_1kvds_1_1_kvds_bdb.html#a466f4d4170d7ae2781ab8cd01c608d28">open</a>(tdc.GetFilePath(<span class="stringliteral">&quot;KvdsBbt&quot;</span>).c_str());
<a name="l00402"></a>00402    <a class="code" href="class_i_kvds_tester.html">IKvdsTester</a>()(kvds);
<a name="l00403"></a>00403 }
<a name="l00404"></a>00404 
<a name="l00405"></a><a class="code" href="ikvds_8cpp.html#ac8ab1e4f55b65531b412e6a47d2a9235">00405</a> <a class="code" href="configurable_8cpp.html#a4999d8ccf2e242974a3ff975a9d4647c">BOOST_FIXTURE_TEST_CASE</a>( test_kvds_bht, <a class="code" href="struct_fixture.html">Fixture</a> )
<a name="l00406"></a>00406 {
<a name="l00407"></a>00407    <a class="code" href="classmoost_1_1kvds_1_1_kvds_bdb.html" title="*** This class is NOT thread safe ***">KvdsBht</a> kvds;
<a name="l00408"></a>00408    kvds.<a class="code" href="classmoost_1_1kvds_1_1_kvds_bdb.html#a466f4d4170d7ae2781ab8cd01c608d28">open</a>(tdc.GetFilePath(<span class="stringliteral">&quot;KvdsBht&quot;</span>).c_str());
<a name="l00409"></a>00409    <a class="code" href="class_i_kvds_tester.html">IKvdsTester</a>()(kvds);
<a name="l00410"></a>00410 }
<a name="l00411"></a>00411 
<a name="l00412"></a><a class="code" href="ikvds_8cpp.html#afbc25d7d69aeaf4b4e868e977e9b246a">00412</a> <a class="code" href="configurable_8cpp.html#a4999d8ccf2e242974a3ff975a9d4647c">BOOST_FIXTURE_TEST_CASE</a>( test_kvds_page_store_intrinsic_pagemap, <a class="code" href="struct_fixture.html">Fixture</a> )
<a name="l00413"></a>00413 {
<a name="l00414"></a>00414    <a class="code" href="classmoost_1_1kvds_1_1_kvds_page_store.html" title="*** This class is NOT thread safe ***">KvdsPageStore&lt;KvdsPageMapIntrinsicKey&lt;uint32_t&gt;</a> &gt; kvds;
<a name="l00415"></a>00415    kvds.<a class="code" href="classmoost_1_1kvds_1_1_kvds_page_store.html#a817d96614cac576f5e9a21e7fd1269b5">open</a>(tdc.GetFilePath(<span class="stringliteral">&quot;KvdsPageStore&quot;</span>).c_str());
<a name="l00416"></a>00416    <a class="code" href="class_i_kvds_tester.html">IKvdsTester</a>()(kvds);
<a name="l00417"></a>00417 }
<a name="l00418"></a>00418 
<a name="l00419"></a><a class="code" href="ikvds_8cpp.html#a51664020389f1199c34c9eebbee0924c">00419</a> <a class="code" href="configurable_8cpp.html#a4999d8ccf2e242974a3ff975a9d4647c">BOOST_FIXTURE_TEST_CASE</a>( test_kvds_page_store_nonintrinsic_pagemap, <a class="code" href="struct_fixture.html">Fixture</a> )
<a name="l00420"></a>00420 {
<a name="l00421"></a>00421    <a class="code" href="classmoost_1_1kvds_1_1_kvds_page_store.html" title="*** This class is NOT thread safe ***">KvdsPageStore&lt;KvdsPageMapNonIntrinsicKey&lt;&gt;</a> &gt; kvds;
<a name="l00422"></a>00422    kvds.<a class="code" href="classmoost_1_1kvds_1_1_kvds_page_store.html#a817d96614cac576f5e9a21e7fd1269b5">open</a>(tdc.GetFilePath(<span class="stringliteral">&quot;KvdsPageStore&quot;</span>).c_str());
<a name="l00423"></a>00423    <a class="code" href="class_i_kvds_tester.html">IKvdsTester</a>()(kvds);
<a name="l00424"></a>00424 }
<a name="l00425"></a>00425 
<a name="l00426"></a><a class="code" href="ikvds_8cpp.html#ae29a5402d4be0b019e18dd0a3da41b4a">00426</a> <a class="code" href="configurable_8cpp.html#a4999d8ccf2e242974a3ff975a9d4647c">BOOST_FIXTURE_TEST_CASE</a>( test_kvds_page_store_intrinsic_shared_pagemap, <a class="code" href="struct_fixture.html">Fixture</a> )
<a name="l00427"></a>00427 {
<a name="l00428"></a>00428    <a class="code" href="classmoost_1_1kvds_1_1_kvds_page_store.html" title="*** This class is NOT thread safe ***">KvdsPageStore&lt;KvdsPageMapShared&lt;KvdsPageMapIntrinsicKey&lt;uint32_t&gt;</a> &gt; &gt;kvds;
<a name="l00429"></a>00429    kvds.<a class="code" href="classmoost_1_1kvds_1_1_kvds_page_store.html#a817d96614cac576f5e9a21e7fd1269b5">open</a>(tdc.GetFilePath(<span class="stringliteral">&quot;KvdsPageStore&quot;</span>).c_str());
<a name="l00430"></a>00430    <a class="code" href="class_i_kvds_tester.html">IKvdsTester</a>()(kvds);
<a name="l00431"></a>00431 }
<a name="l00432"></a>00432 
<a name="l00433"></a><a class="code" href="ikvds_8cpp.html#aaf858c261e0ced7a3382978f11de2b15">00433</a> <a class="code" href="configurable_8cpp.html#a4999d8ccf2e242974a3ff975a9d4647c">BOOST_FIXTURE_TEST_CASE</a>( test_kvds_page_store_nonintrinsic_shared_pagemap, <a class="code" href="struct_fixture.html">Fixture</a> )
<a name="l00434"></a>00434 {
<a name="l00435"></a>00435    <a class="code" href="classmoost_1_1kvds_1_1_kvds_page_store.html" title="*** This class is NOT thread safe ***">KvdsPageStore&lt;KvdsPageMapShared &lt;KvdsPageMapNonIntrinsicKey&lt;&gt;</a> &gt; &gt;kvds;
<a name="l00436"></a>00436    kvds.<a class="code" href="classmoost_1_1kvds_1_1_kvds_page_store.html#a817d96614cac576f5e9a21e7fd1269b5">open</a>(tdc.GetFilePath(<span class="stringliteral">&quot;KvdsPageStore&quot;</span>).c_str());
<a name="l00437"></a>00437    <a class="code" href="class_i_kvds_tester.html">IKvdsTester</a>()(kvds);
<a name="l00438"></a>00438 }
<a name="l00439"></a>00439 
<a name="l00440"></a><a class="code" href="ikvds_8cpp.html#a3bf06c9786f1956f16f7cf22e8c1aa04">00440</a> <a class="code" href="configurable_8cpp.html#a4999d8ccf2e242974a3ff975a9d4647c">BOOST_FIXTURE_TEST_CASE</a>( test_kvds_tch, <a class="code" href="struct_fixture.html">Fixture</a> )
<a name="l00441"></a>00441 {
<a name="l00442"></a>00442    <a class="code" href="classmoost_1_1kvds_1_1_kvds_tch.html" title="*** This class is NOT thread safe ***">KvdsTch</a> kvds;
<a name="l00443"></a>00443    kvds.<a class="code" href="classmoost_1_1kvds_1_1_kvds_tch.html#a2808703defca03263095c4b3ba3892a5">open</a>(tdc.GetFilePath(<span class="stringliteral">&quot;KvdsTch&quot;</span>).c_str());
<a name="l00444"></a>00444    <a class="code" href="class_i_kvds_tester.html">IKvdsTester</a>()(kvds);
<a name="l00445"></a>00445 }
<a name="l00446"></a>00446 
<a name="l00447"></a><a class="code" href="ikvds_8cpp.html#a5ae01dc01c46db6084bff773d2d2a9b0">00447</a> <a class="code" href="configurable_8cpp.html#a4999d8ccf2e242974a3ff975a9d4647c">BOOST_FIXTURE_TEST_CASE</a>( test_kvds_kch, <a class="code" href="struct_fixture.html">Fixture</a> )
<a name="l00448"></a>00448 {
<a name="l00449"></a>00449    <a class="code" href="classmoost_1_1kvds_1_1_kvds_kch.html">KvdsKch</a> kvds;
<a name="l00450"></a>00450    kvds.<a class="code" href="classmoost_1_1kvds_1_1_kvds_kch.html#a183880b4feb9a6011e1ee942ecaff419">open</a>(tdc.GetFilePath(<span class="stringliteral">&quot;KvdsKch&quot;</span>).c_str());
<a name="l00451"></a>00451    <a class="code" href="class_i_kvds_tester.html">IKvdsTester</a>()(kvds);
<a name="l00452"></a>00452 }
<a name="l00453"></a>00453 
<a name="l00454"></a><a class="code" href="ikvds_8cpp.html#aa66a003bcd96859213de8a6905402b82">00454</a> <a class="code" href="configurable_8cpp.html#a4999d8ccf2e242974a3ff975a9d4647c">BOOST_FIXTURE_TEST_CASE</a>( test_kvds_mem_map, <a class="code" href="struct_fixture.html">Fixture</a> )
<a name="l00455"></a>00455 {
<a name="l00456"></a>00456    <a class="code" href="classmoost_1_1kvds_1_1_kvds_mem.html" title="*** This class is NOT thread safe ***">KvdsMemMap</a> kvds;
<a name="l00457"></a>00457    <span class="comment">// This test doesn&#39;t need opening :)</span>
<a name="l00458"></a>00458    <a class="code" href="class_i_kvds_tester.html">IKvdsTester</a>()(kvds);
<a name="l00459"></a>00459 }
<a name="l00460"></a>00460 
<a name="l00461"></a>00461 <span class="comment">// Define end of test suite</span>
<a name="l00462"></a>00462 BOOST_AUTO_TEST_SUITE_END()
</pre></div></div><!-- contents -->
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="ikvds_8cpp.html">ikvds.cpp</a>      </li>

    <li class="footer">Generated on Wed Feb 20 2013 05:56:08 for libmoost by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
