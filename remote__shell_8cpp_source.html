<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>libmoost: /home/mhx/git/github/libmoost/src/service/remote_shell.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>


</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">libmoost
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('remote__shell_8cpp.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">/home/mhx/git/github/libmoost/src/service/remote_shell.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="remote__shell_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* vim:set ts=3 sw=3 sts=3 et: */</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;cstdio&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;set&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;queue&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;string&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;stdexcept&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;boost/asio.hpp&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;boost/bind.hpp&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;boost/enable_shared_from_this.hpp&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;boost/noncopyable.hpp&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;boost/foreach.hpp&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;boost/algorithm/string/trim.hpp&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;boost/thread.hpp&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;boost/date_time/posix_time/posix_time.hpp&gt;</span>
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;../../include/moost/terminal_format.hpp&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;../../include/moost/utils/foreach.hpp&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;../../include/moost/io/helper.hpp&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;../../include/moost/io/async_stream_forwarder.hpp&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;../../include/moost/service/remote_shell.h&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;../../include/moost/service/posix_stream_stealer.h&quot;</span>
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="preprocessor">#if defined(_POSIX_SOURCE) || defined(__CYGWIN__)</span>
<a name="l00050"></a>00050 <span class="preprocessor"></span><span class="comment">// needed for ::dup(), ::write(), ::fileno()</span>
<a name="l00051"></a>00051 <span class="preprocessor"># include &lt;unistd.h&gt;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#elif defined(_WIN32)</span>
<a name="l00053"></a>00053 <span class="preprocessor"></span><span class="preprocessor"># include &lt;windows.h&gt;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#else</span>
<a name="l00055"></a>00055 <span class="preprocessor"></span><span class="preprocessor"># error &quot;apparently no local shell support has been added for this platform&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00057"></a>00057 <span class="preprocessor"></span>
<a name="l00058"></a>00058 <span class="comment">/*</span>
<a name="l00059"></a>00059 <span class="comment"> *  TODO: cleanup stdstream/dup/fileno/read/write/pipe stuff</span>
<a name="l00060"></a>00060 <span class="comment"> */</span>
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 <span class="keyword">using</span> boost::asio::ip::tcp;
<a name="l00063"></a>00063 <span class="keyword">using namespace </span>boost;
<a name="l00064"></a>00064 <span class="keyword">using namespace </span>moost;
<a name="l00065"></a>00065 <span class="keyword">using namespace </span>moost::service;
<a name="l00066"></a>00066 
<a name="l00067"></a><a class="code" href="remote__shell_8cpp.html#a629b1eda6a29b9b070c429c5bbac0c86">00067</a> <span class="keyword">class </span><a class="code" href="classsession__base.html">session_base</a>;
<a name="l00068"></a>00068 <span class="keyword">typedef</span> shared_ptr&lt;session_base&gt; <a class="code" href="remote__shell_8cpp.html#a629b1eda6a29b9b070c429c5bbac0c86">session_ptr</a>;
<a name="l00069"></a><a class="code" href="remote__shell_8cpp.html#a0d8e8ed0b23aa3d6d1c5fd1cf02b6af3">00069</a> <span class="keyword">typedef</span> shared_ptr&lt;tcp::socket&gt; <a class="code" href="remote__shell_8cpp.html#a0d8e8ed0b23aa3d6d1c5fd1cf02b6af3">socket_ptr</a>;
<a name="l00070"></a><a class="code" href="remote__shell_8cpp.html#aa3d46611a84a915d852c8990e0c58250">00070</a> <span class="keyword">typedef</span> void (<a class="code" href="classsession__base.html">session_base</a>::*<a class="code" href="remote__shell_8cpp.html#aa3d46611a84a915d852c8990e0c58250">session_meth</a>)(<span class="keyword">const</span> <span class="keywordtype">char</span> *buffer, <span class="keywordtype">size_t</span> count);
<a name="l00071"></a>00071 
<a name="l00072"></a>00072 <span class="keyword">namespace </span>moost { <span class="keyword">namespace </span>service {
<a name="l00073"></a>00073 
<a name="l00074"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html">00074</a> <span class="keyword">class </span><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html">remote_shell_server_impl</a> : <span class="keyword">public</span> <a class="code" href="classboost_1_1noncopyable.html">noncopyable</a>
<a name="l00075"></a>00075 {
<a name="l00076"></a>00076 <span class="keyword">private</span>:
<a name="l00077"></a><a class="code" href="structmoost_1_1service_1_1remote__shell__server__impl_1_1noop__pre__shutdown__func.html">00077</a>    <span class="keyword">struct </span><a class="code" href="structmoost_1_1service_1_1remote__shell__server__impl_1_1noop__pre__shutdown__func.html">noop_pre_shutdown_func</a>
<a name="l00078"></a>00078    {
<a name="l00079"></a><a class="code" href="structmoost_1_1service_1_1remote__shell__server__impl_1_1noop__pre__shutdown__func.html#aa82e28768995a134017fd29fd9af33c0">00079</a>       <span class="keywordtype">void</span> operator()()
<a name="l00080"></a>00080       {
<a name="l00081"></a>00081       }
<a name="l00082"></a>00082    };
<a name="l00083"></a>00083 
<a name="l00084"></a><a class="code" href="structmoost_1_1service_1_1remote__shell__server__impl_1_1command.html">00084</a>    <span class="keyword">struct </span><a class="code" href="structmoost_1_1service_1_1remote__shell__server__impl_1_1command.html">command</a>
<a name="l00085"></a>00085    {
<a name="l00086"></a><a class="code" href="structmoost_1_1service_1_1remote__shell__server__impl_1_1command.html#a1305545373513f7c8aaa7440d932f3ba">00086</a>       <a class="code" href="remote__shell_8cpp.html#a629b1eda6a29b9b070c429c5bbac0c86">session_ptr</a> <a class="code" href="structmoost_1_1service_1_1remote__shell__server__impl_1_1command.html#a1305545373513f7c8aaa7440d932f3ba">session</a>;
<a name="l00087"></a><a class="code" href="structmoost_1_1service_1_1remote__shell__server__impl_1_1command.html#a3b674d0656ca42ff958c7cc6122d4ff6">00087</a>       std::string <a class="code" href="structmoost_1_1service_1_1remote__shell__server__impl_1_1command.html#a3b674d0656ca42ff958c7cc6122d4ff6">cmd</a>;
<a name="l00088"></a><a class="code" href="structmoost_1_1service_1_1remote__shell__server__impl_1_1command.html#a3337133376c554a4007db0e89833c326">00088</a>       std::string <a class="code" href="structmoost_1_1service_1_1remote__shell__server__impl_1_1command.html#a3337133376c554a4007db0e89833c326">args</a>;
<a name="l00089"></a>00089 
<a name="l00090"></a><a class="code" href="structmoost_1_1service_1_1remote__shell__server__impl_1_1command.html#a80cd1ab82f946db2edf4de2242fa184f">00090</a>       <a class="code" href="structmoost_1_1service_1_1remote__shell__server__impl_1_1command.html">command</a>()
<a name="l00091"></a>00091       {}
<a name="l00092"></a>00092 
<a name="l00093"></a><a class="code" href="structmoost_1_1service_1_1remote__shell__server__impl_1_1command.html#a6c0501e29f6c0ca8856a39c0b1f2c617">00093</a>       <a class="code" href="structmoost_1_1service_1_1remote__shell__server__impl_1_1command.html">command</a>(<span class="keyword">const</span> <a class="code" href="remote__shell_8cpp.html#a629b1eda6a29b9b070c429c5bbac0c86">session_ptr</a>&amp; s, <span class="keyword">const</span> std::string&amp; c, <span class="keyword">const</span> std::string&amp; a)
<a name="l00094"></a>00094          : <a class="code" href="classsession.html">session</a>(s), cmd(c), args(a)
<a name="l00095"></a>00095       {}
<a name="l00096"></a>00096    };
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 <span class="preprocessor">#ifdef BOOST_ASIO_HAS_POSIX_STREAM_DESCRIPTOR</span>
<a name="l00099"></a>00099 <span class="preprocessor"></span>   <span class="keyword">typedef</span> asio::posix::basic_stream_descriptor&lt;&gt; stdstream;
<a name="l00100"></a>00100 <span class="preprocessor">#endif</span>
<a name="l00101"></a>00101 <span class="preprocessor"></span>
<a name="l00102"></a>00102    <span class="keywordtype">void</span> handle_accept(<a class="code" href="remote__shell_8cpp.html#a0d8e8ed0b23aa3d6d1c5fd1cf02b6af3">socket_ptr</a> socket, <a class="code" href="classmoost_1_1service_1_1remote__shell__iface.html" title="Interface for remote command shell.">remote_shell_iface</a> *rsi, <span class="keyword">const</span> system::error_code&amp; error);
<a name="l00103"></a>00103    <span class="keywordtype">void</span> handle_stop(<span class="keyword">const</span> std::string&amp; msg);
<a name="l00104"></a>00104    <span class="keywordtype">void</span> accept_session(<a class="code" href="classmoost_1_1service_1_1remote__shell__iface.html" title="Interface for remote command shell.">remote_shell_iface</a> *rsi);
<a name="l00105"></a>00105    <span class="keywordtype">void</span> pre_shutdown();
<a name="l00106"></a>00106 
<a name="l00107"></a>00107 <span class="preprocessor">#ifdef BOOST_ASIO_HAS_POSIX_STREAM_DESCRIPTOR</span>
<a name="l00108"></a>00108 <span class="preprocessor"></span>   <span class="keywordtype">bool</span> snoop_stdio(<a class="code" href="classmoost_1_1service_1_1posix__stream__stealer.html">posix_stream_stealer</a>&amp; stealer, FILE *stream, stdstream *bsd, <a class="code" href="remote__shell_8cpp.html#aa3d46611a84a915d852c8990e0c58250">session_meth</a> cb);
<a name="l00109"></a>00109    <span class="keywordtype">void</span> on_stdio_read(stdstream *bsd, <a class="code" href="remote__shell_8cpp.html#aa3d46611a84a915d852c8990e0c58250">session_meth</a> cb, <span class="keyword">const</span> system::error_code&amp; error, <span class="keywordtype">char</span> *buffer, <span class="keywordtype">size_t</span> count);
<a name="l00110"></a>00110    <span class="keywordtype">void</span> stdio_read_more(stdstream *bsd, <a class="code" href="remote__shell_8cpp.html#aa3d46611a84a915d852c8990e0c58250">session_meth</a> cb, <span class="keywordtype">char</span> *buffer);
<a name="l00111"></a>00111 <span class="preprocessor">#endif</span>
<a name="l00112"></a>00112 <span class="preprocessor"></span>
<a name="l00113"></a>00113    <span class="keywordtype">bool</span> setup_stdio_snoopers();
<a name="l00114"></a>00114    <span class="keywordtype">void</span> teardown_stdio_snoopers();
<a name="l00115"></a>00115 
<a name="l00116"></a>00116    <span class="keywordtype">bool</span> create_console_session(<a class="code" href="classmoost_1_1service_1_1remote__shell__iface.html" title="Interface for remote command shell.">remote_shell_iface</a> *rsi, <a class="code" href="remote__shell_8cpp.html#a629b1eda6a29b9b070c429c5bbac0c86">session_ptr</a>&amp; new_session, <a class="code" href="namespacemoost_1_1service.html#ad882f294c163791c4fb5dd2955e2d451">stream_writer_ptr</a>&amp; writer);
<a name="l00117"></a>00117    <span class="keywordtype">bool</span> setup_console_session(<a class="code" href="classmoost_1_1service_1_1remote__shell__iface.html" title="Interface for remote command shell.">remote_shell_iface</a> *rsi);
<a name="l00118"></a>00118 
<a name="l00119"></a>00119    <span class="keywordtype">void</span> command_thread(<a class="code" href="classmoost_1_1service_1_1remote__shell__iface.html" title="Interface for remote command shell.">remote_shell_iface</a> *rsi);
<a name="l00120"></a>00120 
<a name="l00121"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a7a517e1e3a821c32a7159480fd26716c">00121</a>    shared_ptr&lt;asio::io_service&gt; <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a7a517e1e3a821c32a7159480fd26716c">m_ios</a>;
<a name="l00122"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#acdd09ca96cbdac61b7a7baef82395a02">00122</a>    shared_ptr&lt;tcp::acceptor&gt; <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#acdd09ca96cbdac61b7a7baef82395a02">m_acceptor</a>;
<a name="l00123"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#af9b9b3d8e5b01da581c8efb60bfc7e0a">00123</a>    std::set&lt;session_ptr&gt; <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#af9b9b3d8e5b01da581c8efb60bfc7e0a">m_sessions</a>;
<a name="l00124"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a43cbd23f719d53bc9cfefafaadfad9df">00124</a>    <a class="code" href="namespacemoost_1_1service.html#a87325356c611b3fba77461f79c735d96">appender_factory_ptr</a> <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a43cbd23f719d53bc9cfefafaadfad9df">m_app_factory</a>;
<a name="l00125"></a>00125 <span class="preprocessor">#ifdef BOOST_ASIO_HAS_POSIX_STREAM_DESCRIPTOR</span>
<a name="l00126"></a>00126 <span class="preprocessor"></span>   stdstream m_stdout;
<a name="l00127"></a>00127    stdstream m_stderr;
<a name="l00128"></a>00128    <a class="code" href="classmoost_1_1service_1_1posix__stream__stealer.html">posix_stream_stealer</a> m_stdout_stealer;
<a name="l00129"></a>00129    <a class="code" href="classmoost_1_1service_1_1posix__stream__stealer.html">posix_stream_stealer</a> m_stderr_stealer;
<a name="l00130"></a>00130 <span class="preprocessor">#endif</span>
<a name="l00131"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a354a6bb58354e34785939862b5cc951f">00131</a> <span class="preprocessor"></span>   std::string <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a354a6bb58354e34785939862b5cc951f">m_welcome</a>;
<a name="l00132"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a711a4150bdef6abad44301fe1e9d1b3e">00132</a>    <span class="keywordtype">bool</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a711a4150bdef6abad44301fe1e9d1b3e">m_default_stdout_state</a>;
<a name="l00133"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#ad291c3588da210155c8ec9fa417c770c">00133</a>    <span class="keywordtype">bool</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#ad291c3588da210155c8ec9fa417c770c">m_default_stderr_state</a>;
<a name="l00134"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#ab398fd0ba89723927bc967d450f126ab">00134</a>    <span class="keywordtype">bool</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#ab398fd0ba89723927bc967d450f126ab">m_enable_local</a>;
<a name="l00135"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#ab1f8b84d3dba6e156a1e7521324aac31">00135</a>    <span class="keywordtype">bool</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#ab1f8b84d3dba6e156a1e7521324aac31">m_can_snoop_stdio</a>;
<a name="l00136"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a17ee6df74eb1f433beda238a49389d5f">00136</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a17ee6df74eb1f433beda238a49389d5f">m_listen_port</a>;
<a name="l00137"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a54be885fe19d43024b63a629b209d7b8">00137</a>    shared_ptr&lt;thread&gt; <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a54be885fe19d43024b63a629b209d7b8">m_cmd_runner</a>;
<a name="l00138"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a67d38269de9c029e632588eddf1d2ecc">00138</a>    std::queue&lt; command &gt; <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a67d38269de9c029e632588eddf1d2ecc">m_cmd_queue</a>;
<a name="l00139"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a767febb4e9c9515407fef6c873c7222d">00139</a>    mutex <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a767febb4e9c9515407fef6c873c7222d">m_cmd_queue_mutex</a>;
<a name="l00140"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a213ef2d3a9fc3e5b22bd42525e01abdb">00140</a>    condition_variable <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a213ef2d3a9fc3e5b22bd42525e01abdb">m_cmd_queue_cond</a>;
<a name="l00141"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a31910eb1e8d87951562a44cda396f32b">00141</a>    boost::function0&lt;void&gt; <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a31910eb1e8d87951562a44cda396f32b">m_pre_shutdown_func</a>;
<a name="l00142"></a>00142 
<a name="l00143"></a>00143 <span class="keyword">public</span>:
<a name="l00144"></a>00144    <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html">remote_shell_server_impl</a>(shared_ptr&lt;asio::io_service&gt; ios);
<a name="l00145"></a>00145    ~<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html">remote_shell_server_impl</a>();
<a name="l00146"></a>00146    <span class="keywordtype">void</span> run(<a class="code" href="classmoost_1_1service_1_1remote__shell__iface.html" title="Interface for remote command shell.">remote_shell_iface</a> *rsi);
<a name="l00147"></a>00147    <span class="keywordtype">void</span> stop(<span class="keyword">const</span> std::string&amp; msg);
<a name="l00148"></a>00148    <span class="keywordtype">void</span> remove_session(<a class="code" href="remote__shell_8cpp.html#a629b1eda6a29b9b070c429c5bbac0c86">session_ptr</a> p);
<a name="l00149"></a>00149    <span class="keywordtype">void</span> set_appender_factory(<a class="code" href="namespacemoost_1_1service.html#a87325356c611b3fba77461f79c735d96">appender_factory_ptr</a> app_factory);
<a name="l00150"></a>00150    <span class="keywordtype">void</span> set_default_stdout_state(<span class="keywordtype">bool</span> enabled);
<a name="l00151"></a>00151    <span class="keywordtype">void</span> set_default_stderr_state(<span class="keywordtype">bool</span> enabled);
<a name="l00152"></a>00152    <span class="keywordtype">void</span> set_listen_port(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> port);
<a name="l00153"></a>00153    <span class="keywordtype">void</span> set_pre_shutdown_function(boost::function0&lt;void&gt;&amp; func);
<a name="l00154"></a>00154    <span class="keywordtype">void</span> enable_local_shell(<span class="keywordtype">bool</span> enabled);
<a name="l00155"></a>00155    <span class="keywordtype">void</span> get_sessions_list(std::string&amp; rv);
<a name="l00156"></a>00156    <span class="keywordtype">void</span> process_command(<a class="code" href="remote__shell_8cpp.html#a629b1eda6a29b9b070c429c5bbac0c86">session_ptr</a> <a class="code" href="classsession.html">session</a>, <span class="keyword">const</span> std::string&amp; cmd, <span class="keyword">const</span> std::string&amp; args);
<a name="l00157"></a>00157 
<a name="l00158"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#ab329609324e88e36eeb480b876fe0f06">00158</a>    <span class="keyword">const</span> std::string&amp; welcome()<span class="keyword"> const</span>
<a name="l00159"></a>00159 <span class="keyword">   </span>{
<a name="l00160"></a>00160       <span class="keywordflow">return</span> m_welcome;
<a name="l00161"></a>00161    }
<a name="l00162"></a>00162 };
<a name="l00163"></a>00163 
<a name="l00164"></a>00164 } }
<a name="l00165"></a>00165 
<a name="l00166"></a><a class="code" href="classsession__io__socket.html">00166</a> <span class="keyword">class </span><a class="code" href="classsession__io__socket.html">session_io_socket</a>
<a name="l00167"></a>00167 {
<a name="l00168"></a>00168 <span class="keyword">public</span>:
<a name="l00169"></a><a class="code" href="classsession__io__socket.html#acce942cb1bd2730bf6b5a533ca0757b9">00169</a>    <a class="code" href="classsession__io__socket.html">session_io_socket</a>(<a class="code" href="remote__shell_8cpp.html#a0d8e8ed0b23aa3d6d1c5fd1cf02b6af3">socket_ptr</a> socket)
<a name="l00170"></a>00170      : m_socket(socket)
<a name="l00171"></a>00171    {
<a name="l00172"></a>00172    }
<a name="l00173"></a>00173 
<a name="l00174"></a><a class="code" href="classsession__io__socket.html#a7f9f86beeb491fd3560a972a21a78075">00174</a>    <span class="keywordtype">void</span> set_nodelay()
<a name="l00175"></a>00175    {
<a name="l00176"></a>00176       m_socket-&gt;set_option(tcp::no_delay(<span class="keyword">true</span>));
<a name="l00177"></a>00177    }
<a name="l00178"></a>00178 
<a name="l00179"></a><a class="code" href="classsession__io__socket.html#ae48697ae6a13237c170ce8b46a2a5556">00179</a>    std::string get_peer_string()<span class="keyword"> const</span>
<a name="l00180"></a>00180 <span class="keyword">   </span>{
<a name="l00181"></a>00181       std::ostringstream oss;
<a name="l00182"></a>00182       oss &lt;&lt; m_socket-&gt;remote_endpoint();
<a name="l00183"></a>00183       <span class="keywordflow">return</span> oss.str();
<a name="l00184"></a>00184    }
<a name="l00185"></a>00185 
<a name="l00186"></a><a class="code" href="classsession__io__socket.html#a6c580ba8401c8e238979569415f2a16e">00186</a>    <span class="keywordtype">void</span> close()
<a name="l00187"></a>00187    {
<a name="l00188"></a>00188       mutex::scoped_lock lock(m_mutex);
<a name="l00189"></a>00189       m_socket-&gt;close();
<a name="l00190"></a>00190    }
<a name="l00191"></a>00191 
<a name="l00192"></a>00192    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> HandlerT&gt;
<a name="l00193"></a><a class="code" href="classsession__io__socket.html#a17d8154393cf51af76e657f39520462f">00193</a>    <span class="keywordtype">void</span> write_stdout(<span class="keyword">const</span> std::string&amp; data, HandlerT handler)
<a name="l00194"></a>00194    {
<a name="l00195"></a>00195       mutex::scoped_lock lock(m_mutex);
<a name="l00196"></a>00196       asio::async_write(*m_socket, asio::buffer(data.c_str(), data.length()), handler);
<a name="l00197"></a>00197    }
<a name="l00198"></a>00198 
<a name="l00199"></a>00199    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> HandlerT&gt;
<a name="l00200"></a><a class="code" href="classsession__io__socket.html#a5899782b22edca73746c9181cd5dc78b">00200</a>    <span class="keywordtype">void</span> write_stderr(<span class="keyword">const</span> std::string&amp; data, HandlerT handler)
<a name="l00201"></a>00201    {
<a name="l00202"></a>00202       mutex::scoped_lock lock(m_mutex);
<a name="l00203"></a>00203       asio::async_write(*m_socket, asio::buffer(data.c_str(), data.length()), handler);
<a name="l00204"></a>00204    }
<a name="l00205"></a>00205 
<a name="l00206"></a>00206    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> HandlerT&gt;
<a name="l00207"></a><a class="code" href="classsession__io__socket.html#a78290c7d468bad59b5d0d11311f2561e">00207</a>    <span class="keywordtype">void</span> read_some(<span class="keywordtype">void</span> *data, <span class="keywordtype">size_t</span> size, HandlerT handler)
<a name="l00208"></a>00208    {
<a name="l00209"></a>00209       mutex::scoped_lock lock(m_mutex);
<a name="l00210"></a>00210       m_socket-&gt;async_read_some(asio::buffer(data, size), handler);
<a name="l00211"></a>00211    }
<a name="l00212"></a>00212 
<a name="l00213"></a>00213 <span class="keyword">private</span>:
<a name="l00214"></a><a class="code" href="classsession__io__socket.html#a941383f876f740fbb6905e15e65a96ea">00214</a>    <a class="code" href="remote__shell_8cpp.html#a0d8e8ed0b23aa3d6d1c5fd1cf02b6af3">socket_ptr</a> <a class="code" href="classsession__io__socket.html#a941383f876f740fbb6905e15e65a96ea">m_socket</a>;
<a name="l00215"></a><a class="code" href="classsession__io__socket.html#ab4c89dae9f70f04005421ac7cc3a77c4">00215</a>    mutex <a class="code" href="classsession__io__socket.html#ab4c89dae9f70f04005421ac7cc3a77c4">m_mutex</a>;
<a name="l00216"></a>00216 };
<a name="l00217"></a>00217 
<a name="l00218"></a><a class="code" href="classsession__io__console.html">00218</a> <span class="keyword">class </span><a class="code" href="classsession__io__console.html">session_io_console</a>
<a name="l00219"></a>00219 {
<a name="l00220"></a>00220 <span class="keyword">public</span>:
<a name="l00221"></a><a class="code" href="classsession__io__console.html#a78c8ca018cefafb94335d12f9ba7be42">00221</a>    <span class="keyword">typedef</span> <a class="code" href="classmoost_1_1io_1_1detail_1_1helper.html#a30a42bd489c876b7c68374a8adc0fb3e">moost::io::helper::native_io_t</a> <a class="code" href="classsession__io__console.html#a78c8ca018cefafb94335d12f9ba7be42">native_io_t</a>;
<a name="l00222"></a>00222 
<a name="l00223"></a><a class="code" href="classsession__io__console.html#ad5b411251d7db6598ca0594658c8876b">00223</a>    <a class="code" href="classsession__io__console.html">session_io_console</a>(shared_ptr&lt;asio::io_service&gt; ios, <a class="code" href="classsession__io__console.html#a78c8ca018cefafb94335d12f9ba7be42">native_io_t</a> in_fd, <a class="code" href="classsession__io__console.html#a78c8ca018cefafb94335d12f9ba7be42">native_io_t</a> out_fd, <a class="code" href="classsession__io__console.html#a78c8ca018cefafb94335d12f9ba7be42">native_io_t</a> err_fd, <span class="keyword">const</span> std::string&amp; name)
<a name="l00224"></a>00224      : m_ios(ios)
<a name="l00225"></a>00225      , m_in_fwd(ios, in_fd)
<a name="l00226"></a>00226      , m_out(out_fd)
<a name="l00227"></a>00227      , m_err(err_fd)
<a name="l00228"></a>00228      , m_name(name)
<a name="l00229"></a>00229    {
<a name="l00230"></a>00230    }
<a name="l00231"></a>00231 
<a name="l00232"></a><a class="code" href="classsession__io__console.html#a9099e97a31ae702c20fa51be6126021c">00232</a>    <span class="keywordtype">void</span> set_nodelay()
<a name="l00233"></a>00233    {
<a name="l00234"></a>00234       <span class="comment">// nothing to do here</span>
<a name="l00235"></a>00235    }
<a name="l00236"></a>00236 
<a name="l00237"></a><a class="code" href="classsession__io__console.html#aab4a5642603690d21c9a0a4c28cc8de4">00237</a>    <span class="keyword">const</span> std::string&amp; get_peer_string()<span class="keyword"> const</span>
<a name="l00238"></a>00238 <span class="keyword">   </span>{
<a name="l00239"></a>00239       <span class="keywordflow">return</span> m_name;
<a name="l00240"></a>00240    }
<a name="l00241"></a>00241 
<a name="l00242"></a><a class="code" href="classsession__io__console.html#a87e1168182014901b7db20bfedd83f5c">00242</a>    <span class="keywordtype">void</span> close()
<a name="l00243"></a>00243    {
<a name="l00244"></a>00244       <span class="comment">// this is required to make sure the async read finishes</span>
<a name="l00245"></a>00245       m_in_fwd.close();
<a name="l00246"></a>00246    }
<a name="l00247"></a>00247 
<a name="l00248"></a>00248    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> HandlerT&gt;
<a name="l00249"></a><a class="code" href="classsession__io__console.html#a8c6b58d6b4641677a4cdf71aa3cdc7f9">00249</a>    <span class="keywordtype">void</span> write_stdout(<span class="keyword">const</span> std::string&amp; data, HandlerT handler)
<a name="l00250"></a>00250    {
<a name="l00251"></a>00251       write_console(m_out, data, handler);
<a name="l00252"></a>00252    }
<a name="l00253"></a>00253 
<a name="l00254"></a>00254    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> HandlerT&gt;
<a name="l00255"></a><a class="code" href="classsession__io__console.html#a7cb8c0e6941a98a387bb5bc247a938d3">00255</a>    <span class="keywordtype">void</span> write_stderr(<span class="keyword">const</span> std::string&amp; data, HandlerT handler)
<a name="l00256"></a>00256    {
<a name="l00257"></a>00257       write_console(m_err, data, handler);
<a name="l00258"></a>00258    }
<a name="l00259"></a>00259 
<a name="l00260"></a>00260    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> HandlerT&gt;
<a name="l00261"></a><a class="code" href="classsession__io__console.html#a0217f260bcabc534ef42baa2c45e398e">00261</a>    <span class="keywordtype">void</span> read_some(<span class="keywordtype">void</span> *data, <span class="keywordtype">size_t</span> size, HandlerT handler)
<a name="l00262"></a>00262    {
<a name="l00263"></a>00263       m_in_fwd.read_async(data, size, handler);
<a name="l00264"></a>00264    }
<a name="l00265"></a>00265 
<a name="l00266"></a>00266 <span class="keyword">private</span>:
<a name="l00267"></a>00267    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> HandlerT&gt;
<a name="l00268"></a><a class="code" href="classsession__io__console.html#adeb980a88b8d673b093b3e527ef6e90c">00268</a>    <span class="keywordtype">void</span> write_console(<a class="code" href="classsession__io__console.html#a78c8ca018cefafb94335d12f9ba7be42">native_io_t</a> fd, <span class="keyword">const</span> std::string&amp; data, HandlerT handler)
<a name="l00269"></a>00269    {
<a name="l00270"></a>00270       <span class="comment">// We can&#39;t use boost::asio for this, as we could be writing</span>
<a name="l00271"></a>00271       <span class="comment">// to a regular file, for which the asio reactor (e.g. epoll</span>
<a name="l00272"></a>00272       <span class="comment">// or poll) might not have support.</span>
<a name="l00273"></a>00273 
<a name="l00274"></a>00274       <span class="comment">// So we just use the native, synchronous file i/o, but fake</span>
<a name="l00275"></a>00275       <span class="comment">// it to behave as similar to boost::asio as possible.</span>
<a name="l00276"></a>00276 
<a name="l00277"></a>00277       boost::system::error_code ec;
<a name="l00278"></a>00278       <span class="keywordtype">size_t</span> written = 0;
<a name="l00279"></a>00279 
<a name="l00280"></a>00280       {
<a name="l00281"></a>00281          mutex::scoped_lock lock(m_mutex);
<a name="l00282"></a>00282 
<a name="l00283"></a>00283          <span class="keywordflow">if</span> (!<a class="code" href="classmoost_1_1io_1_1detail_1_1helper.html#adedbdaf6224d3bf9a63a78487044d84a">moost::io::helper::write</a>(fd, data.c_str(), data.length(), &amp;written))
<a name="l00284"></a>00284          {
<a name="l00285"></a>00285             ec.assign(<a class="code" href="classmoost_1_1io_1_1detail_1_1helper.html#abdfa4a4cdbcf33f717cb04e9e766e70a">moost::io::helper::error</a>(), boost::asio::error::get_system_category());
<a name="l00286"></a>00286             written = 0;
<a name="l00287"></a>00287          }
<a name="l00288"></a>00288       }
<a name="l00289"></a>00289 
<a name="l00290"></a>00290       <span class="comment">// Make sure the handler is called synchronously, modelling</span>
<a name="l00291"></a>00291       <span class="comment">// the behaviour of boost::asio.</span>
<a name="l00292"></a>00292 
<a name="l00293"></a>00293       m_ios-&gt;post(bind(handler, ec, static_cast&lt;std::size_t&gt;(written)));
<a name="l00294"></a>00294    }
<a name="l00295"></a>00295 
<a name="l00296"></a><a class="code" href="classsession__io__console.html#adba9cc107b939a57f9b7f534cbcb6ed4">00296</a>    mutex <a class="code" href="classsession__io__console.html#adba9cc107b939a57f9b7f534cbcb6ed4">m_mutex</a>;
<a name="l00297"></a><a class="code" href="classsession__io__console.html#ae6340cf0c0d4f133e58b18634d225876">00297</a>    shared_ptr&lt;asio::io_service&gt; <a class="code" href="classsession__io__console.html#ae6340cf0c0d4f133e58b18634d225876">m_ios</a>;
<a name="l00298"></a><a class="code" href="classsession__io__console.html#ab457d5721118a4ee1cca6184578c5b7b">00298</a>    <a class="code" href="classmoost_1_1io_1_1async__stream__forwarder.html">moost::io::async_stream_forwarder</a> <a class="code" href="classsession__io__console.html#ab457d5721118a4ee1cca6184578c5b7b">m_in_fwd</a>;
<a name="l00299"></a><a class="code" href="classsession__io__console.html#ad2d73345d1b9503ed4d6ba1cc89f4c83">00299</a>    <a class="code" href="classsession__io__console.html#a78c8ca018cefafb94335d12f9ba7be42">native_io_t</a> <a class="code" href="classsession__io__console.html#ad2d73345d1b9503ed4d6ba1cc89f4c83">m_out</a>;
<a name="l00300"></a><a class="code" href="classsession__io__console.html#ad79e6135a73ef70a746ca218f28d93d4">00300</a>    <a class="code" href="classsession__io__console.html#a78c8ca018cefafb94335d12f9ba7be42">native_io_t</a> <a class="code" href="classsession__io__console.html#ad79e6135a73ef70a746ca218f28d93d4">m_err</a>;
<a name="l00301"></a><a class="code" href="classsession__io__console.html#a2f6068a867d8b1557ec2820dde7fe6d4">00301</a>    <span class="keyword">const</span> std::string <a class="code" href="classsession__io__console.html#a2f6068a867d8b1557ec2820dde7fe6d4">m_name</a>;
<a name="l00302"></a>00302 };
<a name="l00303"></a>00303 
<a name="l00304"></a>00304 <span class="keyword">template</span> &lt;<span class="keyword">class</span> SessionIoT&gt;
<a name="l00305"></a><a class="code" href="classsession__writer.html">00305</a> <span class="keyword">class </span><a class="code" href="classsession__writer.html">session_writer</a> : <span class="keyword">public</span> <a class="code" href="classmoost_1_1service_1_1stream__writer__iface.html">stream_writer_iface</a>
<a name="l00306"></a>00306 {
<a name="l00307"></a>00307 <span class="keyword">public</span>:
<a name="l00308"></a><a class="code" href="classsession__writer.html#a96924f2624db27cfcf97fdf10cc79940">00308</a>    <a class="code" href="classsession__writer.html">session_writer</a>(shared_ptr&lt;SessionIoT&gt; io)
<a name="l00309"></a>00309      : m_io(io)
<a name="l00310"></a>00310    {
<a name="l00311"></a>00311    }
<a name="l00312"></a>00312 
<a name="l00313"></a><a class="code" href="classsession__writer.html#ac4bb15edc8c6f83a35800e2a02eaa742">00313</a>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> write(<span class="keyword">const</span> <span class="keywordtype">char</span> *data, <span class="keywordtype">size_t</span> len)
<a name="l00314"></a>00314    {
<a name="l00315"></a>00315       std::string *s = <span class="keyword">new</span> std::string(data, len);
<a name="l00316"></a>00316       m_io-&gt;write_stdout(*s, bind(&amp;<a class="code" href="classsession__writer.html">session_writer&lt;SessionIoT&gt;::on_write_done</a>, s));
<a name="l00317"></a>00317    }
<a name="l00318"></a>00318 
<a name="l00319"></a>00319 <span class="keyword">private</span>:
<a name="l00320"></a><a class="code" href="classsession__writer.html#a8ab088166ffbb948fe509ef2c163c85a">00320</a>    <span class="keyword">static</span> <span class="keywordtype">void</span> on_write_done(std::string *str)
<a name="l00321"></a>00321    {
<a name="l00322"></a>00322       <span class="keyword">delete</span> str;
<a name="l00323"></a>00323    }
<a name="l00324"></a>00324 
<a name="l00325"></a><a class="code" href="classsession__writer.html#aa67a3d91bff34859713d79481ddec567">00325</a>    shared_ptr&lt;SessionIoT&gt; <a class="code" href="classsession__writer.html#aa67a3d91bff34859713d79481ddec567">m_io</a>;
<a name="l00326"></a>00326 };
<a name="l00327"></a>00327 
<a name="l00328"></a><a class="code" href="classsession__base.html">00328</a> <span class="keyword">class </span><a class="code" href="classsession__base.html">session_base</a> : <span class="keyword">public</span> enable_shared_from_this&lt;session_base&gt;, <span class="keyword">public</span> <a class="code" href="classboost_1_1noncopyable.html">noncopyable</a>
<a name="l00329"></a>00329 {
<a name="l00330"></a>00330 <span class="keyword">protected</span>:
<a name="l00331"></a><a class="code" href="classsession__base.html#aa7c540c939b5373e7735e857dc4ebdcc">00331</a>    <span class="keyword">enum</span> <a class="code" href="classsession__base.html#aa7c540c939b5373e7735e857dc4ebdcc">state</a> {
<a name="l00332"></a><a class="code" href="classsession__base.html#aa7c540c939b5373e7735e857dc4ebdcca0ddde47f0dc1292a2e4d0fa9b27e76c4">00332</a>       <a class="code" href="classsession__base.html#aa7c540c939b5373e7735e857dc4ebdcca0ddde47f0dc1292a2e4d0fa9b27e76c4">SESSION_CREATED</a>,
<a name="l00333"></a><a class="code" href="classsession__base.html#aa7c540c939b5373e7735e857dc4ebdcca6e633dcc7d547dd0dd66b14e84ac3f09">00333</a>       <a class="code" href="classsession__base.html#aa7c540c939b5373e7735e857dc4ebdcca6e633dcc7d547dd0dd66b14e84ac3f09">SESSION_ATTACHED</a>,
<a name="l00334"></a><a class="code" href="classsession__base.html#aa7c540c939b5373e7735e857dc4ebdcca66e8b15c6ecb4ee0c9f296260ee84873">00334</a>       <a class="code" href="classsession__base.html#aa7c540c939b5373e7735e857dc4ebdcca66e8b15c6ecb4ee0c9f296260ee84873">SESSION_STOPPING</a>,
<a name="l00335"></a><a class="code" href="classsession__base.html#aa7c540c939b5373e7735e857dc4ebdccac62a82d66a4d6dd388b558884a5b847e">00335</a>       SESSION_STOPPED
<a name="l00336"></a>00336    };
<a name="l00337"></a>00337 
<a name="l00338"></a>00338 <span class="keyword">public</span>:
<a name="l00339"></a><a class="code" href="classsession__base.html#a2543695be8f8bd682078ea88fa43bbed">00339</a>    <a class="code" href="classsession__base.html">session_base</a>(<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html">remote_shell_server_impl</a>&amp; srv, <a class="code" href="classmoost_1_1service_1_1remote__shell__iface.html" title="Interface for remote command shell.">remote_shell_iface</a> *rsi, <span class="keywordtype">bool</span> allow_quit, <span class="keywordtype">bool</span> enable_cout_cerr, <span class="keywordtype">bool</span> enable_cls)
<a name="l00340"></a>00340       : m_srv(srv)
<a name="l00341"></a>00341       , m_state(SESSION_CREATED)
<a name="l00342"></a>00342       , m_rsi(rsi)
<a name="l00343"></a>00343       , m_cout_on(true)
<a name="l00344"></a>00344       , m_cerr_on(true)
<a name="l00345"></a>00345       , m_processing_input(true)
<a name="l00346"></a>00346       , m_allow_quit(allow_quit)
<a name="l00347"></a>00347       , m_enable_cout_cerr(enable_cout_cerr)
<a name="l00348"></a>00348       , m_enable_cls(enable_cls)
<a name="l00349"></a>00349       , m_t_connect(boost::posix_time::second_clock::universal_time())
<a name="l00350"></a>00350    {
<a name="l00351"></a>00351    }
<a name="l00352"></a>00352 
<a name="l00353"></a><a class="code" href="classsession__base.html#a71ae7e8f3548f11db01ff6810b27f997">00353</a>    <span class="keyword">virtual</span> ~<a class="code" href="classsession__base.html">session_base</a>()
<a name="l00354"></a>00354    {
<a name="l00355"></a>00355    }
<a name="l00356"></a>00356 
<a name="l00357"></a><a class="code" href="classsession__base.html#a52cb8d25543fc958298d1054de7eff12">00357</a>    <span class="keywordtype">void</span> start(<a class="code" href="namespacemoost_1_1service.html#ab86c1f81ca433ecae91082cc367e1124">appender_ptr</a> appender)
<a name="l00358"></a>00358    {
<a name="l00359"></a>00359       set_nodelay();
<a name="l00360"></a>00360       m_app = appender;
<a name="l00361"></a>00361       m_app-&gt;attach();
<a name="l00362"></a>00362       m_state = SESSION_ATTACHED;
<a name="l00363"></a>00363       m_peer = get_peer_string();
<a name="l00364"></a>00364       continue_session(<span class="stringliteral">&quot;accepted client connection from &quot;</span> + m_peer + <span class="stringliteral">&quot;\r\n&quot;</span> + m_srv.welcome());
<a name="l00365"></a>00365       read_more();
<a name="l00366"></a>00366    }
<a name="l00367"></a>00367 
<a name="l00368"></a><a class="code" href="classsession__base.html#ac7f78aa3774326579636576f9ed0ba21">00368</a>    <span class="keywordtype">void</span> stop(<span class="keyword">const</span> std::string&amp; msg)
<a name="l00369"></a>00369    {
<a name="l00370"></a>00370       <span class="keywordflow">if</span> (is_attached())
<a name="l00371"></a>00371       {
<a name="l00372"></a>00372          write(<span class="stringliteral">&quot;\r\n&quot;</span> + msg, SESSION_STOPPING);
<a name="l00373"></a>00373       }
<a name="l00374"></a>00374    }
<a name="l00375"></a>00375 
<a name="l00376"></a><a class="code" href="classsession__base.html#a673f6406c5cefb2493c1bcbc77fc890a">00376</a>    <span class="keywordtype">void</span> set_stdout_state(<span class="keywordtype">bool</span> on)
<a name="l00377"></a>00377    {
<a name="l00378"></a>00378       m_cout_on = on;
<a name="l00379"></a>00379    }
<a name="l00380"></a>00380 
<a name="l00381"></a><a class="code" href="classsession__base.html#ae72995ab7334b3a19b9592f3dcbfb01f">00381</a>    <span class="keywordtype">void</span> set_stderr_state(<span class="keywordtype">bool</span> on)
<a name="l00382"></a>00382    {
<a name="l00383"></a>00383       m_cerr_on = on;
<a name="l00384"></a>00384    }
<a name="l00385"></a>00385 
<a name="l00386"></a><a class="code" href="classsession__base.html#ab8e9545ea29eb955aad7432c9c9b636d">00386</a>    std::string get_info()<span class="keyword"> const</span>
<a name="l00387"></a>00387 <span class="keyword">   </span>{
<a name="l00388"></a>00388       boost::posix_time::time_duration duration = boost::posix_time::second_clock::universal_time() - m_t_connect;
<a name="l00389"></a>00389       std::ostringstream oss;
<a name="l00390"></a>00390 
<a name="l00391"></a>00391       oss &lt;&lt; m_peer &lt;&lt; <span class="stringliteral">&quot; [&quot;</span> &lt;&lt; duration &lt;&lt; <span class="stringliteral">&quot;]&quot;</span>;
<a name="l00392"></a>00392 
<a name="l00393"></a>00393       <span class="keywordflow">return</span> oss.str();
<a name="l00394"></a>00394    }
<a name="l00395"></a>00395 
<a name="l00396"></a>00396    <span class="keywordtype">void</span> add_stdout(<span class="keyword">const</span> <span class="keywordtype">char</span> *buffer, <span class="keywordtype">size_t</span> count);
<a name="l00397"></a>00397    <span class="keywordtype">void</span> add_stderr(<span class="keyword">const</span> <span class="keywordtype">char</span> *buffer, <span class="keywordtype">size_t</span> count);
<a name="l00398"></a>00398    <span class="keywordtype">void</span> command_result(<span class="keywordtype">bool</span> handled, <span class="keyword">const</span> std::string&amp; cmd, <span class="keyword">const</span> std::string&amp; rv);
<a name="l00399"></a>00399 
<a name="l00400"></a>00400 <span class="keyword">protected</span>:
<a name="l00401"></a>00401    <span class="keyword">virtual</span> <span class="keywordtype">void</span> set_nodelay() = 0;
<a name="l00402"></a>00402    <span class="keyword">virtual</span> std::string get_peer_string() <span class="keyword">const</span> = 0;
<a name="l00403"></a>00403    <span class="keyword">virtual</span> <span class="keywordtype">void</span> close() = 0;
<a name="l00404"></a>00404    <span class="keyword">virtual</span> <span class="keywordtype">void</span> read_more(<span class="keywordtype">char</span> *data, <span class="keywordtype">size_t</span> max) = 0;
<a name="l00405"></a>00405    <span class="keyword">virtual</span> <span class="keywordtype">void</span> write_stdout(std::string *s, state st) = 0;
<a name="l00406"></a>00406    <span class="keyword">virtual</span> <span class="keywordtype">void</span> write_stderr(std::string *s, state st) = 0;
<a name="l00407"></a>00407 
<a name="l00408"></a>00408    <span class="keywordtype">void</span> on_write_done(std::string *s, state st, <span class="keyword">const</span> system::error_code&amp; error);
<a name="l00409"></a>00409    <span class="keywordtype">void</span> on_read_done(<span class="keyword">const</span> system::error_code&amp; error, <span class="keywordtype">size_t</span> bytes_transferred);
<a name="l00410"></a>00410 
<a name="l00411"></a>00411 <span class="keyword">private</span>:
<a name="l00412"></a><a class="code" href="classsession__base.html#a920242a2886c8e906f2b2bc3f6253d13">00412</a>    <span class="keywordtype">void</span> read_more()
<a name="l00413"></a>00413    {
<a name="l00414"></a>00414       read_more(m_data, max_length);
<a name="l00415"></a>00415    }
<a name="l00416"></a>00416 
<a name="l00417"></a><a class="code" href="classsession__base.html#a21f1f5129b8471b60c886c574f056f4d">00417</a>    <span class="keywordtype">void</span> write(<span class="keyword">const</span> std::string&amp; str)
<a name="l00418"></a>00418    {
<a name="l00419"></a>00419       write(str, m_state);
<a name="l00420"></a>00420    }
<a name="l00421"></a>00421 
<a name="l00422"></a><a class="code" href="classsession__base.html#a51e7c4b4573ab2ab5c4520107a1f3381">00422</a>    <span class="keywordtype">void</span> write(<span class="keyword">const</span> std::string&amp; str, <a class="code" href="classsession__base.html#aa7c540c939b5373e7735e857dc4ebdcc">state</a> st)
<a name="l00423"></a>00423    {
<a name="l00424"></a>00424       std::string *s = <span class="keyword">new</span> std::string(str);
<a name="l00425"></a>00425       write_stdout(s, st);
<a name="l00426"></a>00426    }
<a name="l00427"></a>00427 
<a name="l00428"></a><a class="code" href="classsession__base.html#a973154f0d53b95892a808e74f6e3c76a">00428</a>    <span class="keywordtype">bool</span> is_attached()<span class="keyword"> const</span>
<a name="l00429"></a>00429 <span class="keyword">   </span>{
<a name="l00430"></a>00430       <span class="keywordflow">return</span> m_state &gt;= SESSION_ATTACHED &amp;&amp; m_state &lt; SESSION_STOPPED;
<a name="l00431"></a>00431    }
<a name="l00432"></a>00432 
<a name="l00433"></a><a class="code" href="classsession__base.html#aef3b5fc7e9dea7ca5a8ff8ce22040168">00433</a>    <span class="keywordtype">bool</span> is_stopped()<span class="keyword"> const</span>
<a name="l00434"></a>00434 <span class="keyword">   </span>{
<a name="l00435"></a>00435       <span class="keywordflow">return</span> m_state &gt;= SESSION_STOPPED;
<a name="l00436"></a>00436    }
<a name="l00437"></a>00437 
<a name="l00438"></a>00438    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;
<a name="l00439"></a>00439    <span class="keywordtype">void</span> get_more_help(std::ostream&amp; os, <span class="keyword">const</span> T&amp; obj) <span class="keyword">const</span>;
<a name="l00440"></a>00440 
<a name="l00441"></a>00441    <span class="keywordtype">void</span> get_help(std::string&amp; rv) <span class="keyword">const</span>;
<a name="l00442"></a>00442    <span class="keywordtype">void</span> continue_session(<span class="keyword">const</span> std::string&amp; str = <span class="stringliteral">&quot;&quot;</span>);
<a name="l00443"></a>00443    <span class="keywordtype">void</span> handle_stop();
<a name="l00444"></a>00444    <span class="keywordtype">bool</span> handle_command(std::string&amp; rv, <span class="keyword">const</span> std::string&amp; cmd, <span class="keyword">const</span> std::string&amp; args);
<a name="l00445"></a>00445    <span class="keywordtype">bool</span> read_next_command(std::string&amp; cmd, std::string&amp; args);
<a name="l00446"></a>00446    <span class="keywordtype">bool</span> log_level(std::string&amp; rv, <span class="keyword">const</span> std::string&amp; args);
<a name="l00447"></a>00447    <span class="keywordtype">void</span> process_input();
<a name="l00448"></a>00448 
<a name="l00449"></a><a class="code" href="classsession__base.html#a72a2f3cf7d4e55b4d10a1cf664340fbd">00449</a>    <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html">remote_shell_server_impl</a>&amp; <a class="code" href="classsession__base.html#a72a2f3cf7d4e55b4d10a1cf664340fbd">m_srv</a>;
<a name="l00450"></a><a class="code" href="classsession__base.html#ad36f53a84ed8420691ad8e876b7643eb">00450</a>    std::string <a class="code" href="classsession__base.html#ad36f53a84ed8420691ad8e876b7643eb">m_peer</a>;
<a name="l00451"></a><a class="code" href="classsession__base.html#a1a1707607a7b8564f0c2c3fd56d99b20a4a75a64bb52bb4d5cbabda9c705b3353">00451</a>    <span class="keyword">enum</span> { max_length = 1024 };
<a name="l00452"></a><a class="code" href="classsession__base.html#ab11e069f948399ee8c121b5bad69f8ac">00452</a>    <span class="keywordtype">char</span> m_data[max_length];
<a name="l00453"></a><a class="code" href="classsession__base.html#a3928f08e93e3d01ea903ae43efb05b48">00453</a>    <a class="code" href="namespacemoost_1_1service.html#ab86c1f81ca433ecae91082cc367e1124">appender_ptr</a> <a class="code" href="classsession__base.html#a3928f08e93e3d01ea903ae43efb05b48">m_app</a>;
<a name="l00454"></a><a class="code" href="classsession__base.html#a7da5ec2eefc9a4fc403ba0c2b891433a">00454</a>    <span class="keyword">enum</span> <a class="code" href="classsession__base.html#aa7c540c939b5373e7735e857dc4ebdcc">state</a> <a class="code" href="classsession__base.html#a7da5ec2eefc9a4fc403ba0c2b891433a">m_state</a>;
<a name="l00455"></a><a class="code" href="classsession__base.html#a570e4f34a473434078b56ef089d751a6">00455</a>    <a class="code" href="classmoost_1_1service_1_1remote__shell__iface.html" title="Interface for remote command shell.">remote_shell_iface</a> * <span class="keyword">const</span> <a class="code" href="classsession__base.html#a570e4f34a473434078b56ef089d751a6">m_rsi</a>;
<a name="l00456"></a><a class="code" href="classsession__base.html#a2cb7cfba3b8d48da47e749312c85b244">00456</a>    std::string <a class="code" href="classsession__base.html#a2cb7cfba3b8d48da47e749312c85b244">m_inbuf</a>;
<a name="l00457"></a><a class="code" href="classsession__base.html#a38157f99e189a1a7849619b38f4049f3">00457</a>    <span class="keywordtype">bool</span> <a class="code" href="classsession__base.html#a38157f99e189a1a7849619b38f4049f3">m_cout_on</a>;
<a name="l00458"></a><a class="code" href="classsession__base.html#a28ec4c182981fb482348f6841cb9f71b">00458</a>    <span class="keywordtype">bool</span> <a class="code" href="classsession__base.html#a28ec4c182981fb482348f6841cb9f71b">m_cerr_on</a>;
<a name="l00459"></a><a class="code" href="classsession__base.html#acd56550ae023d2c99896df2b6fc8e566">00459</a>    <span class="keywordtype">bool</span> <a class="code" href="classsession__base.html#acd56550ae023d2c99896df2b6fc8e566">m_processing_input</a>;
<a name="l00460"></a><a class="code" href="classsession__base.html#a8eecef5c7440011cbad510f87bb0c0c6">00460</a>    <span class="keyword">const</span> <span class="keywordtype">bool</span> <a class="code" href="classsession__base.html#a8eecef5c7440011cbad510f87bb0c0c6">m_allow_quit</a>;
<a name="l00461"></a><a class="code" href="classsession__base.html#ae07d960f13eaf1627d79b17010e06629">00461</a>    <span class="keyword">const</span> <span class="keywordtype">bool</span> <a class="code" href="classsession__base.html#ae07d960f13eaf1627d79b17010e06629">m_enable_cout_cerr</a>;
<a name="l00462"></a><a class="code" href="classsession__base.html#a8ed967327fa382146635160d3b4825d8">00462</a>    <span class="keyword">const</span> <span class="keywordtype">bool</span> <a class="code" href="classsession__base.html#a8ed967327fa382146635160d3b4825d8">m_enable_cls</a>;
<a name="l00463"></a><a class="code" href="classsession__base.html#ab13adbb88fcca4743b325d01f39f6b23">00463</a>    <span class="keyword">const</span> boost::posix_time::ptime <a class="code" href="classsession__base.html#ab13adbb88fcca4743b325d01f39f6b23">m_t_connect</a>;
<a name="l00464"></a>00464 };
<a name="l00465"></a>00465 
<a name="l00466"></a>00466 <span class="keyword">template</span> &lt;<span class="keyword">class</span> SessionIoT, <span class="keywordtype">bool</span> AllowQuit = true, <span class="keywordtype">bool</span> EnableCLS = true&gt;
<a name="l00467"></a><a class="code" href="classsession.html">00467</a> <span class="keyword">class </span><a class="code" href="classsession.html">session</a> : <span class="keyword">public</span> <a class="code" href="classsession__base.html">session_base</a>
<a name="l00468"></a>00468 {
<a name="l00469"></a>00469 <span class="keyword">public</span>:
<a name="l00470"></a><a class="code" href="classsession.html#ae6274e350e26b63ba77c7f54a1030c45">00470</a>    <a class="code" href="classsession.html">session</a>(<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html">remote_shell_server_impl</a>&amp; srv, <a class="code" href="classmoost_1_1service_1_1remote__shell__iface.html" title="Interface for remote command shell.">remote_shell_iface</a> *rsi, shared_ptr&lt;SessionIoT&gt; io, <span class="keywordtype">bool</span> enable_cout_cerr = <span class="keyword">true</span>)
<a name="l00471"></a>00471       : <a class="code" href="classsession__base.html">session_base</a>(srv, rsi, AllowQuit, enable_cout_cerr, EnableCLS)
<a name="l00472"></a>00472       , m_io(io)
<a name="l00473"></a>00473    {
<a name="l00474"></a>00474    }
<a name="l00475"></a>00475 
<a name="l00476"></a>00476 <span class="keyword">protected</span>:
<a name="l00477"></a><a class="code" href="classsession.html#aca35d2aa79d1cb48f95c4ad6e543b7dc">00477</a>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> set_nodelay()
<a name="l00478"></a>00478    {
<a name="l00479"></a>00479       m_io-&gt;<a class="code" href="classsession__base.html#a3ea5bdad75a1ea7a6b4ab13d1867856b">set_nodelay</a>();
<a name="l00480"></a>00480    }
<a name="l00481"></a>00481 
<a name="l00482"></a><a class="code" href="classsession.html#a6919b95c24d14306578f58b834364c79">00482</a>    <span class="keyword">virtual</span> std::string get_peer_string()<span class="keyword"> const</span>
<a name="l00483"></a>00483 <span class="keyword">   </span>{
<a name="l00484"></a>00484       <span class="keywordflow">return</span> m_io-&gt;get_peer_string();
<a name="l00485"></a>00485    }
<a name="l00486"></a>00486 
<a name="l00487"></a><a class="code" href="classsession.html#a916464098e40f3afa6f74a6f8ac1e4bd">00487</a>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> close()
<a name="l00488"></a>00488    {
<a name="l00489"></a>00489       <span class="keywordflow">return</span> m_io-&gt;close();
<a name="l00490"></a>00490    }
<a name="l00491"></a>00491 
<a name="l00492"></a><a class="code" href="classsession.html#a5cb77a85a8fd0b3f4661d5627acf6312">00492</a>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> read_more(<span class="keywordtype">char</span> *data, <span class="keywordtype">size_t</span> max)
<a name="l00493"></a>00493    {
<a name="l00494"></a>00494       m_io-&gt;read_some(data, max, bind(&amp;<a class="code" href="classsession__base.html#ad682393482519d03255b3b7545a62cd4">session::on_read_done</a>, shared_from_this(),
<a name="l00495"></a>00495             asio::placeholders::error, asio::placeholders::bytes_transferred));
<a name="l00496"></a>00496    }
<a name="l00497"></a>00497 
<a name="l00498"></a><a class="code" href="classsession.html#a358da1c965e8844888bd9230b9af221b">00498</a>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> write_stdout(std::string *s, <a class="code" href="classsession__base.html#aa7c540c939b5373e7735e857dc4ebdcc">state</a> st)
<a name="l00499"></a>00499    {
<a name="l00500"></a>00500       m_io-&gt;write_stdout(*s, bind(&amp;<a class="code" href="classsession__base.html#ad4e60c36d5bb15e4c494c0499fcbd07a">session::on_write_done</a>, shared_from_this(), s, st, asio::placeholders::error));
<a name="l00501"></a>00501    }
<a name="l00502"></a>00502 
<a name="l00503"></a><a class="code" href="classsession.html#ae63c588dfdb689090b50f20c7f65ce39">00503</a>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> write_stderr(std::string *s, <a class="code" href="classsession__base.html#aa7c540c939b5373e7735e857dc4ebdcc">state</a> st)
<a name="l00504"></a>00504    {
<a name="l00505"></a>00505       m_io-&gt;write_stderr(*s, bind(&amp;<a class="code" href="classsession__base.html#ad4e60c36d5bb15e4c494c0499fcbd07a">session::on_write_done</a>, shared_from_this(), s, st, asio::placeholders::error));
<a name="l00506"></a>00506    }
<a name="l00507"></a>00507 
<a name="l00508"></a>00508 <span class="keyword">private</span>:
<a name="l00509"></a><a class="code" href="classsession.html#a873ce83a357955d9c66c9fd515043c84">00509</a>    shared_ptr&lt;SessionIoT&gt; <a class="code" href="classsession.html#a873ce83a357955d9c66c9fd515043c84">m_io</a>;
<a name="l00510"></a>00510 };
<a name="l00511"></a>00511 
<a name="l00512"></a>00512 <span class="comment">/**********************************************************************/</span>
<a name="l00513"></a>00513 
<a name="l00514"></a><a class="code" href="classsession__base.html#a7f5cb18985211f953a8696fba35deb53">00514</a> <span class="keywordtype">void</span> <a class="code" href="classsession__base.html#a7f5cb18985211f953a8696fba35deb53">session_base::add_stdout</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *buffer, <span class="keywordtype">size_t</span> count)
<a name="l00515"></a>00515 {
<a name="l00516"></a>00516    <span class="keywordflow">if</span> (m_cout_on)
<a name="l00517"></a>00517    {
<a name="l00518"></a>00518       std::string *s = <span class="keyword">new</span> std::string();
<a name="l00519"></a>00519       s-&gt;append(terminal_format::color(<a class="code" href="namespacemoost.html#a3f1a6696186f52ee0f54afb8fdd96ee2a75555ec16fd1e3baf9653212bcaf0755">C_GREEN</a>));
<a name="l00520"></a>00520       s-&gt;append(buffer, count);
<a name="l00521"></a>00521       s-&gt;append(terminal_format::reset());
<a name="l00522"></a>00522       write_stdout(s, m_state);
<a name="l00523"></a>00523    }
<a name="l00524"></a>00524 }
<a name="l00525"></a>00525 
<a name="l00526"></a><a class="code" href="classsession__base.html#ae016a84a55880665d0962f8196f43014">00526</a> <span class="keywordtype">void</span> <a class="code" href="classsession__base.html#ae016a84a55880665d0962f8196f43014">session_base::add_stderr</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *buffer, <span class="keywordtype">size_t</span> count)
<a name="l00527"></a>00527 {
<a name="l00528"></a>00528    <span class="keywordflow">if</span> (m_cerr_on)
<a name="l00529"></a>00529    {
<a name="l00530"></a>00530       std::string *s = <span class="keyword">new</span> std::string();
<a name="l00531"></a>00531       s-&gt;append(terminal_format::color(<a class="code" href="namespacemoost.html#a3f1a6696186f52ee0f54afb8fdd96ee2a00fdbb7b853fa52c6a357b230c2c857d">C_RED</a>));
<a name="l00532"></a>00532       s-&gt;append(terminal_format::bold());
<a name="l00533"></a>00533       s-&gt;append(buffer, count);
<a name="l00534"></a>00534       s-&gt;append(terminal_format::reset());
<a name="l00535"></a>00535       write_stderr(s, m_state);
<a name="l00536"></a>00536    }
<a name="l00537"></a>00537 }
<a name="l00538"></a>00538 
<a name="l00539"></a>00539 <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;
<a name="l00540"></a><a class="code" href="classsession__base.html#aa939a40e4c461b345dd2361face6bdf6">00540</a> <span class="keywordtype">void</span> <a class="code" href="classsession__base.html#aa939a40e4c461b345dd2361face6bdf6">session_base::get_more_help</a>(std::ostream&amp; os, <span class="keyword">const</span> T&amp; obj)<span class="keyword"> const</span>
<a name="l00541"></a>00541 <span class="keyword"></span>{
<a name="l00542"></a>00542    std::string help;
<a name="l00543"></a>00543 
<a name="l00544"></a>00544    <span class="keywordflow">try</span>
<a name="l00545"></a>00545    {
<a name="l00546"></a>00546       help = obj.show_help();
<a name="l00547"></a>00547    }
<a name="l00548"></a>00548    <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; e)
<a name="l00549"></a>00549    {
<a name="l00550"></a>00550       help = std::string(<span class="stringliteral">&quot;exception while getting help: &quot;</span>) + e.what() + <span class="stringliteral">&quot;\r\n&quot;</span>;
<a name="l00551"></a>00551    }
<a name="l00552"></a>00552    <span class="keywordflow">catch</span> (...)
<a name="l00553"></a>00553    {
<a name="l00554"></a>00554       help = <span class="stringliteral">&quot;unknown exception while getting help\r\n&quot;</span>;
<a name="l00555"></a>00555    }
<a name="l00556"></a>00556 
<a name="l00557"></a>00557    <span class="keywordflow">if</span> (!help.empty())
<a name="l00558"></a>00558    {
<a name="l00559"></a>00559       os &lt;&lt; <span class="stringliteral">&quot;-------------------------------------------------------\r\n&quot;</span>
<a name="l00560"></a>00560          &lt;&lt; help;
<a name="l00561"></a>00561    }
<a name="l00562"></a>00562 }
<a name="l00563"></a>00563 
<a name="l00564"></a><a class="code" href="classsession__base.html#ad21d4b9bb214b12d758025ffb0ef77d6">00564</a> <span class="keywordtype">void</span> <a class="code" href="classsession__base.html#ad21d4b9bb214b12d758025ffb0ef77d6">session_base::get_help</a>(std::string&amp; rv)<span class="keyword"> const</span>
<a name="l00565"></a>00565 <span class="keyword"></span>{
<a name="l00566"></a>00566    std::ostringstream oss;
<a name="l00567"></a>00567 
<a name="l00568"></a>00568    oss &lt;&lt;    <span class="stringliteral">&quot;=======================================================\r\n&quot;</span>
<a name="l00569"></a>00569              <span class="stringliteral">&quot;- help              show this help\r\n&quot;</span>;
<a name="l00570"></a>00570 
<a name="l00571"></a>00571    <span class="keywordflow">if</span> (m_enable_cout_cerr)
<a name="l00572"></a>00572    {
<a name="l00573"></a>00573       oss &lt;&lt; <span class="stringliteral">&quot;- cout [on|off]     get [set] stdout &quot;</span> &lt;&lt; (m_cout_on ? <span class="stringliteral">&quot;&lt;ON&gt;/off&quot;</span> : <span class="stringliteral">&quot;on/&lt;OFF&gt;&quot;</span>) &lt;&lt; <span class="stringliteral">&quot;\r\n&quot;</span>
<a name="l00574"></a>00574              <span class="stringliteral">&quot;- cerr [on|off]     get [set] stderr &quot;</span> &lt;&lt; (m_cerr_on ? <span class="stringliteral">&quot;&lt;ON&gt;/off&quot;</span> : <span class="stringliteral">&quot;on/&lt;OFF&gt;&quot;</span>) &lt;&lt; <span class="stringliteral">&quot;\r\n&quot;</span>;
<a name="l00575"></a>00575    }
<a name="l00576"></a>00576 
<a name="l00577"></a>00577    oss &lt;&lt;    <span class="stringliteral">&quot;- sessions          show shell sessions\r\n&quot;</span>;
<a name="l00578"></a>00578 
<a name="l00579"></a>00579    <span class="keywordflow">if</span> (m_enable_cls)
<a name="l00580"></a>00580    {
<a name="l00581"></a>00581       oss &lt;&lt; <span class="stringliteral">&quot;- clear|cls         clear screen\r\n&quot;</span>;
<a name="l00582"></a>00582    }
<a name="l00583"></a>00583 
<a name="l00584"></a>00584    <span class="keywordflow">if</span> (m_allow_quit)
<a name="l00585"></a>00585    {
<a name="l00586"></a>00586       oss &lt;&lt; <span class="stringliteral">&quot;- quit|exit|bye     quit this connection\r\n&quot;</span>;
<a name="l00587"></a>00587    }
<a name="l00588"></a>00588 
<a name="l00589"></a>00589    oss &lt;&lt;    <span class="stringliteral">&quot;- shutdown          shut down application\r\n&quot;</span>;
<a name="l00590"></a>00590 
<a name="l00591"></a>00591    get_more_help(oss, *m_app);
<a name="l00592"></a>00592    get_more_help(oss, *m_rsi);
<a name="l00593"></a>00593 
<a name="l00594"></a>00594    oss &lt;&lt;    <span class="stringliteral">&quot;=======================================================\r\n&quot;</span>;
<a name="l00595"></a>00595 
<a name="l00596"></a>00596    rv = oss.str();
<a name="l00597"></a>00597 }
<a name="l00598"></a>00598 
<a name="l00599"></a><a class="code" href="classsession__base.html#ad4e60c36d5bb15e4c494c0499fcbd07a">00599</a> <span class="keywordtype">void</span> <a class="code" href="classsession__base.html#ad4e60c36d5bb15e4c494c0499fcbd07a">session_base::on_write_done</a>(std::string *s, <a class="code" href="classsession__base.html#aa7c540c939b5373e7735e857dc4ebdcc">state</a> st, <span class="keyword">const</span> system::error_code&amp; error)
<a name="l00600"></a>00600 {
<a name="l00601"></a>00601    <span class="keywordflow">if</span> (st &gt; m_state)
<a name="l00602"></a>00602    {
<a name="l00603"></a>00603       m_state = st;
<a name="l00604"></a>00604    }
<a name="l00605"></a>00605 
<a name="l00606"></a>00606    <span class="keyword">delete</span> s;
<a name="l00607"></a>00607 
<a name="l00608"></a>00608    <span class="keywordflow">if</span> (!error)
<a name="l00609"></a>00609    {
<a name="l00610"></a>00610       <span class="keywordflow">switch</span> (m_state)
<a name="l00611"></a>00611       {
<a name="l00612"></a>00612          <span class="keywordflow">case</span> SESSION_ATTACHED:
<a name="l00613"></a>00613             <span class="keywordflow">break</span>;
<a name="l00614"></a>00614 
<a name="l00615"></a>00615          <span class="keywordflow">case</span> SESSION_STOPPING:
<a name="l00616"></a>00616             handle_stop();
<a name="l00617"></a>00617             <span class="keywordflow">break</span>;
<a name="l00618"></a>00618 
<a name="l00619"></a>00619          <span class="keywordflow">default</span>:
<a name="l00620"></a>00620             handle_stop();
<a name="l00621"></a>00621             <span class="keywordflow">break</span>;
<a name="l00622"></a>00622       }
<a name="l00623"></a>00623    }
<a name="l00624"></a>00624    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!is_stopped())
<a name="l00625"></a>00625    {
<a name="l00626"></a>00626       handle_stop();
<a name="l00627"></a>00627    }
<a name="l00628"></a>00628 }
<a name="l00629"></a>00629 
<a name="l00630"></a><a class="code" href="classsession__base.html#ad682393482519d03255b3b7545a62cd4">00630</a> <span class="keywordtype">void</span> <a class="code" href="classsession__base.html#ad682393482519d03255b3b7545a62cd4">session_base::on_read_done</a>(<span class="keyword">const</span> system::error_code&amp; error, <span class="keywordtype">size_t</span> bytes_transferred)
<a name="l00631"></a>00631 {
<a name="l00632"></a>00632    <span class="keywordflow">if</span> (error)
<a name="l00633"></a>00633    {
<a name="l00634"></a>00634       handle_stop();
<a name="l00635"></a>00635       <span class="keywordflow">return</span>;
<a name="l00636"></a>00636    }
<a name="l00637"></a>00637 
<a name="l00638"></a>00638    m_inbuf.append(m_data, bytes_transferred);
<a name="l00639"></a>00639 
<a name="l00640"></a>00640    process_input();
<a name="l00641"></a>00641 }
<a name="l00642"></a>00642 
<a name="l00643"></a><a class="code" href="classsession__base.html#a0cbfcdd61abd38f499c8e3f32240fc5c">00643</a> <span class="keywordtype">void</span> <a class="code" href="classsession__base.html#a0cbfcdd61abd38f499c8e3f32240fc5c">session_base::process_input</a>()
<a name="l00644"></a>00644 {
<a name="l00645"></a>00645    <span class="keywordflow">while</span> (m_processing_input)
<a name="l00646"></a>00646    {
<a name="l00647"></a>00647       std::string cmd, args;
<a name="l00648"></a>00648 
<a name="l00649"></a>00649       <span class="keywordflow">if</span> (!read_next_command(cmd, args))
<a name="l00650"></a>00650       {
<a name="l00651"></a>00651          read_more();
<a name="l00652"></a>00652          <span class="keywordflow">return</span>;
<a name="l00653"></a>00653       }
<a name="l00654"></a>00654 
<a name="l00655"></a>00655       <span class="keywordflow">if</span> (cmd.empty())
<a name="l00656"></a>00656       {
<a name="l00657"></a>00657          continue_session();
<a name="l00658"></a>00658       }
<a name="l00659"></a>00659       <span class="keywordflow">else</span>
<a name="l00660"></a>00660       {
<a name="l00661"></a>00661          std::string rv;
<a name="l00662"></a>00662 
<a name="l00663"></a>00663          <span class="keywordflow">if</span> (handle_command(rv, cmd, args))
<a name="l00664"></a>00664          {
<a name="l00665"></a>00665             continue_session(rv);
<a name="l00666"></a>00666          }
<a name="l00667"></a>00667          <span class="keywordflow">else</span>
<a name="l00668"></a>00668          {
<a name="l00669"></a>00669             <span class="comment">/*</span>
<a name="l00670"></a>00670 <span class="comment">             *  This is either a service command, or an unknown command.</span>
<a name="l00671"></a>00671 <span class="comment">             *  (Only the service can tell for sure, unfortunately.)</span>
<a name="l00672"></a>00672 <span class="comment">             *  In any case, it potentially accesses a global resource which</span>
<a name="l00673"></a>00673 <span class="comment">             *  may not be accessed concurrently from multiple shell sessions.</span>
<a name="l00674"></a>00674 <span class="comment">             *  Thus, we route the request through the server who will queue</span>
<a name="l00675"></a>00675 <span class="comment">             *  all service commands and process them sequentially in a</span>
<a name="l00676"></a>00676 <span class="comment">             *  separate thread in order to avoid blocking of the clients.</span>
<a name="l00677"></a>00677 <span class="comment">             */</span>
<a name="l00678"></a>00678 
<a name="l00679"></a>00679             m_processing_input = <span class="keyword">false</span>;
<a name="l00680"></a>00680 
<a name="l00681"></a>00681             m_srv.process_command(shared_from_this(), cmd, args);
<a name="l00682"></a>00682          }
<a name="l00683"></a>00683       }
<a name="l00684"></a>00684    }
<a name="l00685"></a>00685 }
<a name="l00686"></a>00686 
<a name="l00687"></a><a class="code" href="classsession__base.html#a112c2a447f0c1c9bc9d2dc135f34e2f5">00687</a> <span class="keywordtype">void</span> <a class="code" href="classsession__base.html#a112c2a447f0c1c9bc9d2dc135f34e2f5">session_base::command_result</a>(<span class="keywordtype">bool</span> handled, <span class="keyword">const</span> std::string&amp; cmd, <span class="keyword">const</span> std::string&amp; rv)
<a name="l00688"></a>00688 {
<a name="l00689"></a>00689    <span class="keywordflow">if</span> (handled)
<a name="l00690"></a>00690    {
<a name="l00691"></a>00691       continue_session(rv);
<a name="l00692"></a>00692    }
<a name="l00693"></a>00693    <span class="keywordflow">else</span>
<a name="l00694"></a>00694    {
<a name="l00695"></a>00695       continue_session(<span class="stringliteral">&quot;unknown command: &quot;</span> + cmd);
<a name="l00696"></a>00696    }
<a name="l00697"></a>00697 
<a name="l00698"></a>00698    m_processing_input = <span class="keyword">true</span>;
<a name="l00699"></a>00699 
<a name="l00700"></a>00700    process_input();
<a name="l00701"></a>00701 }
<a name="l00702"></a>00702 
<a name="l00703"></a><a class="code" href="classsession__base.html#ad6937f6bb5544c5a1bb5477c5036e653">00703</a> <span class="keywordtype">void</span> <a class="code" href="classsession__base.html#ad6937f6bb5544c5a1bb5477c5036e653">session_base::continue_session</a>(<span class="keyword">const</span> std::string&amp; str)
<a name="l00704"></a>00704 {
<a name="l00705"></a>00705    <span class="keywordflow">if</span> (!is_stopped())
<a name="l00706"></a>00706    {
<a name="l00707"></a>00707       std::ostringstream oss;
<a name="l00708"></a>00708 
<a name="l00709"></a>00709       oss &lt;&lt; str;
<a name="l00710"></a>00710 
<a name="l00711"></a>00711       <span class="keywordflow">if</span> (!str.empty() &amp;&amp; str[str.length() - 1] != <span class="charliteral">&#39;\n&#39;</span>)
<a name="l00712"></a>00712       {
<a name="l00713"></a>00713          oss &lt;&lt; <span class="stringliteral">&quot;\r\n&quot;</span>;
<a name="l00714"></a>00714       }
<a name="l00715"></a>00715 
<a name="l00716"></a>00716       <span class="keywordflow">try</span>
<a name="l00717"></a>00717       {
<a name="l00718"></a>00718          oss &lt;&lt; m_rsi-&gt;get_prompt();
<a name="l00719"></a>00719       }
<a name="l00720"></a>00720       <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; e)
<a name="l00721"></a>00721       {
<a name="l00722"></a>00722          oss &lt;&lt; <span class="stringliteral">&quot;(exception while getting prompt: &quot;</span> &lt;&lt; e.what() &lt;&lt; <span class="stringliteral">&quot;)&gt; &quot;</span>;
<a name="l00723"></a>00723       }
<a name="l00724"></a>00724       <span class="keywordflow">catch</span> (...)
<a name="l00725"></a>00725       {
<a name="l00726"></a>00726          oss &lt;&lt; <span class="stringliteral">&quot;(unknown exception while getting prompt)&gt; &quot;</span>;
<a name="l00727"></a>00727       }
<a name="l00728"></a>00728 
<a name="l00729"></a>00729       write(oss.str());
<a name="l00730"></a>00730    }
<a name="l00731"></a>00731 }
<a name="l00732"></a>00732 
<a name="l00733"></a><a class="code" href="classsession__base.html#ab16474cfd61c57b553ddc7694585ee53">00733</a> <span class="keywordtype">void</span> <a class="code" href="classsession__base.html#ab16474cfd61c57b553ddc7694585ee53">session_base::handle_stop</a>()
<a name="l00734"></a>00734 {
<a name="l00735"></a>00735    <span class="keywordflow">if</span> (!is_stopped())
<a name="l00736"></a>00736    {
<a name="l00737"></a>00737       close();
<a name="l00738"></a>00738 
<a name="l00739"></a>00739       <span class="keywordflow">if</span> (is_attached())
<a name="l00740"></a>00740       {
<a name="l00741"></a>00741          m_app-&gt;detach();
<a name="l00742"></a>00742       }
<a name="l00743"></a>00743 
<a name="l00744"></a>00744       m_cerr_on = m_cout_on = <span class="keyword">false</span>;
<a name="l00745"></a>00745 
<a name="l00746"></a>00746       m_state = SESSION_STOPPED;
<a name="l00747"></a>00747 
<a name="l00748"></a>00748       m_srv.remove_session(shared_from_this());
<a name="l00749"></a>00749    }
<a name="l00750"></a>00750 }
<a name="l00751"></a>00751 
<a name="l00752"></a><a class="code" href="classsession__base.html#a01459a9b7afcd3b7f99a17e7886b65c3">00752</a> <span class="keywordtype">bool</span> <a class="code" href="classsession__base.html#a01459a9b7afcd3b7f99a17e7886b65c3">session_base::handle_command</a>(std::string&amp; rv, <span class="keyword">const</span> std::string&amp; cmd, <span class="keyword">const</span> std::string&amp; args)
<a name="l00753"></a>00753 {
<a name="l00754"></a>00754    <span class="keywordflow">if</span> (m_allow_quit &amp;&amp; (cmd == <span class="stringliteral">&quot;exit&quot;</span> || cmd == <span class="stringliteral">&quot;quit&quot;</span> || cmd == <span class="stringliteral">&quot;bye&quot;</span>))
<a name="l00755"></a>00755    {
<a name="l00756"></a>00756       handle_stop();
<a name="l00757"></a>00757    }
<a name="l00758"></a>00758    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd == <span class="stringliteral">&quot;shutdown&quot;</span>)
<a name="l00759"></a>00759    {
<a name="l00760"></a>00760       m_srv.stop(<span class="stringliteral">&quot;*** shutdown initiated by &quot;</span> + m_peer + <span class="stringliteral">&quot; ***\r\n&quot;</span>);
<a name="l00761"></a>00761    }
<a name="l00762"></a>00762    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (m_enable_cout_cerr &amp;&amp; (cmd == <span class="stringliteral">&quot;cerr&quot;</span> || cmd == <span class="stringliteral">&quot;cout&quot;</span>))
<a name="l00763"></a>00763    {
<a name="l00764"></a>00764       <span class="keywordtype">bool</span> *var = cmd == <span class="stringliteral">&quot;cerr&quot;</span> ? &amp;m_cerr_on : &amp;m_cout_on;
<a name="l00765"></a>00765 
<a name="l00766"></a>00766       <span class="keywordflow">if</span> (args == <span class="stringliteral">&quot;on&quot;</span>)
<a name="l00767"></a>00767       {
<a name="l00768"></a>00768          *var = <span class="keyword">true</span>;
<a name="l00769"></a>00769       }
<a name="l00770"></a>00770       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (args == <span class="stringliteral">&quot;off&quot;</span>)
<a name="l00771"></a>00771       {
<a name="l00772"></a>00772          *var = <span class="keyword">false</span>;
<a name="l00773"></a>00773       }
<a name="l00774"></a>00774       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (args != <span class="stringliteral">&quot;&quot;</span>)
<a name="l00775"></a>00775       {
<a name="l00776"></a>00776          rv = <span class="stringliteral">&quot;invalid argument for &quot;</span> + cmd;
<a name="l00777"></a>00777          <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00778"></a>00778       }
<a name="l00779"></a>00779 
<a name="l00780"></a>00780       rv = cmd + <span class="stringliteral">&quot; set to [&quot;</span> + (*var ? <span class="stringliteral">&quot;on&quot;</span> : <span class="stringliteral">&quot;off&quot;</span>) + <span class="stringliteral">&quot;]&quot;</span>;
<a name="l00781"></a>00781    }
<a name="l00782"></a>00782    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd == <span class="stringliteral">&quot;help&quot;</span>)
<a name="l00783"></a>00783    {
<a name="l00784"></a>00784       get_help(rv);
<a name="l00785"></a>00785    }
<a name="l00786"></a>00786    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (m_enable_cls &amp;&amp; (cmd == <span class="stringliteral">&quot;clear&quot;</span> || cmd == <span class="stringliteral">&quot;cls&quot;</span>))
<a name="l00787"></a>00787    {
<a name="l00788"></a>00788       rv = <span class="stringliteral">&quot;\033[2J\033[H&quot;</span>;
<a name="l00789"></a>00789    }
<a name="l00790"></a>00790    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd == <span class="stringliteral">&quot;sessions&quot;</span>)
<a name="l00791"></a>00791    {
<a name="l00792"></a>00792       m_srv.get_sessions_list(rv);
<a name="l00793"></a>00793    }
<a name="l00794"></a>00794    <span class="keywordflow">else</span>
<a name="l00795"></a>00795    {
<a name="l00796"></a>00796       <span class="keywordflow">try</span>
<a name="l00797"></a>00797       {
<a name="l00798"></a>00798          <span class="keywordflow">return</span> m_app-&gt;handle_command(rv, cmd, args);
<a name="l00799"></a>00799       }
<a name="l00800"></a>00800       <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; e)
<a name="l00801"></a>00801       {
<a name="l00802"></a>00802          rv = <span class="stringliteral">&quot;exception while running appender command &quot;</span> + cmd + <span class="stringliteral">&quot;: &quot;</span> + e.what();
<a name="l00803"></a>00803       }
<a name="l00804"></a>00804       <span class="keywordflow">catch</span> (...)
<a name="l00805"></a>00805       {
<a name="l00806"></a>00806          rv = <span class="stringliteral">&quot;unknown exception while running appender command &quot;</span> + cmd;
<a name="l00807"></a>00807       }
<a name="l00808"></a>00808    }
<a name="l00809"></a>00809 
<a name="l00810"></a>00810    <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00811"></a>00811 }
<a name="l00812"></a>00812 
<a name="l00813"></a><a class="code" href="classsession__base.html#a01fc845c7751711723aaa7df94f33448">00813</a> <span class="keywordtype">bool</span> <a class="code" href="classsession__base.html#a01fc845c7751711723aaa7df94f33448">session_base::read_next_command</a>(std::string&amp; cmd, std::string&amp; args)
<a name="l00814"></a>00814 {
<a name="l00815"></a>00815    <span class="comment">// do we have a full line?</span>
<a name="l00816"></a>00816 
<a name="l00817"></a>00817    std::string::size_type pos = m_inbuf.find(<span class="charliteral">&#39;\n&#39;</span>);
<a name="l00818"></a>00818 
<a name="l00819"></a>00819    <span class="keywordflow">if</span> (pos == m_inbuf.npos)
<a name="l00820"></a>00820    {
<a name="l00821"></a>00821       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00822"></a>00822    }
<a name="l00823"></a>00823 
<a name="l00824"></a>00824    <span class="comment">// strip comments</span>
<a name="l00825"></a>00825 
<a name="l00826"></a>00826    std::string::size_type cpos = m_inbuf.find(<span class="charliteral">&#39;#&#39;</span>);
<a name="l00827"></a>00827 
<a name="l00828"></a>00828    <span class="keywordflow">if</span> (cpos != m_inbuf.npos &amp;&amp; cpos &lt; pos)
<a name="l00829"></a>00829    {
<a name="l00830"></a>00830       m_inbuf.replace(cpos, pos - cpos, <span class="stringliteral">&quot;&quot;</span>, 0);
<a name="l00831"></a>00831       pos = cpos;
<a name="l00832"></a>00832    }
<a name="l00833"></a>00833 
<a name="l00834"></a>00834    <span class="comment">// parse command and arguments</span>
<a name="l00835"></a>00835 
<a name="l00836"></a>00836    std::istringstream iss(m_inbuf);
<a name="l00837"></a>00837 
<a name="l00838"></a>00838    m_inbuf.replace(0, pos + 1, <span class="stringliteral">&quot;&quot;</span>, 0);
<a name="l00839"></a>00839 
<a name="l00840"></a>00840    iss &gt;&gt; cmd;
<a name="l00841"></a>00841 
<a name="l00842"></a>00842    getline(iss, args);
<a name="l00843"></a>00843    trim(args);
<a name="l00844"></a>00844 
<a name="l00845"></a>00845    <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00846"></a>00846 }
<a name="l00847"></a>00847 
<a name="l00848"></a>00848 <span class="comment">/**********************************************************************/</span>
<a name="l00849"></a>00849 
<a name="l00850"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a93c11c95e5e363c8731825ff72b3157f">00850</a> remote_shell_server_impl::remote_shell_server_impl(shared_ptr&lt;asio::io_service&gt; ios)
<a name="l00851"></a>00851    : m_ios(ios)
<a name="l00852"></a>00852    , m_app_factory(new <a class="code" href="classmoost_1_1service_1_1null__appender__factory.html" title="A factory for appenders that do nothing.">null_appender_factory</a>)
<a name="l00853"></a>00853 #ifdef BOOST_ASIO_HAS_POSIX_STREAM_DESCRIPTOR
<a name="l00854"></a>00854    , m_stdout(*ios)
<a name="l00855"></a>00855    , m_stderr(*ios)
<a name="l00856"></a>00856 #endif
<a name="l00857"></a>00857    , m_default_stdout_state(true)
<a name="l00858"></a>00858    , m_default_stderr_state(true)
<a name="l00859"></a>00859    , m_enable_local(false)
<a name="l00860"></a>00860    , m_can_snoop_stdio(false)
<a name="l00861"></a>00861    , m_listen_port(0)
<a name="l00862"></a>00862    , m_pre_shutdown_func(<a class="code" href="structmoost_1_1service_1_1remote__shell__server__impl_1_1noop__pre__shutdown__func.html">noop_pre_shutdown_func</a>())
<a name="l00863"></a>00863 {
<a name="l00864"></a>00864 }
<a name="l00865"></a>00865 
<a name="l00866"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#ab24add8a63301b9bd9667198784b4262">00866</a> <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#ab24add8a63301b9bd9667198784b4262">remote_shell_server_impl::~remote_shell_server_impl</a>()
<a name="l00867"></a>00867 {
<a name="l00868"></a>00868 }
<a name="l00869"></a>00869 
<a name="l00870"></a>00870 <span class="preprocessor">#ifdef BOOST_ASIO_HAS_POSIX_STREAM_DESCRIPTOR</span>
<a name="l00871"></a>00871 <span class="preprocessor"></span><span class="keywordtype">bool</span> remote_shell_server_impl::snoop_stdio(<a class="code" href="classmoost_1_1service_1_1posix__stream__stealer.html">posix_stream_stealer</a>&amp; stealer, FILE *stream, stdstream *bsd, <a class="code" href="remote__shell_8cpp.html#aa3d46611a84a915d852c8990e0c58250">session_meth</a> cb)
<a name="l00872"></a>00872 {
<a name="l00873"></a>00873    <span class="keywordflow">if</span> (!stealer.<a class="code" href="classmoost_1_1service_1_1posix__stream__stealer.html#a9bbd8fcc2ef3bf59bcd226029eb77de1">steal</a>(stream))
<a name="l00874"></a>00874    {
<a name="l00875"></a>00875       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00876"></a>00876    }
<a name="l00877"></a>00877 
<a name="l00878"></a>00878    bsd-&gt;assign(stealer.<a class="code" href="classmoost_1_1service_1_1posix__stream__stealer.html#aad30f1d473bf7268f2ffb2f11f3093c4">get_pipe_fd</a>());
<a name="l00879"></a>00879 
<a name="l00880"></a>00880    stdio_read_more(bsd, cb, <span class="keyword">new</span> <span class="keywordtype">char</span>[BUFSIZ]);
<a name="l00881"></a>00881 
<a name="l00882"></a>00882    <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00883"></a>00883 }
<a name="l00884"></a>00884 
<a name="l00885"></a>00885 <span class="keywordtype">void</span> remote_shell_server_impl::on_stdio_read(stdstream *bsd, <a class="code" href="remote__shell_8cpp.html#aa3d46611a84a915d852c8990e0c58250">session_meth</a> cb, <span class="keyword">const</span> system::error_code&amp; error, <span class="keywordtype">char</span> *buffer, <span class="keywordtype">size_t</span> count)
<a name="l00886"></a>00886 {
<a name="l00887"></a>00887    <span class="keywordflow">if</span> (error)
<a name="l00888"></a>00888    {
<a name="l00889"></a>00889       <span class="keyword">delete</span>[] buffer;
<a name="l00890"></a>00890       <span class="keywordflow">return</span>;
<a name="l00891"></a>00891    }
<a name="l00892"></a>00892 
<a name="l00893"></a>00893    <span class="keywordflow">foreach</span>(<a class="code" href="remote__shell_8cpp.html#a629b1eda6a29b9b070c429c5bbac0c86">session_ptr</a> s, <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#af9b9b3d8e5b01da581c8efb60bfc7e0a">m_sessions</a>)
<a name="l00894"></a>00894    {
<a name="l00895"></a>00895       (s.get()-&gt;*cb)(buffer, count);
<a name="l00896"></a>00896    }
<a name="l00897"></a>00897 
<a name="l00898"></a>00898    stdio_read_more(bsd, cb, buffer);
<a name="l00899"></a>00899 }
<a name="l00900"></a>00900 
<a name="l00901"></a>00901 <span class="keywordtype">void</span> remote_shell_server_impl::stdio_read_more(stdstream *bsd, <a class="code" href="remote__shell_8cpp.html#aa3d46611a84a915d852c8990e0c58250">session_meth</a> cb, <span class="keywordtype">char</span> *buffer)
<a name="l00902"></a>00902 {
<a name="l00903"></a>00903    bsd-&gt;async_read_some(asio::buffer(buffer, BUFSIZ),
<a name="l00904"></a>00904        bind(&amp;remote_shell_server_impl::on_stdio_read, <span class="keyword">this</span>, bsd, cb,
<a name="l00905"></a>00905          asio::placeholders::error, buffer, asio::placeholders::bytes_transferred));
<a name="l00906"></a>00906 }
<a name="l00907"></a>00907 <span class="preprocessor">#endif</span>
<a name="l00908"></a>00908 <span class="preprocessor"></span>
<a name="l00909"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#aa1db66bd4e58dcd0d4b70c785629d074">00909</a> <span class="keywordtype">bool</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#aa1db66bd4e58dcd0d4b70c785629d074">remote_shell_server_impl::setup_stdio_snoopers</a>()
<a name="l00910"></a>00910 {
<a name="l00911"></a>00911 <span class="preprocessor">#ifdef BOOST_ASIO_HAS_POSIX_STREAM_DESCRIPTOR</span>
<a name="l00912"></a>00912 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (!snoop_stdio(m_stdout_stealer, stdout, &amp;m_stdout, &amp;<a class="code" href="classsession__base.html#a7f5cb18985211f953a8696fba35deb53">session_base::add_stdout</a>) ||
<a name="l00913"></a>00913        !snoop_stdio(m_stderr_stealer, stderr, &amp;m_stderr, &amp;<a class="code" href="classsession__base.html#ae016a84a55880665d0962f8196f43014">session_base::add_stderr</a>))
<a name="l00914"></a>00914    {
<a name="l00915"></a>00915       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00916"></a>00916    }
<a name="l00917"></a>00917 
<a name="l00918"></a>00918    <span class="comment">// make sure our stolen streams behave like &quot;standard&quot; stdout/stderr</span>
<a name="l00919"></a>00919    setvbuf(stdout, NULL, _IOLBF, 0);
<a name="l00920"></a>00920    setvbuf(stderr, NULL, _IONBF, 0);
<a name="l00921"></a>00921 
<a name="l00922"></a>00922    <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00923"></a>00923 <span class="preprocessor">#else</span>
<a name="l00924"></a>00924 <span class="preprocessor"></span>   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00925"></a>00925 <span class="preprocessor">#endif</span>
<a name="l00926"></a>00926 <span class="preprocessor"></span>}
<a name="l00927"></a>00927 
<a name="l00928"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a85e3e3bedc501afc9a7bcfe6a7353e16">00928</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a85e3e3bedc501afc9a7bcfe6a7353e16">remote_shell_server_impl::teardown_stdio_snoopers</a>()
<a name="l00929"></a>00929 {
<a name="l00930"></a>00930 <span class="preprocessor">#ifdef BOOST_ASIO_HAS_POSIX_STREAM_DESCRIPTOR</span>
<a name="l00931"></a>00931 <span class="preprocessor"></span>   m_stdout_stealer.restore();
<a name="l00932"></a>00932    m_stdout.close();
<a name="l00933"></a>00933    m_stderr_stealer.restore();
<a name="l00934"></a>00934    m_stderr.close();
<a name="l00935"></a>00935 <span class="preprocessor">#endif</span>
<a name="l00936"></a>00936 <span class="preprocessor"></span>}
<a name="l00937"></a>00937 
<a name="l00938"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a6f043a4b6a946cbe934b4e450486ded5">00938</a> <span class="keywordtype">bool</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a6f043a4b6a946cbe934b4e450486ded5">remote_shell_server_impl::create_console_session</a>(<a class="code" href="classmoost_1_1service_1_1remote__shell__iface.html" title="Interface for remote command shell.">remote_shell_iface</a> *rsi, <a class="code" href="remote__shell_8cpp.html#a629b1eda6a29b9b070c429c5bbac0c86">session_ptr</a>&amp; new_session, <a class="code" href="namespacemoost_1_1service.html#ad882f294c163791c4fb5dd2955e2d451">stream_writer_ptr</a>&amp; writer)
<a name="l00939"></a>00939 {
<a name="l00940"></a>00940 <span class="preprocessor">#if defined(BOOST_ASIO_HAS_POSIX_STREAM_DESCRIPTOR) &amp;&amp; defined(_POSIX_SOURCE)</span>
<a name="l00941"></a>00941 <span class="preprocessor"></span>
<a name="l00942"></a>00942    <span class="keywordtype">int</span> orig_in_fd = ::fileno(stdin);
<a name="l00943"></a>00943 
<a name="l00944"></a>00944    <span class="keywordflow">if</span> (orig_in_fd == -1)
<a name="l00945"></a>00945    {
<a name="l00946"></a>00946       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00947"></a>00947    }
<a name="l00948"></a>00948 
<a name="l00949"></a>00949    <span class="keywordtype">int</span> input_fd = ::dup(orig_in_fd);
<a name="l00950"></a>00950 
<a name="l00951"></a>00951    <span class="keywordflow">if</span> (input_fd == -1)
<a name="l00952"></a>00952    {
<a name="l00953"></a>00953       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00954"></a>00954    }
<a name="l00955"></a>00955 
<a name="l00956"></a>00956    <span class="comment">// set up console session</span>
<a name="l00957"></a>00957    shared_ptr&lt;session_io_console&gt; io(<span class="keyword">new</span> <a class="code" href="classsession__io__console.html">session_io_console</a>(<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a7a517e1e3a821c32a7159480fd26716c">m_ios</a>, input_fd,
<a name="l00958"></a>00958       m_stdout_stealer.get_backup_fd(), m_stderr_stealer.get_backup_fd(), <span class="stringliteral">&quot;local console&quot;</span>));
<a name="l00959"></a>00959 
<a name="l00960"></a>00960    new_session.reset(<span class="keyword">new</span> <a class="code" href="classsession.html">session&lt;session_io_console, false, true&gt;</a>(*<span class="keyword">this</span>, rsi, io, <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#ab1f8b84d3dba6e156a1e7521324aac31">m_can_snoop_stdio</a>));
<a name="l00961"></a>00961 
<a name="l00962"></a>00962    writer.reset(<span class="keyword">new</span> <a class="code" href="classsession__writer.html">session_writer&lt;session_io_console&gt;</a>(io));
<a name="l00963"></a>00963 
<a name="l00964"></a>00964    <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00965"></a>00965 
<a name="l00966"></a>00966 <span class="preprocessor">#elif defined(BOOST_ASIO_HAS_WINDOWS_STREAM_HANDLE) &amp;&amp; defined(_WIN32)</span>
<a name="l00967"></a>00967 <span class="preprocessor"></span>
<a name="l00968"></a>00968    HANDLE in_hd = ::GetStdHandle(STD_INPUT_HANDLE);
<a name="l00969"></a>00969    HANDLE out_hd = ::GetStdHandle(STD_OUTPUT_HANDLE);
<a name="l00970"></a>00970    HANDLE err_hd = ::GetStdHandle(STD_ERROR_HANDLE);
<a name="l00971"></a>00971 
<a name="l00972"></a>00972    <span class="keywordflow">if</span> (in_hd == INVALID_HANDLE_VALUE ||
<a name="l00973"></a>00973        out_hd == INVALID_HANDLE_VALUE ||
<a name="l00974"></a>00974        err_hd == INVALID_HANDLE_VALUE)
<a name="l00975"></a>00975    {
<a name="l00976"></a>00976       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00977"></a>00977    }
<a name="l00978"></a>00978 
<a name="l00979"></a>00979    <span class="comment">// set up console session</span>
<a name="l00980"></a>00980    shared_ptr&lt;session_io_console&gt; io(<span class="keyword">new</span> <a class="code" href="classsession__io__console.html">session_io_console</a>(<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a7a517e1e3a821c32a7159480fd26716c">m_ios</a>, in_hd, out_hd, err_hd, <span class="stringliteral">&quot;local console&quot;</span>));
<a name="l00981"></a>00981 
<a name="l00982"></a>00982    new_session.reset(<span class="keyword">new</span> <a class="code" href="classsession.html">session&lt;session_io_console, false, false&gt;</a>(*<span class="keyword">this</span>, rsi, io, <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#ab1f8b84d3dba6e156a1e7521324aac31">m_can_snoop_stdio</a>));
<a name="l00983"></a>00983 
<a name="l00984"></a>00984    writer.reset(<span class="keyword">new</span> <a class="code" href="classsession__writer.html">session_writer&lt;session_io_console&gt;</a>(io));
<a name="l00985"></a>00985 
<a name="l00986"></a>00986    <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00987"></a>00987 
<a name="l00988"></a>00988 <span class="preprocessor">#else</span>
<a name="l00989"></a>00989 <span class="preprocessor"></span>
<a name="l00990"></a>00990    <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00991"></a>00991 
<a name="l00992"></a>00992 <span class="preprocessor">#endif</span>
<a name="l00993"></a>00993 <span class="preprocessor"></span>}
<a name="l00994"></a>00994 
<a name="l00995"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a9a1f5b9c525594c9037ee16f8b68dedf">00995</a> <span class="keywordtype">bool</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a9a1f5b9c525594c9037ee16f8b68dedf">remote_shell_server_impl::setup_console_session</a>(<a class="code" href="classmoost_1_1service_1_1remote__shell__iface.html" title="Interface for remote command shell.">remote_shell_iface</a> *rsi)
<a name="l00996"></a>00996 {
<a name="l00997"></a>00997    <a class="code" href="remote__shell_8cpp.html#a629b1eda6a29b9b070c429c5bbac0c86">session_ptr</a> <a class="code" href="classsession.html">session</a>;
<a name="l00998"></a>00998    <a class="code" href="namespacemoost_1_1service.html#ad882f294c163791c4fb5dd2955e2d451">stream_writer_ptr</a> writer;
<a name="l00999"></a>00999 
<a name="l01000"></a>01000    <span class="keywordflow">if</span> (!<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a6f043a4b6a946cbe934b4e450486ded5">create_console_session</a>(rsi, session, writer))
<a name="l01001"></a>01001    {
<a name="l01002"></a>01002       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01003"></a>01003    }
<a name="l01004"></a>01004 
<a name="l01005"></a>01005    session-&gt;<a class="code" href="classsession__base.html#a673f6406c5cefb2493c1bcbc77fc890a">set_stdout_state</a>(<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a711a4150bdef6abad44301fe1e9d1b3e">m_default_stdout_state</a>);
<a name="l01006"></a>01006    session-&gt;set_stderr_state(<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#ad291c3588da210155c8ec9fa417c770c">m_default_stderr_state</a>);
<a name="l01007"></a>01007 
<a name="l01008"></a>01008    <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#af9b9b3d8e5b01da581c8efb60bfc7e0a">m_sessions</a>.insert(session);
<a name="l01009"></a>01009 
<a name="l01010"></a>01010    session-&gt;start(<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a43cbd23f719d53bc9cfefafaadfad9df">m_app_factory</a>-&gt;create(writer));
<a name="l01011"></a>01011 
<a name="l01012"></a>01012    <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01013"></a>01013 }
<a name="l01014"></a>01014 
<a name="l01015"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a9ffef4c6c97ea53c0f0097fd22f4c4bc">01015</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a9ffef4c6c97ea53c0f0097fd22f4c4bc">remote_shell_server_impl::stop</a>(<span class="keyword">const</span> std::string&amp; msg)
<a name="l01016"></a>01016 {
<a name="l01017"></a>01017    <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a7a517e1e3a821c32a7159480fd26716c">m_ios</a>-&gt;post(bind(&amp;<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a76b1fe0807221efb714f85515b260454">remote_shell_server_impl::handle_stop</a>, <span class="keyword">this</span>, msg));
<a name="l01018"></a>01018 }
<a name="l01019"></a>01019 
<a name="l01020"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a10e9272c835349c95d17f950c9057aa5">01020</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a10e9272c835349c95d17f950c9057aa5">remote_shell_server_impl::handle_accept</a>(<a class="code" href="remote__shell_8cpp.html#a0d8e8ed0b23aa3d6d1c5fd1cf02b6af3">socket_ptr</a> socket, <a class="code" href="classmoost_1_1service_1_1remote__shell__iface.html" title="Interface for remote command shell.">remote_shell_iface</a> *rsi, <span class="keyword">const</span> system::error_code&amp; error)
<a name="l01021"></a>01021 {
<a name="l01022"></a>01022    <span class="keywordflow">if</span> (!error)
<a name="l01023"></a>01023    {
<a name="l01024"></a>01024       shared_ptr&lt;session_io_socket&gt; io(<span class="keyword">new</span> <a class="code" href="classsession__io__socket.html">session_io_socket</a>(socket));
<a name="l01025"></a>01025       <a class="code" href="remote__shell_8cpp.html#a629b1eda6a29b9b070c429c5bbac0c86">session_ptr</a> new_session(<span class="keyword">new</span> <a class="code" href="classsession.html">session&lt;session_io_socket&gt;</a>(*<span class="keyword">this</span>, rsi, io, <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#ab1f8b84d3dba6e156a1e7521324aac31">m_can_snoop_stdio</a>));
<a name="l01026"></a>01026 
<a name="l01027"></a>01027       <a class="code" href="namespacemoost_1_1service.html#ad882f294c163791c4fb5dd2955e2d451">stream_writer_ptr</a> writer(<span class="keyword">new</span> <a class="code" href="classsession__writer.html">session_writer&lt;session_io_socket&gt;</a>(io));
<a name="l01028"></a>01028 
<a name="l01029"></a>01029       new_session-&gt;set_stdout_state(<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a711a4150bdef6abad44301fe1e9d1b3e">m_default_stdout_state</a>);
<a name="l01030"></a>01030       new_session-&gt;set_stderr_state(<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#ad291c3588da210155c8ec9fa417c770c">m_default_stderr_state</a>);
<a name="l01031"></a>01031 
<a name="l01032"></a>01032       <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#af9b9b3d8e5b01da581c8efb60bfc7e0a">m_sessions</a>.insert(new_session);
<a name="l01033"></a>01033 
<a name="l01034"></a>01034       new_session-&gt;start(<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a43cbd23f719d53bc9cfefafaadfad9df">m_app_factory</a>-&gt;create(writer));
<a name="l01035"></a>01035 
<a name="l01036"></a>01036       <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a0893bf11ebf40f2e5a2433bf81643b01">accept_session</a>(rsi);
<a name="l01037"></a>01037    }
<a name="l01038"></a>01038 }
<a name="l01039"></a>01039 
<a name="l01040"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a0893bf11ebf40f2e5a2433bf81643b01">01040</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a0893bf11ebf40f2e5a2433bf81643b01">remote_shell_server_impl::accept_session</a>(<a class="code" href="classmoost_1_1service_1_1remote__shell__iface.html" title="Interface for remote command shell.">remote_shell_iface</a> *rsi)
<a name="l01041"></a>01041 {
<a name="l01042"></a>01042    <a class="code" href="remote__shell_8cpp.html#a0d8e8ed0b23aa3d6d1c5fd1cf02b6af3">socket_ptr</a> socket(<span class="keyword">new</span> tcp::socket(*<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a7a517e1e3a821c32a7159480fd26716c">m_ios</a>));
<a name="l01043"></a>01043 
<a name="l01044"></a>01044    <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#acdd09ca96cbdac61b7a7baef82395a02">m_acceptor</a>-&gt;async_accept(*socket,
<a name="l01045"></a>01045        bind(&amp;<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a10e9272c835349c95d17f950c9057aa5">remote_shell_server_impl::handle_accept</a>,
<a name="l01046"></a>01046          <span class="keyword">this</span>, socket, rsi, asio::placeholders::error));
<a name="l01047"></a>01047 }
<a name="l01048"></a>01048 
<a name="l01049"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a5a6b7efb54b17c9123ea020776d6a46f">01049</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a5a6b7efb54b17c9123ea020776d6a46f">remote_shell_server_impl::remove_session</a>(<a class="code" href="remote__shell_8cpp.html#a629b1eda6a29b9b070c429c5bbac0c86">session_ptr</a> p)
<a name="l01050"></a>01050 {
<a name="l01051"></a>01051    <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#af9b9b3d8e5b01da581c8efb60bfc7e0a">m_sessions</a>.erase(p);
<a name="l01052"></a>01052 }
<a name="l01053"></a>01053 
<a name="l01054"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a76b1fe0807221efb714f85515b260454">01054</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a76b1fe0807221efb714f85515b260454">remote_shell_server_impl::handle_stop</a>(<span class="keyword">const</span> std::string&amp; msg)
<a name="l01055"></a>01055 {
<a name="l01056"></a>01056    <span class="keywordflow">if</span> (<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#acdd09ca96cbdac61b7a7baef82395a02">m_acceptor</a>)
<a name="l01057"></a>01057    {
<a name="l01058"></a>01058       <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#acdd09ca96cbdac61b7a7baef82395a02">m_acceptor</a>-&gt;close();
<a name="l01059"></a>01059    }
<a name="l01060"></a>01060 
<a name="l01061"></a>01061    <span class="keywordflow">foreach</span>(<a class="code" href="remote__shell_8cpp.html#a629b1eda6a29b9b070c429c5bbac0c86">session_ptr</a> s, <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#af9b9b3d8e5b01da581c8efb60bfc7e0a">m_sessions</a>)
<a name="l01062"></a>01062    {
<a name="l01063"></a>01063       <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a7a517e1e3a821c32a7159480fd26716c">m_ios</a>-&gt;post(bind(&amp;<a class="code" href="classsession__base.html#ac7f78aa3774326579636576f9ed0ba21">session_base::stop</a>, s, msg));
<a name="l01064"></a>01064    }
<a name="l01065"></a>01065 
<a name="l01066"></a>01066    <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a7a517e1e3a821c32a7159480fd26716c">m_ios</a>-&gt;post(bind(&amp;<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a3c1a7d829190f28d1b6cff223a5e84ec">remote_shell_server_impl::pre_shutdown</a>, <span class="keyword">this</span>));
<a name="l01067"></a>01067 }
<a name="l01068"></a>01068 
<a name="l01069"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a3c1a7d829190f28d1b6cff223a5e84ec">01069</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a3c1a7d829190f28d1b6cff223a5e84ec">remote_shell_server_impl::pre_shutdown</a>()
<a name="l01070"></a>01070 {
<a name="l01071"></a>01071    <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a85e3e3bedc501afc9a7bcfe6a7353e16">teardown_stdio_snoopers</a>();
<a name="l01072"></a>01072    <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a31910eb1e8d87951562a44cda396f32b">m_pre_shutdown_func</a>();
<a name="l01073"></a>01073 }
<a name="l01074"></a>01074 
<a name="l01075"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#aecf269727f46fc41c7d9c46125188f10">01075</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#aecf269727f46fc41c7d9c46125188f10">remote_shell_server_impl::get_sessions_list</a>(std::string&amp; rv)
<a name="l01076"></a>01076 {
<a name="l01077"></a>01077    std::ostringstream oss;
<a name="l01078"></a>01078 
<a name="l01079"></a>01079    <span class="keywordflow">foreach</span>(<a class="code" href="remote__shell_8cpp.html#a629b1eda6a29b9b070c429c5bbac0c86">session_ptr</a> s, <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#af9b9b3d8e5b01da581c8efb60bfc7e0a">m_sessions</a>)
<a name="l01080"></a>01080    {
<a name="l01081"></a>01081       oss &lt;&lt; s-&gt;get_info() &lt;&lt; <span class="stringliteral">&quot;\r\n&quot;</span>;
<a name="l01082"></a>01082    }
<a name="l01083"></a>01083 
<a name="l01084"></a>01084    rv = oss.str();
<a name="l01085"></a>01085 }
<a name="l01086"></a>01086 
<a name="l01087"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a629cc68c1688d84043ec9ba13209a098">01087</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a629cc68c1688d84043ec9ba13209a098">remote_shell_server_impl::process_command</a>(<a class="code" href="remote__shell_8cpp.html#a629b1eda6a29b9b070c429c5bbac0c86">session_ptr</a> <a class="code" href="classsession.html">session</a>, <span class="keyword">const</span> std::string&amp; cmd, <span class="keyword">const</span> std::string&amp; args)
<a name="l01088"></a>01088 {
<a name="l01089"></a>01089    {
<a name="l01090"></a>01090       mutex::scoped_lock lock(<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a767febb4e9c9515407fef6c873c7222d">m_cmd_queue_mutex</a>);
<a name="l01091"></a>01091       <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a67d38269de9c029e632588eddf1d2ecc">m_cmd_queue</a>.push(<a class="code" href="structmoost_1_1service_1_1remote__shell__server__impl_1_1command.html">command</a>(session, cmd, args));
<a name="l01092"></a>01092    }
<a name="l01093"></a>01093 
<a name="l01094"></a>01094    <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a213ef2d3a9fc3e5b22bd42525e01abdb">m_cmd_queue_cond</a>.notify_one();
<a name="l01095"></a>01095 }
<a name="l01096"></a>01096 
<a name="l01097"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a3c82ac2972606a9c7030e00a6be25fa6">01097</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a3c82ac2972606a9c7030e00a6be25fa6">remote_shell_server_impl::command_thread</a>(<a class="code" href="classmoost_1_1service_1_1remote__shell__iface.html" title="Interface for remote command shell.">remote_shell_iface</a> *rsi)
<a name="l01098"></a>01098 {
<a name="l01099"></a>01099    <span class="comment">/*</span>
<a name="l01100"></a>01100 <span class="comment">    *  Commands may need some time to execute, thus they are moved to a separate</span>
<a name="l01101"></a>01101 <span class="comment">    *  thread (this one) in order to avoid:</span>
<a name="l01102"></a>01102 <span class="comment">    *</span>
<a name="l01103"></a>01103 <span class="comment">    *    - blocking of any stdout/stderr output</span>
<a name="l01104"></a>01104 <span class="comment">    *    - blocking of any other client sessions</span>
<a name="l01105"></a>01105 <span class="comment">    */</span>
<a name="l01106"></a>01106 
<a name="l01107"></a>01107    <span class="keywordflow">while</span> (<span class="keyword">true</span>)
<a name="l01108"></a>01108    {
<a name="l01109"></a>01109       <a class="code" href="structmoost_1_1service_1_1remote__shell__server__impl_1_1command.html">command</a> cmd;
<a name="l01110"></a>01110 
<a name="l01111"></a>01111       {
<a name="l01112"></a>01112          mutex::scoped_lock lock(<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a767febb4e9c9515407fef6c873c7222d">m_cmd_queue_mutex</a>);
<a name="l01113"></a>01113 
<a name="l01114"></a>01114          <span class="keywordflow">if</span> (<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a67d38269de9c029e632588eddf1d2ecc">m_cmd_queue</a>.empty())
<a name="l01115"></a>01115          {
<a name="l01116"></a>01116             <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a213ef2d3a9fc3e5b22bd42525e01abdb">m_cmd_queue_cond</a>.wait(lock);
<a name="l01117"></a>01117          }
<a name="l01118"></a>01118 
<a name="l01119"></a>01119          <span class="keywordflow">if</span> (<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a67d38269de9c029e632588eddf1d2ecc">m_cmd_queue</a>.empty())
<a name="l01120"></a>01120          {
<a name="l01121"></a>01121             <span class="keywordflow">continue</span>;
<a name="l01122"></a>01122          }
<a name="l01123"></a>01123 
<a name="l01124"></a>01124          cmd = <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a67d38269de9c029e632588eddf1d2ecc">m_cmd_queue</a>.front();
<a name="l01125"></a>01125          <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a67d38269de9c029e632588eddf1d2ecc">m_cmd_queue</a>.pop();
<a name="l01126"></a>01126       }
<a name="l01127"></a>01127 
<a name="l01128"></a>01128       <span class="keywordflow">if</span> (!cmd.<a class="code" href="structmoost_1_1service_1_1remote__shell__server__impl_1_1command.html#a1305545373513f7c8aaa7440d932f3ba">session</a>)
<a name="l01129"></a>01129       {
<a name="l01130"></a>01130          <span class="keywordflow">break</span>;
<a name="l01131"></a>01131       }
<a name="l01132"></a>01132 
<a name="l01133"></a>01133       std::string rv;
<a name="l01134"></a>01134       <span class="keywordtype">bool</span> handled = <span class="keyword">true</span>;
<a name="l01135"></a>01135 
<a name="l01136"></a>01136       <span class="keywordflow">try</span>
<a name="l01137"></a>01137       {
<a name="l01138"></a>01138          handled = rsi-&gt;<a class="code" href="classmoost_1_1service_1_1remote__shell__iface.html#aa04be54593d4bea94f0b9019b35cdfe6" title="Application-specific command handler.">handle_command</a>(rv, cmd.<a class="code" href="structmoost_1_1service_1_1remote__shell__server__impl_1_1command.html#a3b674d0656ca42ff958c7cc6122d4ff6">cmd</a>, cmd.<a class="code" href="structmoost_1_1service_1_1remote__shell__server__impl_1_1command.html#a3337133376c554a4007db0e89833c326">args</a>);
<a name="l01139"></a>01139       }
<a name="l01140"></a>01140       <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; e)
<a name="l01141"></a>01141       {
<a name="l01142"></a>01142          std::ostringstream oss;
<a name="l01143"></a>01143          oss &lt;&lt; <span class="stringliteral">&quot;exception while running &quot;</span> &lt;&lt; cmd.<a class="code" href="structmoost_1_1service_1_1remote__shell__server__impl_1_1command.html#a3b674d0656ca42ff958c7cc6122d4ff6">cmd</a> &lt;&lt; <span class="stringliteral">&quot; command: &quot;</span> &lt;&lt; e.what();
<a name="l01144"></a>01144          rv = oss.str();
<a name="l01145"></a>01145       }
<a name="l01146"></a>01146       <span class="keywordflow">catch</span> (...)
<a name="l01147"></a>01147       {
<a name="l01148"></a>01148          std::ostringstream oss;
<a name="l01149"></a>01149          oss &lt;&lt; <span class="stringliteral">&quot;unknown exception while running &quot;</span> &lt;&lt; cmd.<a class="code" href="structmoost_1_1service_1_1remote__shell__server__impl_1_1command.html#a3b674d0656ca42ff958c7cc6122d4ff6">cmd</a> &lt;&lt; <span class="stringliteral">&quot; command&quot;</span>;
<a name="l01150"></a>01150          rv = oss.str();
<a name="l01151"></a>01151       }
<a name="l01152"></a>01152 
<a name="l01153"></a>01153       <span class="keywordflow">if</span> (<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#af9b9b3d8e5b01da581c8efb60bfc7e0a">m_sessions</a>.find(cmd.<a class="code" href="structmoost_1_1service_1_1remote__shell__server__impl_1_1command.html#a1305545373513f7c8aaa7440d932f3ba">session</a>) != <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#af9b9b3d8e5b01da581c8efb60bfc7e0a">m_sessions</a>.end())
<a name="l01154"></a>01154       {
<a name="l01155"></a>01155          <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a7a517e1e3a821c32a7159480fd26716c">m_ios</a>-&gt;post(bind(&amp;<a class="code" href="classsession__base.html#a112c2a447f0c1c9bc9d2dc135f34e2f5">session_base::command_result</a>, cmd.<a class="code" href="structmoost_1_1service_1_1remote__shell__server__impl_1_1command.html#a1305545373513f7c8aaa7440d932f3ba">session</a>, handled, cmd.<a class="code" href="structmoost_1_1service_1_1remote__shell__server__impl_1_1command.html#a3b674d0656ca42ff958c7cc6122d4ff6">cmd</a>, rv));
<a name="l01156"></a>01156       }
<a name="l01157"></a>01157    }
<a name="l01158"></a>01158 }
<a name="l01159"></a>01159 
<a name="l01160"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a3a4e77676816d318835a6beb055e0ba4">01160</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a3a4e77676816d318835a6beb055e0ba4">remote_shell_server_impl::set_appender_factory</a>(<a class="code" href="namespacemoost_1_1service.html#a87325356c611b3fba77461f79c735d96">appender_factory_ptr</a> app_factory)
<a name="l01161"></a>01161 {
<a name="l01162"></a>01162    <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a43cbd23f719d53bc9cfefafaadfad9df">m_app_factory</a> = app_factory;
<a name="l01163"></a>01163 }
<a name="l01164"></a>01164 
<a name="l01165"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#af68dcc1b8f7460add28dca63f965fb89">01165</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#af68dcc1b8f7460add28dca63f965fb89">remote_shell_server_impl::set_default_stdout_state</a>(<span class="keywordtype">bool</span> enabled)
<a name="l01166"></a>01166 {
<a name="l01167"></a>01167    <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a711a4150bdef6abad44301fe1e9d1b3e">m_default_stdout_state</a> = enabled;
<a name="l01168"></a>01168 }
<a name="l01169"></a>01169 
<a name="l01170"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a8146da13a701f082250d80eca31c47d1">01170</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a8146da13a701f082250d80eca31c47d1">remote_shell_server_impl::set_default_stderr_state</a>(<span class="keywordtype">bool</span> enabled)
<a name="l01171"></a>01171 {
<a name="l01172"></a>01172    <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#ad291c3588da210155c8ec9fa417c770c">m_default_stderr_state</a> = enabled;
<a name="l01173"></a>01173 }
<a name="l01174"></a>01174 
<a name="l01175"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a6feac2a86f2bf322943439593bcb86cf">01175</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a6feac2a86f2bf322943439593bcb86cf">remote_shell_server_impl::set_listen_port</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> port)
<a name="l01176"></a>01176 {
<a name="l01177"></a>01177    <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a17ee6df74eb1f433beda238a49389d5f">m_listen_port</a> = port;
<a name="l01178"></a>01178 }
<a name="l01179"></a>01179 
<a name="l01180"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a167b87574e6c3f193831ef11ced45021">01180</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a167b87574e6c3f193831ef11ced45021">remote_shell_server_impl::set_pre_shutdown_function</a>(boost::function0&lt;void&gt;&amp; func)
<a name="l01181"></a>01181 {
<a name="l01182"></a>01182    <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a31910eb1e8d87951562a44cda396f32b">m_pre_shutdown_func</a> = func;
<a name="l01183"></a>01183 }
<a name="l01184"></a>01184 
<a name="l01185"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a0bdad876988bdc687b7f39a4034a27f9">01185</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a0bdad876988bdc687b7f39a4034a27f9">remote_shell_server_impl::enable_local_shell</a>(<span class="keywordtype">bool</span> enabled)
<a name="l01186"></a>01186 {
<a name="l01187"></a>01187    <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#ab398fd0ba89723927bc967d450f126ab">m_enable_local</a> = enabled;
<a name="l01188"></a>01188 }
<a name="l01189"></a>01189 
<a name="l01190"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#aa642524e92929f04a5fa2b3bf68c4665">01190</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#aa642524e92929f04a5fa2b3bf68c4665">remote_shell_server_impl::run</a>(<a class="code" href="classmoost_1_1service_1_1remote__shell__iface.html" title="Interface for remote command shell.">remote_shell_iface</a> *rsi)
<a name="l01191"></a>01191 {
<a name="l01192"></a>01192    <span class="keywordflow">if</span> (<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a17ee6df74eb1f433beda238a49389d5f">m_listen_port</a> == 0 &amp;&amp; !<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#ab398fd0ba89723927bc967d450f126ab">m_enable_local</a>)
<a name="l01193"></a>01193    {
<a name="l01194"></a>01194       <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;invalid configuration (no local and no remote port)&quot;</span>);
<a name="l01195"></a>01195    }
<a name="l01196"></a>01196 
<a name="l01197"></a>01197    std::ostringstream oss;
<a name="l01198"></a>01198 
<a name="l01199"></a>01199    <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#ab1f8b84d3dba6e156a1e7521324aac31">m_can_snoop_stdio</a> = <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#aa1db66bd4e58dcd0d4b70c785629d074">setup_stdio_snoopers</a>();
<a name="l01200"></a>01200 
<a name="l01201"></a>01201    <span class="keywordflow">if</span> (!<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#ab1f8b84d3dba6e156a1e7521324aac31">m_can_snoop_stdio</a>)
<a name="l01202"></a>01202    {
<a name="l01203"></a>01203       oss &lt;&lt; <span class="stringliteral">&quot;stdio snooping not available\r\n&quot;</span>;
<a name="l01204"></a>01204    }
<a name="l01205"></a>01205 
<a name="l01206"></a>01206    <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a354a6bb58354e34785939862b5cc951f">m_welcome</a> = oss.str();
<a name="l01207"></a>01207 
<a name="l01208"></a>01208    <span class="keywordflow">if</span> (<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#ab398fd0ba89723927bc967d450f126ab">m_enable_local</a>)
<a name="l01209"></a>01209    {
<a name="l01210"></a>01210       <span class="keywordflow">if</span> (!<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a9a1f5b9c525594c9037ee16f8b68dedf">setup_console_session</a>(rsi))
<a name="l01211"></a>01211       {
<a name="l01212"></a>01212          <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;failed to set up local shell session&quot;</span>);
<a name="l01213"></a>01213       }
<a name="l01214"></a>01214    }
<a name="l01215"></a>01215 
<a name="l01216"></a>01216    <span class="keywordflow">if</span> (<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a17ee6df74eb1f433beda238a49389d5f">m_listen_port</a> != 0)
<a name="l01217"></a>01217    {
<a name="l01218"></a>01218       <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#acdd09ca96cbdac61b7a7baef82395a02">m_acceptor</a>.reset(<span class="keyword">new</span> tcp::acceptor(*<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a7a517e1e3a821c32a7159480fd26716c">m_ios</a>, tcp::endpoint(tcp::v4(), <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a17ee6df74eb1f433beda238a49389d5f">m_listen_port</a>)));
<a name="l01219"></a>01219       <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a0893bf11ebf40f2e5a2433bf81643b01">accept_session</a>(rsi);
<a name="l01220"></a>01220    }
<a name="l01221"></a>01221 
<a name="l01222"></a>01222    <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a54be885fe19d43024b63a629b209d7b8">m_cmd_runner</a>.reset(<span class="keyword">new</span> thread(boost::bind(&amp;<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a3c82ac2972606a9c7030e00a6be25fa6">remote_shell_server_impl::command_thread</a>, <span class="keyword">this</span>, rsi)));
<a name="l01223"></a>01223 
<a name="l01224"></a>01224    <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a7a517e1e3a821c32a7159480fd26716c">m_ios</a>-&gt;run();
<a name="l01225"></a>01225 
<a name="l01226"></a>01226    {
<a name="l01227"></a>01227       mutex::scoped_lock lock(<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a767febb4e9c9515407fef6c873c7222d">m_cmd_queue_mutex</a>);
<a name="l01228"></a>01228       <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a67d38269de9c029e632588eddf1d2ecc">m_cmd_queue</a>.push(<a class="code" href="structmoost_1_1service_1_1remote__shell__server__impl_1_1command.html">command</a>()); <span class="comment">// shutdown thread</span>
<a name="l01229"></a>01229    }
<a name="l01230"></a>01230 
<a name="l01231"></a>01231    <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a213ef2d3a9fc3e5b22bd42525e01abdb">m_cmd_queue_cond</a>.notify_one();
<a name="l01232"></a>01232    <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a54be885fe19d43024b63a629b209d7b8">m_cmd_runner</a>-&gt;join();
<a name="l01233"></a>01233 }
<a name="l01234"></a>01234 
<a name="l01235"></a>01235 <span class="comment">/**********************************************************************/</span>
<a name="l01236"></a>01236 
<a name="l01237"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server.html#a2cf1607373b3c4ca9adef2222a2497fc">01237</a> <a class="code" href="classmoost_1_1service_1_1remote__shell__server.html#a2cf1607373b3c4ca9adef2222a2497fc">remote_shell_server::remote_shell_server</a>(shared_ptr&lt;asio::io_service&gt; ios)
<a name="l01238"></a>01238    : m_impl(new <a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html">remote_shell_server_impl</a>(ios))
<a name="l01239"></a>01239 {
<a name="l01240"></a>01240 }
<a name="l01241"></a>01241 
<a name="l01242"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server.html#ad18b87034b6bfa30c143ed3bc751e469">01242</a> <a class="code" href="classmoost_1_1service_1_1remote__shell__server.html#ad18b87034b6bfa30c143ed3bc751e469">remote_shell_server::~remote_shell_server</a>()
<a name="l01243"></a>01243 {
<a name="l01244"></a>01244    <span class="keyword">delete</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server.html#a55de26d777c3b47ca090abc1f3814625">m_impl</a>;
<a name="l01245"></a>01245 }
<a name="l01246"></a>01246 
<a name="l01247"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server.html#ad7bd9e269309da2565590afb41b82077">01247</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server.html#ad7bd9e269309da2565590afb41b82077">remote_shell_server::run</a>(<a class="code" href="classmoost_1_1service_1_1remote__shell__iface.html" title="Interface for remote command shell.">remote_shell_iface</a> *rsi)
<a name="l01248"></a>01248 {
<a name="l01249"></a>01249    <a class="code" href="classmoost_1_1service_1_1remote__shell__server.html#a55de26d777c3b47ca090abc1f3814625">m_impl</a>-&gt;<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#aa642524e92929f04a5fa2b3bf68c4665">run</a>(rsi);
<a name="l01250"></a>01250 }
<a name="l01251"></a>01251 
<a name="l01252"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server.html#a03bbaa29ace87d81a6be61533087f926">01252</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server.html#a03bbaa29ace87d81a6be61533087f926">remote_shell_server::stop</a>(<span class="keyword">const</span> std::string&amp; msg)
<a name="l01253"></a>01253 {
<a name="l01254"></a>01254    <a class="code" href="classmoost_1_1service_1_1remote__shell__server.html#a55de26d777c3b47ca090abc1f3814625">m_impl</a>-&gt;<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a9ffef4c6c97ea53c0f0097fd22f4c4bc">stop</a>(msg);
<a name="l01255"></a>01255 }
<a name="l01256"></a>01256 
<a name="l01257"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server.html#ae100d0a75cb1a8a3dd15151547ce16bb">01257</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server.html#ae100d0a75cb1a8a3dd15151547ce16bb">remote_shell_server::set_appender_factory</a>(<a class="code" href="namespacemoost_1_1service.html#a87325356c611b3fba77461f79c735d96">appender_factory_ptr</a> app_factory)
<a name="l01258"></a>01258 {
<a name="l01259"></a>01259    <a class="code" href="classmoost_1_1service_1_1remote__shell__server.html#a55de26d777c3b47ca090abc1f3814625">m_impl</a>-&gt;<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a3a4e77676816d318835a6beb055e0ba4">set_appender_factory</a>(app_factory);
<a name="l01260"></a>01260 }
<a name="l01261"></a>01261 
<a name="l01262"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server.html#a6a07d20073e4273d4799a086d108c7f0">01262</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server.html#a6a07d20073e4273d4799a086d108c7f0">remote_shell_server::set_default_stdout_state</a>(<span class="keywordtype">bool</span> enabled)
<a name="l01263"></a>01263 {
<a name="l01264"></a>01264    <a class="code" href="classmoost_1_1service_1_1remote__shell__server.html#a55de26d777c3b47ca090abc1f3814625">m_impl</a>-&gt;<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#af68dcc1b8f7460add28dca63f965fb89">set_default_stdout_state</a>(enabled);
<a name="l01265"></a>01265 }
<a name="l01266"></a>01266 
<a name="l01267"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server.html#a25da8fd4f69aa43734cae9fe37eea1e4">01267</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server.html#a25da8fd4f69aa43734cae9fe37eea1e4">remote_shell_server::set_default_stderr_state</a>(<span class="keywordtype">bool</span> enabled)
<a name="l01268"></a>01268 {
<a name="l01269"></a>01269    <a class="code" href="classmoost_1_1service_1_1remote__shell__server.html#a55de26d777c3b47ca090abc1f3814625">m_impl</a>-&gt;<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a8146da13a701f082250d80eca31c47d1">set_default_stderr_state</a>(enabled);
<a name="l01270"></a>01270 }
<a name="l01271"></a>01271 
<a name="l01272"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server.html#a2522f30d3914130fb84f4198eaefb1d6">01272</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server.html#a2522f30d3914130fb84f4198eaefb1d6">remote_shell_server::set_listen_port</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> port)
<a name="l01273"></a>01273 {
<a name="l01274"></a>01274    <a class="code" href="classmoost_1_1service_1_1remote__shell__server.html#a55de26d777c3b47ca090abc1f3814625">m_impl</a>-&gt;<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a6feac2a86f2bf322943439593bcb86cf">set_listen_port</a>(port);
<a name="l01275"></a>01275 }
<a name="l01276"></a>01276 
<a name="l01277"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server.html#a6d409210112d4ef46ccac6e330be93b4">01277</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server.html#a6d409210112d4ef46ccac6e330be93b4">remote_shell_server::set_pre_shutdown_function</a>(boost::function0&lt;void&gt;&amp; func)
<a name="l01278"></a>01278 {
<a name="l01279"></a>01279    <a class="code" href="classmoost_1_1service_1_1remote__shell__server.html#a55de26d777c3b47ca090abc1f3814625">m_impl</a>-&gt;<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a167b87574e6c3f193831ef11ced45021">set_pre_shutdown_function</a>(func);
<a name="l01280"></a>01280 }
<a name="l01281"></a>01281 
<a name="l01282"></a><a class="code" href="classmoost_1_1service_1_1remote__shell__server.html#a65e4c0e6a130ad432c77d81c73280cca">01282</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1service_1_1remote__shell__server.html#a65e4c0e6a130ad432c77d81c73280cca">remote_shell_server::enable_local_shell</a>(<span class="keywordtype">bool</span> enabled)
<a name="l01283"></a>01283 {
<a name="l01284"></a>01284    <a class="code" href="classmoost_1_1service_1_1remote__shell__server.html#a55de26d777c3b47ca090abc1f3814625">m_impl</a>-&gt;<a class="code" href="classmoost_1_1service_1_1remote__shell__server__impl.html#a0bdad876988bdc687b7f39a4034a27f9">enable_local_shell</a>(enabled);
<a name="l01285"></a>01285 }
<a name="l01286"></a>01286 
</pre></div></div><!-- contents -->
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="remote__shell_8cpp.html">remote_shell.cpp</a>      </li>

    <li class="footer">Generated on Wed Feb 20 2013 05:56:08 for libmoost by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
