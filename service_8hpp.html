<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>libmoost: /home/mhx/git/github/libmoost/include/moost/process/service.hpp File Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>


</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">libmoost
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('service_8hpp.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#namespaces">Namespaces</a> &#124;
<a href="#define-members">Defines</a>  </div>
  <div class="headertitle">
<div class="title">/home/mhx/git/github/libmoost/include/moost/process/service.hpp File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;stdexcept&gt;</code><br/>
<code>#include &lt;cassert&gt;</code><br/>
<code>#include &lt;boost/filesystem/path.hpp&gt;</code><br/>
<code>#include &lt;boost/shared_ptr.hpp&gt;</code><br/>
<code>#include &lt;boost/scoped_ptr.hpp&gt;</code><br/>
<code>#include &lt;boost/noncopyable.hpp&gt;</code><br/>
<code>#include &lt;boost/function.hpp&gt;</code><br/>
<code>#include &quot;<a class="el" href="daemon_8hpp_source.html">daemon.hpp</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="sleeper_8hpp_source.html">sleeper.hpp</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="pidfile_8hpp_source.html">pidfile.hpp</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="quit__handler_8hpp_source.html">quit_handler.hpp</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="class__logger_8hpp_source.html">../logging/class_logger.hpp</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="standard__console_8hpp_source.html">../logging/standard_console.hpp</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="remote__shell_8h_source.html">../service/remote_shell.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="appender_8h_source.html">../service/appender.h</a>&quot;</code><br/>
</div><div class="textblock"><div class="dynheader">
Include dependency graph for service.hpp:</div>
<div class="dyncontent">
<div class="center"><img src="service_8hpp__incl.png" border="0" usemap="#_2home_2mhx_2git_2github_2libmoost_2include_2moost_2process_2service_8hpp" alt=""/></div>
<map name="_2home_2mhx_2git_2github_2libmoost_2include_2moost_2process_2service_8hpp" id="_2home_2mhx_2git_2github_2libmoost_2include_2moost_2process_2service_8hpp">
<area shape="rect" id="node17" href="daemon_8hpp.html" title="daemon.hpp" alt="" coords="261,83,362,111"/><area shape="rect" id="node31" href="sleeper_8hpp.html" title="sleeper.hpp" alt="" coords="1125,83,1221,111"/><area shape="rect" id="node41" href="pidfile_8hpp.html" title="pidfile.hpp" alt="" coords="3311,238,3397,266"/><area shape="rect" id="node49" href="quit__handler_8hpp.html" title="quit_handler.hpp" alt="" coords="634,83,762,111"/><area shape="rect" id="node61" href="class__logger_8hpp.html" title="../logging/class_logger.hpp" alt="" coords="3274,83,3463,111"/><area shape="rect" id="node89" href="standard__console_8hpp.html" title="../logging/standard_console.hpp" alt="" coords="2311,161,2535,189"/><area shape="rect" id="node121" href="remote__shell_8h.html" title="../service/remote_shell.h" alt="" coords="1445,83,1623,111"/><area shape="rect" id="node128" href="appender_8h.html" title="appender.h" alt="" coords="1698,161,1791,189"/><area shape="rect" id="node22" href="daemon__linux_8hpp.html" title="detail/daemon_linux.hpp" alt="" coords="178,161,357,189"/><area shape="rect" id="node56" href="hup__handler_8hpp.html" title="hup_handler.hpp" alt="" coords="533,161,661,189"/><area shape="rect" id="node65" href="logger_8hpp.html" title="logger.hpp" alt="" coords="3325,161,3413,189"/><area shape="rect" id="node82" href="demangler_8hpp.html" title="../utils/demangler.hpp" alt="" coords="3773,161,3933,189"/><area shape="rect" id="node72" href="logging_2global_8hpp.html" title="global.hpp" alt="" coords="3421,238,3509,266"/><area shape="rect" id="node95" href="terminal__format_8hpp.html" title="../terminal_format.hpp" alt="" coords="1975,238,2141,266"/><area shape="rect" id="node114" href="custompatternlayout_8hpp.html" title="detail/custompatternlayout.hpp" alt="" coords="2165,238,2386,266"/></map>
</div>
</div><div class="textblock"><div class="dynheader">
This graph shows which files directly or indirectly include this file:</div>
<div class="dyncontent">
<div class="center"><img src="service_8hpp__dep__incl.png" border="0" usemap="#_2home_2mhx_2git_2github_2libmoost_2include_2moost_2process_2service_8hppdep" alt=""/></div>
<map name="_2home_2mhx_2git_2github_2libmoost_2include_2moost_2process_2service_8hppdep" id="_2home_2mhx_2git_2github_2libmoost_2include_2moost_2process_2service_8hppdep">
<area shape="rect" id="node3" href="service_2skeleton_8hpp.html" title="/home/mhx/git/github/libmoost/include/moost/service/skeleton.hpp" alt="" coords="5,83,451,111"/></map>
</div>
</div>
<p><a href="service_8hpp_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="nested-classes"></a>
Classes</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classmoost_1_1process_1_1_no_console_logger_policy.html">moost::process::NoConsoleLoggerPolicy</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classmoost_1_1process_1_1_moost_standard_console_logger_policy.html">moost::process::MoostStandardConsoleLoggerPolicy</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classmoost_1_1process_1_1service.html">moost::process::service&lt; ServiceT, ConsoleLoggerPolicy &gt;</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmoost_1_1process_1_1service_1_1noop__child__init__func.html">moost::process::service&lt; ServiceT, ConsoleLoggerPolicy &gt;::noop_child_init_func</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmoost_1_1process_1_1service_1_1default__parent__exit__func.html">moost::process::service&lt; ServiceT, ConsoleLoggerPolicy &gt;::default_parent_exit_func</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classmoost_1_1process_1_1service_1_1service__wrapper.html">moost::process::service&lt; ServiceT, ConsoleLoggerPolicy &gt;::service_wrapper</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmoost_1_1process_1_1service_1_1enable__logger__func.html">moost::process::service&lt; ServiceT, ConsoleLoggerPolicy &gt;::enable_logger_func</a></td></tr>
<tr><td colspan="2"><h2><a name="namespaces"></a>
Namespaces</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">namespace &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemoost.html">moost</a></td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight"><p>Creates a unique temporary directory; removed on scope exit. </p>
<br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">namespace &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemoost_1_1process.html">moost::process</a></td></tr>
<tr><td colspan="2"><h2><a name="define-members"></a>
Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="service_8hpp.html#aae042fe724b797045fe8cbebfc42397f">MPS_FM303_SHELL_CONST</a></td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock"><p>Copyright Â© 2008-2013 Last.fm Limited</p>
<p>This file is part of libmoost.</p>
<p>Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</p>
<p>The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</p>
<p>THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</p>
<p>The <a class="el" href="classmoost_1_1process_1_1service.html">moost::process::service</a> class hides most of the process of setting up a system service within an easy to use, yet customisable template. It takes care of:</p>
<ul>
<li>daemonisation</li>
<li>pid file creation</li>
<li>setting up signal handlers</li>
<li>setting up a local and/or remote command shell</li>
<li>setting up a moost::standard_console</li>
<li>starting the service</li>
<li>shutting down the service</li>
</ul>
<p>For this to work, a (usually very small) service class must be provided that implements the following methods:</p>
<div class="fragment"><pre class="fragment"><span class="keyword">class </span>MyService
{
<span class="keyword">public</span>:
   <span class="keyword">typedef</span> MyServiceHandler HandlerType;   <span class="comment">// a typedef for the service handler</span>

   <span class="keyword">const</span> std::string&amp; name() <span class="keyword">const</span>;        <span class="comment">// returns the name of the service</span>

   boost::shared_ptr&lt;HandlerType&gt; handler();
                                 <span class="comment">// returns a shared pointer to the service handler object,</span>
                                 <span class="comment">//    which must implement the necessary methods to be used</span>
                                 <span class="comment">//    with moost::service::remote_shell</span>
                                 <span class="comment">// guaranteed not to be called before start() or after stop()</span>

   <span class="keywordtype">void</span> start();                 <span class="comment">// performs all operations necessary to create and start the</span>
                                 <span class="comment">//    service handler</span>

   <span class="keywordtype">void</span> stop();                  <span class="comment">// performs all operations necessary to stop the service</span>
                                 <span class="comment">//    handler</span>
};
</pre></div><p>The service handler defined by <code>HandlerType</code> must be compatible with <a class="el" href="classmoost_1_1service_1_1remote__shell.html" title="A remote command shell used for interacting with the user.">moost::service::remote_shell</a>, i.e. it must implement the get_prompt(), show_help() and handler_command() methods. It can be, but doesn't neccessarily have to be derived from moost::fm303_cmd_shell.</p>
<p>With the above class, a simple service can be implemented in a couple of lines of code:</p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">int</span> <a class="code" href="stomp__test__client_8cpp.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>()
{
   <a class="code" href="logging_2global_8hpp.html#a4bd57daab125ab96f57bd5d779bb9479" title="Allow quick and diry initialisation of logging.">MLOG_INIT</a>();

   <a class="code" href="classmoost_1_1process_1_1service.html">moost::process::service&lt;MyService&gt;</a> service(<span class="keyword">new</span> MyService);

   service.set_pidfile(pidfile);       <span class="comment">// optional: override pid file name</span>
   service.set_shell_port(shell_port); <span class="comment">// optional: to enable the remote shell, set the shell port</span>

   service.run(in_daemon_mode);        <span class="comment">// run the service in daemon/non-daemon mode</span>

   <span class="keywordflow">return</span> 0;
}
</pre></div><p>Nothing important happens inside the <code>service</code> object until its run() method is called. The run method will do the following:</p>
<ul>
<li>When <code>in_daemon_mode</code> is <code>true</code>, it will first fork a child process using <a class="el" href="classmoost_1_1process_1_1daemon.html" title="Provides everything necessary to convert a process into a daemon.">moost::process::daemon</a>.</li>
</ul>
<ul>
<li>The parent process will create a pid file and exit.</li>
</ul>
<ul>
<li>If <code>in_daemon_mode</code> is <code>true</code> or a remote shell port has been set (i.e. if there is no local shell), it will set up a signal handler using <a class="el" href="classmoost_1_1process_1_1quit__handler.html" title="Note, SIGKILL and SIGSTOP are not handled (this is a Posix restriction).">moost::process::quit_handler</a>.</li>
</ul>
<ul>
<li>It will then call the start() method of service class defined above. The start() method must return with the created service handler running in its own thread.</li>
</ul>
<ul>
<li>If a shell port has been set or if <code>in_daemon_mode</code> is <code>false</code>, it will now set up a shell using <a class="el" href="classmoost_1_1service_1_1remote__shell.html" title="A remote command shell used for interacting with the user.">moost::service::remote_shell</a>. Otherwise, it will just set up an interruptible sleeper using <a class="el" href="classmoost_1_1process_1_1sleeper.html">moost::process::sleeper</a>.</li>
</ul>
<ul>
<li>Whenever either shell exits or a terminating signal is received, the stop() method of the service class will be called.</li>
</ul>
<ul>
<li>Finally, the run() method returns.</li>
</ul>
<ul>
<li>The pid file will be deleted by the <a class="el" href="classmoost_1_1process_1_1service.html">moost::process::service</a> destructor.</li>
</ul>
<p>The service class must ensure that its handler() method returns a valid handler object after the start() method has been called until the stop() method is called.</p>
<p>Here are some examples for more advanced usage:</p>
<ul>
<li>You can use the set_child_init_func() method to set a boost::function object that will be passed on to <a class="el" href="classmoost_1_1process_1_1daemon.html" title="Provides everything necessary to convert a process into a daemon.">moost::process::daemon</a> and that will be called just after the child process has been forked. If the service is not daemonised, the function object will be called just after the run() method has been entered. The return value is ignored in that case. Note that the child init function is called just in time to allow further configuration of the <a class="el" href="classmoost_1_1process_1_1service.html">moost::process::service</a> instance, i.e. you can still configure all options relevant for the child process from within the child init function.</li>
</ul>
<ul>
<li>You can also override the exit behaviour of the parent process using set_parent_exit_func(). The function object is called with the child's process id as its only argument. The default implementation just calls exit(0). If you don't call exit() from the function object, run() will just return in the parent process and as a side effect, the pid file will be deleted as soon as the parent's instance of <a class="el" href="classmoost_1_1process_1_1service.html">moost::process::service</a> is destroyed.</li>
</ul>
<ul>
<li>You can override the creation of a console logger by passing a console logger policy as a template argument to <a class="el" href="classmoost_1_1process_1_1service.html">moost::process::service</a>. The default <code>MoostStandardConsoleLoggerPolicy</code> will create a <a class="el" href="classmoost_1_1logging_1_1standard__console.html">moost::logging::standard_console</a> instance. Use NoConsoleLoggerPolicy if you don't want a console logger. Note that the remote shell doesn't require a console logger to support logging.</li>
</ul>
<p>If you think that your service code is too long even with <a class="el" href="classmoost_1_1process_1_1service.html">moost::process::service</a>, have a look at <a class="el" href="classmoost_1_1service_1_1skeleton.html" title="Configurable template implementing common functionality to run a service.">moost::service::skeleton</a>. </p>

<p>Definition in file <a class="el" href="service_8hpp_source.html">service.hpp</a>.</p>
</div><hr/><h2>Define Documentation</h2>
<a class="anchor" id="aae042fe724b797045fe8cbebfc42397f"></a><!-- doxytag: member="service.hpp::MPS_FM303_SHELL_CONST" ref="aae042fe724b797045fe8cbebfc42397f" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="service_8hpp.html#aae042fe724b797045fe8cbebfc42397f">MPS_FM303_SHELL_CONST</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="service_8hpp_source.html#l00174">174</a> of file <a class="el" href="service_8hpp_source.html">service.hpp</a>.</p>

</div>
</div>
</div><!-- contents -->
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="service_8hpp.html">service.hpp</a>      </li>

    <li class="footer">Generated on Wed Feb 20 2013 05:56:09 for libmoost by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
