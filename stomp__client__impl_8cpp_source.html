<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>libmoost: /home/mhx/git/github/libmoost/src/mq/stomp_client_impl.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>


</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">libmoost
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('stomp__client__impl_8cpp.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">/home/mhx/git/github/libmoost/src/mq/stomp_client_impl.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="stomp__client__impl_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* vim:set ts=3 sw=3 sts=3 et: */</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;algorithm&gt;</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;boost/date_time/posix_time/time_formatters.hpp&gt;</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;../../include/moost/logging.hpp&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;../../include/moost/utils/stringify.hpp&quot;</span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="error__category_8h.html">error_category.h</a>&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="stomp__client__impl_8h.html">stomp_client_impl.h</a>&quot;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="keyword">namespace </span>moost { <span class="keyword">namespace </span>mq {
<a name="l00039"></a>00039 
<a name="l00040"></a><a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#afd1c174565847918d16e14f721ff4532">00040</a> boost::system::error_code <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#afd1c174565847918d16e14f721ff4532">stomp_client::impl::make_error_code</a>(<a class="code" href="namespacemoost_1_1mq_1_1error.html#afa15d2b77bc67b28ee46d11b2ffa3ee2">error::type</a> ec)
<a name="l00041"></a>00041 {
<a name="l00042"></a>00042    <span class="keywordflow">return</span> boost::system::error_code(ec, <a class="code" href="namespacemoost_1_1mq.html#adfbcc5b4c485a09cbd2163b9c422bb5d">mq_error_category</a>());
<a name="l00043"></a>00043 }
<a name="l00044"></a>00044 
<a name="l00045"></a><a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#a5a62975a1f0e62b687cf65320a57ae02">00045</a> <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#a5a62975a1f0e62b687cf65320a57ae02">stomp_client::impl::impl</a>(<span class="keywordtype">size_t</span> consumer_pool_size,
<a name="l00046"></a>00046                          <span class="keyword">const</span> boost::posix_time::time_duration&amp; keepalive_interval,
<a name="l00047"></a>00047                          <span class="keyword">const</span> boost::posix_time::time_duration&amp; reconnect_interval)
<a name="l00048"></a>00048    : m_keepalive_interval(keepalive_interval)
<a name="l00049"></a>00049    , m_reconnect_interval(reconnect_interval)
<a name="l00050"></a>00050    , m_socket(m_ios)
<a name="l00051"></a>00051    , m_keepalive_timer(m_ios)
<a name="l00052"></a>00052    , m_reconnect_timer(m_ios)
<a name="l00053"></a>00053    , m_dead_conn_timer(m_ios)
<a name="l00054"></a>00054    , m_ios_work(new boost::asio::io_service::work(m_ios))
<a name="l00055"></a>00055    , m_ios_thread(boost::bind(&amp;boost::asio::io_service::run, &amp;m_ios))
<a name="l00056"></a>00056    , m_streams(consumer_pool_size)
<a name="l00057"></a>00057    , m_state(<a class="code" href="structmoost_1_1mq_1_1stomp__client_1_1impl_1_1state.html">state</a>::disconnected)
<a name="l00058"></a>00058    , m_proto(<a class="code" href="structmoost_1_1mq_1_1stomp__client_1_1impl_1_1protocol.html">protocol</a>::undefined)
<a name="l00059"></a>00059 {
<a name="l00060"></a>00060 }
<a name="l00061"></a>00061 
<a name="l00062"></a><a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#a619ad42de4173092654f19411fc9433b">00062</a> <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#a619ad42de4173092654f19411fc9433b">stomp_client::impl::~impl</a>()
<a name="l00063"></a>00063 {
<a name="l00064"></a>00064    <span class="keywordflow">try</span>
<a name="l00065"></a>00065    {
<a name="l00066"></a>00066       m_ios_work.reset();
<a name="l00067"></a>00067       m_ios_thread.join();
<a name="l00068"></a>00068    }
<a name="l00069"></a>00069    <span class="keywordflow">catch</span> (...)
<a name="l00070"></a>00070    {
<a name="l00071"></a>00071    }
<a name="l00072"></a>00072 }
<a name="l00073"></a>00073 
<a name="l00074"></a><a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#a4ba344371f3c240a5e23043608d76ae7">00074</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1mq_1_1stomp__client.html#add3d4f38fad1d1bff2e7e329fa130cc0">stomp_client::impl::connect</a>(<span class="keyword">const</span> std::string&amp; hostname, <span class="keywordtype">int</span> port, <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#ace43f982de5adf3211d5fd0f092546f4">error_cb_t</a> error_cb)
<a name="l00075"></a>00075 {
<a name="l00076"></a>00076    <span class="keywordflow">if</span> (<a class="code" href="classmoost_1_1mq_1_1stomp__client.html#adc140389e80953ea82f2d79352e2cbbb">is_connected</a>())
<a name="l00077"></a>00077    {
<a name="l00078"></a>00078       <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;already connected to &quot;</span> + m_hostname + <span class="stringliteral">&quot;:&quot;</span> + boost::lexical_cast&lt;std::string&gt;(m_port));
<a name="l00079"></a>00079    }
<a name="l00080"></a>00080 
<a name="l00081"></a>00081    m_hostname = hostname;
<a name="l00082"></a>00082    m_port = port;
<a name="l00083"></a>00083    m_error_cb = error_cb;
<a name="l00084"></a>00084    m_state = state::connecting;
<a name="l00085"></a>00085    reconnect();
<a name="l00086"></a>00086 }
<a name="l00087"></a>00087 
<a name="l00088"></a><a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#a9cfefd85861df8959048638074e7a3c7">00088</a> boost::system::error_code <a class="code" href="classmoost_1_1mq_1_1stomp__client.html#add3d4f38fad1d1bff2e7e329fa130cc0">stomp_client::impl::connect</a>()
<a name="l00089"></a>00089 {
<a name="l00090"></a>00090    <span class="keyword">using namespace </span>boost::asio::ip;
<a name="l00091"></a>00091 
<a name="l00092"></a>00092    boost::system::error_code error;
<a name="l00093"></a>00093 
<a name="l00094"></a>00094    tcp::resolver resolver(m_ios);
<a name="l00095"></a>00095    tcp::resolver::query query(m_hostname, boost::lexical_cast&lt;std::string&gt;(m_port));
<a name="l00096"></a>00096    tcp::resolver::iterator it = resolver.resolve(query, error);
<a name="l00097"></a>00097    tcp::resolver::iterator end;
<a name="l00098"></a>00098 
<a name="l00099"></a>00099    <span class="keywordflow">if</span> (!error)
<a name="l00100"></a>00100    {
<a name="l00101"></a>00101       <span class="keywordflow">while</span> (it != end)
<a name="l00102"></a>00102       {
<a name="l00103"></a>00103          m_socket.connect(*it++, error);
<a name="l00104"></a>00104 
<a name="l00105"></a>00105          <span class="keywordflow">if</span> (!error)
<a name="l00106"></a>00106          {
<a name="l00107"></a>00107             <span class="keywordflow">break</span>;
<a name="l00108"></a>00108          }
<a name="l00109"></a>00109       }
<a name="l00110"></a>00110 
<a name="l00111"></a>00111       <span class="keywordflow">if</span> (!error)
<a name="l00112"></a>00112       {
<a name="l00113"></a>00113          m_socket.set_option(tcp::acceptor::keep_alive(<span class="keyword">true</span>));
<a name="l00114"></a>00114 
<a name="l00115"></a>00115          <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#abf1133c14b54e09e514c043daa611730">header_map</a> headers;
<a name="l00116"></a>00116          headers[<span class="stringliteral">&quot;accept-version&quot;</span>] = <span class="stringliteral">&quot;1.0,1.1&quot;</span>;
<a name="l00117"></a>00117          headers[<span class="stringliteral">&quot;host&quot;</span>] = m_hostname;
<a name="l00118"></a>00118 
<a name="l00119"></a>00119          <a class="code" href="class__logger_8hpp.html#a0ac729e36a608d22b69d2a136901b503">MLOG_CLASS_DEBUG</a>(<span class="stringliteral">&quot;connecting to stomp queue at &quot;</span> &lt;&lt; m_hostname &lt;&lt; <span class="stringliteral">&quot;:&quot;</span> &lt;&lt; m_port);
<a name="l00120"></a>00120 
<a name="l00121"></a>00121          error = send_to_queue(<span class="stringliteral">&quot;CONNECT&quot;</span>, headers);
<a name="l00122"></a>00122 
<a name="l00123"></a>00123          <span class="keywordflow">if</span> (!error)
<a name="l00124"></a>00124          {
<a name="l00125"></a>00125             boost::asio::read_until(m_socket, m_response, <span class="keywordtype">char</span>(0), error);
<a name="l00126"></a>00126 
<a name="l00127"></a>00127             <span class="keywordflow">if</span> (!error)
<a name="l00128"></a>00128             {
<a name="l00129"></a>00129                std::string command, body;
<a name="l00130"></a>00130 
<a name="l00131"></a>00131                headers.clear();
<a name="l00132"></a>00132                receive_from_queue(command, headers, body);
<a name="l00133"></a>00133 
<a name="l00134"></a>00134                <a class="code" href="class__logger_8hpp.html#a3e51e62f2c7305e966f31dd5f158862d">MLOG_CLASS_TRACE</a>(<span class="stringliteral">&quot;got &quot;</span> &lt;&lt; command &lt;&lt; <span class="stringliteral">&quot; from stomp queue&quot;</span>);
<a name="l00135"></a>00135 
<a name="l00136"></a>00136                <span class="keywordflow">if</span> (command != <span class="stringliteral">&quot;CONNECTED&quot;</span>)
<a name="l00137"></a>00137                {
<a name="l00138"></a>00138                   <span class="keywordflow">return</span> make_error_code(<a class="code" href="namespacemoost_1_1mq_1_1error.html#afa15d2b77bc67b28ee46d11b2ffa3ee2aeff80cd29776320284751bf483c3b7ff">error::connect_cmd_failed</a>);
<a name="l00139"></a>00139                }
<a name="l00140"></a>00140 
<a name="l00141"></a>00141                <a class="code" href="class__logger_8hpp.html#a3e51e62f2c7305e966f31dd5f158862d">MLOG_CLASS_TRACE</a>(<span class="stringliteral">&quot;connected headers: &quot;</span> &lt;&lt; <a class="code" href="namespacemoost_1_1utils.html#aa5e99a3bdd4b7dbfd6f08b2b61315e49">moost::utils::stringify</a>(headers));
<a name="l00142"></a>00142 
<a name="l00143"></a>00143                header_map::const_iterator it = headers.find(<span class="stringliteral">&quot;version&quot;</span>);
<a name="l00144"></a>00144                m_proto = it != headers.end() &amp;&amp; it-&gt;second == <span class="stringliteral">&quot;1.1&quot;</span> ? protocol::version11 : protocol::version10;
<a name="l00145"></a>00145 
<a name="l00146"></a>00146                m_state = state::online;
<a name="l00147"></a>00147 
<a name="l00148"></a>00148                recv_more();
<a name="l00149"></a>00149                keepalive();
<a name="l00150"></a>00150             }
<a name="l00151"></a>00151          }
<a name="l00152"></a>00152       }
<a name="l00153"></a>00153    }
<a name="l00154"></a>00154 
<a name="l00155"></a>00155    <span class="keywordflow">return</span> error;
<a name="l00156"></a>00156 }
<a name="l00157"></a>00157 
<a name="l00158"></a><a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#a0d2d47701ce0476f371a79f624269433">00158</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1mq_1_1stomp__client.html#a0702d977e646e9bf8513e3eb7af79e2a">stomp_client::impl::disconnect</a>()
<a name="l00159"></a>00159 {
<a name="l00160"></a>00160    m_keepalive_timer.cancel();
<a name="l00161"></a>00161    m_reconnect_timer.cancel();
<a name="l00162"></a>00162    m_dead_conn_timer.cancel();
<a name="l00163"></a>00163 
<a name="l00164"></a>00164    send_to_queue(<span class="stringliteral">&quot;DISCONNECT&quot;</span>);
<a name="l00165"></a>00165 
<a name="l00166"></a>00166    m_state = state::disconnected;
<a name="l00167"></a>00167    m_proto = protocol::undefined;
<a name="l00168"></a>00168 
<a name="l00169"></a>00169    m_socket.close();
<a name="l00170"></a>00170    m_streams.clear();
<a name="l00171"></a>00171 }
<a name="l00172"></a>00172 
<a name="l00173"></a><a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#ab672eed976ce6b84f86663090bcfd66d">00173</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#ab672eed976ce6b84f86663090bcfd66d">stomp_client::impl::reconnect</a>()
<a name="l00174"></a>00174 {
<a name="l00175"></a>00175    <span class="keywordflow">if</span> (<a class="code" href="classmoost_1_1mq_1_1stomp__client.html#adc140389e80953ea82f2d79352e2cbbb">is_connected</a>())
<a name="l00176"></a>00176    {
<a name="l00177"></a>00177       <a class="code" href="class__logger_8hpp.html#a3e51e62f2c7305e966f31dd5f158862d">MLOG_CLASS_TRACE</a>(<span class="stringliteral">&quot;attempting to connect&quot;</span>);
<a name="l00178"></a>00178 
<a name="l00179"></a>00179       boost::system::error_code ec = <a class="code" href="classmoost_1_1mq_1_1stomp__client.html#add3d4f38fad1d1bff2e7e329fa130cc0">connect</a>();
<a name="l00180"></a>00180 
<a name="l00181"></a>00181       <span class="keywordflow">if</span> (!ec)
<a name="l00182"></a>00182       {
<a name="l00183"></a>00183          std::vector&lt;stream_manager::topic_stream_pair&gt; topics;
<a name="l00184"></a>00184          m_streams.get_list(topics);
<a name="l00185"></a>00185 
<a name="l00186"></a>00186          <span class="keywordflow">for</span> (std::vector&lt;stream_manager::topic_stream_pair&gt;::const_iterator it = topics.begin(); it != topics.end(); ++it)
<a name="l00187"></a>00187          {
<a name="l00188"></a>00188             <a class="code" href="classmoost_1_1mq_1_1stomp__client.html#a70c4f4e5a3c91afa461c48b6dc4eb85d">subscribe</a>(it-&gt;first, it-&gt;second-&gt;ack_type());
<a name="l00189"></a>00189             it-&gt;second-&gt;reset_interval_timer();
<a name="l00190"></a>00190          }
<a name="l00191"></a>00191 
<a name="l00192"></a>00192          dead_conn_detect();
<a name="l00193"></a>00193       }
<a name="l00194"></a>00194       <span class="keywordflow">else</span>
<a name="l00195"></a>00195       {
<a name="l00196"></a>00196          <a class="code" href="class__logger_8hpp.html#a3e51e62f2c7305e966f31dd5f158862d">MLOG_CLASS_TRACE</a>(<span class="stringliteral">&quot;connect failed: &quot;</span> &lt;&lt; ec.message());
<a name="l00197"></a>00197 
<a name="l00198"></a>00198          <span class="keywordflow">if</span> (m_state == state::connecting)
<a name="l00199"></a>00199          {
<a name="l00200"></a>00200             m_state = state::reconnecting;
<a name="l00201"></a>00201             m_error_cb(ec, <span class="stringliteral">&quot;connect failed&quot;</span>);
<a name="l00202"></a>00202          }
<a name="l00203"></a>00203 
<a name="l00204"></a>00204          m_reconnect_timer.expires_from_now(m_reconnect_interval);
<a name="l00205"></a>00205          m_reconnect_timer.async_wait(boost::bind(&amp;<a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#abcc78d85dd27ed9cf8a6702cff6daa2f">stomp_client::impl::handle_reconnect</a>, shared_from_this(), boost::asio::placeholders::error));
<a name="l00206"></a>00206       }
<a name="l00207"></a>00207    }
<a name="l00208"></a>00208 }
<a name="l00209"></a>00209 
<a name="l00210"></a><a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#aefe677f792fbc0189fc67000c0ce3016">00210</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1mq_1_1stomp__client.html#a70c4f4e5a3c91afa461c48b6dc4eb85d">stomp_client::impl::subscribe</a>(<span class="keyword">const</span> std::string&amp; topic, <a class="code" href="classmoost_1_1mq_1_1stream.html#a493c933c8fbe546b89aefd178a420558">stream::message_cb_t</a> message_cb, <a class="code" href="structmoost_1_1mq_1_1stomp__client_1_1ack.html#a3e3458742c13808a443f754df5effcd9">stomp_client::ack::type</a> ack_type,
<a name="l00211"></a>00211                                    <span class="keyword">const</span> boost::posix_time::time_duration&amp; max_msg_interval)
<a name="l00212"></a>00212 {
<a name="l00213"></a>00213    <span class="keywordflow">if</span> (!<a class="code" href="classmoost_1_1mq_1_1stomp__client.html#adc140389e80953ea82f2d79352e2cbbb">is_connected</a>())
<a name="l00214"></a>00214    {
<a name="l00215"></a>00215       <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;not connected&quot;</span>);
<a name="l00216"></a>00216    }
<a name="l00217"></a>00217 
<a name="l00218"></a>00218    <span class="keywordflow">if</span> (!m_streams.insert(topic, message_cb, ack_type, max_msg_interval))
<a name="l00219"></a>00219    {
<a name="l00220"></a>00220       <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;already subscribed to &quot;</span> + topic);
<a name="l00221"></a>00221    }
<a name="l00222"></a>00222 
<a name="l00223"></a>00223    <a class="code" href="classmoost_1_1mq_1_1stomp__client.html#a70c4f4e5a3c91afa461c48b6dc4eb85d">subscribe</a>(topic, ack_type);
<a name="l00224"></a>00224 }
<a name="l00225"></a>00225 
<a name="l00226"></a><a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#a52b99e9c0b1a0a9a1bc491d16ee39a3e">00226</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1mq_1_1stomp__client.html#a70c4f4e5a3c91afa461c48b6dc4eb85d">stomp_client::impl::subscribe</a>(<span class="keyword">const</span> std::string&amp; topic, <a class="code" href="structmoost_1_1mq_1_1stomp__client_1_1ack.html#a3e3458742c13808a443f754df5effcd9">stomp_client::ack::type</a> ack_type)
<a name="l00227"></a>00227 {
<a name="l00228"></a>00228    <span class="keywordflow">if</span> (<a class="code" href="classmoost_1_1mq_1_1stomp__client.html#a1d90ce70b78495fb4eaf41141669e69e">is_online</a>())
<a name="l00229"></a>00229    {
<a name="l00230"></a>00230       <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#abf1133c14b54e09e514c043daa611730">header_map</a> headers;
<a name="l00231"></a>00231       headers[<span class="stringliteral">&quot;destination&quot;</span>] = topic;
<a name="l00232"></a>00232       headers[<span class="stringliteral">&quot;receipt&quot;</span>] = <span class="stringliteral">&quot;subscribe:&quot;</span> + topic;
<a name="l00233"></a>00233       <span class="keywordflow">switch</span> (ack_type)
<a name="l00234"></a>00234       {
<a name="l00235"></a>00235          <span class="keywordflow">case</span> <a class="code" href="structmoost_1_1mq_1_1stomp__client_1_1ack.html#a3e3458742c13808a443f754df5effcd9a6ff2eb68f1be75b4859605480d2ab8c9">stomp_client::ack::client</a>:
<a name="l00236"></a>00236             headers[<span class="stringliteral">&quot;ack&quot;</span>] = <span class="stringliteral">&quot;client&quot;</span>;
<a name="l00237"></a>00237             <span class="keywordflow">break</span>;
<a name="l00238"></a>00238 
<a name="l00239"></a>00239          <span class="keywordflow">default</span>:
<a name="l00240"></a>00240             headers[<span class="stringliteral">&quot;ack&quot;</span>] = <span class="stringliteral">&quot;auto&quot;</span>;
<a name="l00241"></a>00241             <span class="keywordflow">break</span>;
<a name="l00242"></a>00242       }
<a name="l00243"></a>00243       send_to_queue_async(<span class="stringliteral">&quot;SUBSCRIBE&quot;</span>, headers);
<a name="l00244"></a>00244    }
<a name="l00245"></a>00245 }
<a name="l00246"></a>00246 
<a name="l00247"></a><a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#a8797e4bfeae3a7e149384f625806eea0">00247</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1mq_1_1stomp__client.html#aaeac7d682b3bc95518ff93ed39806702">stomp_client::impl::unsubscribe</a>(<span class="keyword">const</span> std::string&amp; topic)
<a name="l00248"></a>00248 {
<a name="l00249"></a>00249    <span class="keywordflow">if</span> (!<a class="code" href="classmoost_1_1mq_1_1stomp__client.html#adc140389e80953ea82f2d79352e2cbbb">is_connected</a>())
<a name="l00250"></a>00250    {
<a name="l00251"></a>00251       <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;not connected&quot;</span>);
<a name="l00252"></a>00252    }
<a name="l00253"></a>00253 
<a name="l00254"></a>00254    <span class="keywordflow">if</span> (!m_streams.erase(topic))
<a name="l00255"></a>00255    {
<a name="l00256"></a>00256       <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;not subscribed to &quot;</span> + topic);
<a name="l00257"></a>00257    }
<a name="l00258"></a>00258 
<a name="l00259"></a>00259    <span class="keywordflow">if</span> (<a class="code" href="classmoost_1_1mq_1_1stomp__client.html#a1d90ce70b78495fb4eaf41141669e69e">is_online</a>())
<a name="l00260"></a>00260    {
<a name="l00261"></a>00261       <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#abf1133c14b54e09e514c043daa611730">header_map</a> headers;
<a name="l00262"></a>00262       headers[<span class="stringliteral">&quot;destination&quot;</span>] = topic;
<a name="l00263"></a>00263       send_to_queue_async(<span class="stringliteral">&quot;UNSUBSCRIBE&quot;</span>, headers);
<a name="l00264"></a>00264    }
<a name="l00265"></a>00265 }
<a name="l00266"></a>00266 
<a name="l00267"></a><a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#a9c3d359cf56737c55cb620ab92c2e313">00267</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1mq_1_1stomp__client.html#a7ffbf36d8ab3068c91ca6e4ae5a54e16">stomp_client::impl::send</a>(<span class="keyword">const</span> std::string&amp; topic, <span class="keyword">const</span> std::string&amp; message)
<a name="l00268"></a>00268 {
<a name="l00269"></a>00269    <span class="keywordflow">if</span> (!<a class="code" href="classmoost_1_1mq_1_1stomp__client.html#adc140389e80953ea82f2d79352e2cbbb">is_connected</a>())
<a name="l00270"></a>00270    {
<a name="l00271"></a>00271       <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;not connected&quot;</span>);
<a name="l00272"></a>00272    }
<a name="l00273"></a>00273 
<a name="l00274"></a>00274    <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#abf1133c14b54e09e514c043daa611730">header_map</a> headers;
<a name="l00275"></a>00275    headers[<span class="stringliteral">&quot;destination&quot;</span>] = topic;
<a name="l00276"></a>00276    send_to_queue_async(<span class="stringliteral">&quot;SEND&quot;</span>, headers, message);
<a name="l00277"></a>00277 }
<a name="l00278"></a>00278 
<a name="l00279"></a><a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#a61186634013aa0ac004cad779e160839">00279</a> boost::system::error_code <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#a61186634013aa0ac004cad779e160839">stomp_client::impl::send_to_queue</a>(<span class="keyword">const</span> std::string&amp; command, <span class="keyword">const</span> std::string&amp; body)
<a name="l00280"></a>00280 {
<a name="l00281"></a>00281    boost::system::error_code ec;
<a name="l00282"></a>00282    <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#abf1133c14b54e09e514c043daa611730">header_map</a> headers;
<a name="l00283"></a>00283    send_to_queue(command, headers, body, &amp;ec);
<a name="l00284"></a>00284    <span class="keywordflow">return</span> ec;
<a name="l00285"></a>00285 }
<a name="l00286"></a>00286 
<a name="l00287"></a><a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#acdfe88e2065c44be5234c9ea7542ea85">00287</a> boost::system::error_code <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#a61186634013aa0ac004cad779e160839">stomp_client::impl::send_to_queue</a>(<span class="keyword">const</span> std::string&amp; command, <span class="keyword">const</span> <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#abf1133c14b54e09e514c043daa611730">header_map</a>&amp; headers, <span class="keyword">const</span> std::string&amp; body)
<a name="l00288"></a>00288 {
<a name="l00289"></a>00289    boost::system::error_code ec;
<a name="l00290"></a>00290    send_to_queue(command, headers, body, &amp;ec);
<a name="l00291"></a>00291    <span class="keywordflow">return</span> ec;
<a name="l00292"></a>00292 }
<a name="l00293"></a>00293 
<a name="l00294"></a><a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#af4d174c0046c9c43a984a304c7349ace">00294</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#af4d174c0046c9c43a984a304c7349ace">stomp_client::impl::send_to_queue_async</a>(<span class="keyword">const</span> std::string&amp; command, <span class="keyword">const</span> std::string&amp; body)
<a name="l00295"></a>00295 {
<a name="l00296"></a>00296    <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#abf1133c14b54e09e514c043daa611730">header_map</a> headers;
<a name="l00297"></a>00297    send_to_queue(command, headers, body, 0);
<a name="l00298"></a>00298 }
<a name="l00299"></a>00299 
<a name="l00300"></a><a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#ac238d37ba25fb7f4d2d68385b152fd69">00300</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#af4d174c0046c9c43a984a304c7349ace">stomp_client::impl::send_to_queue_async</a>(<span class="keyword">const</span> std::string&amp; command, <span class="keyword">const</span> <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#abf1133c14b54e09e514c043daa611730">header_map</a>&amp; headers, <span class="keyword">const</span> std::string&amp; body)
<a name="l00301"></a>00301 {
<a name="l00302"></a>00302    send_to_queue(command, headers, body, 0);
<a name="l00303"></a>00303 }
<a name="l00304"></a>00304 
<a name="l00305"></a><a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#af1ad853fe94cd8ddf246331f731bcdec">00305</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#a61186634013aa0ac004cad779e160839">stomp_client::impl::send_to_queue</a>(<span class="keyword">const</span> std::string&amp; command, <span class="keyword">const</span> <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#abf1133c14b54e09e514c043daa611730">header_map</a>&amp; headers, <span class="keyword">const</span> std::string&amp; body, boost::system::error_code *ec)
<a name="l00306"></a>00306 {
<a name="l00307"></a>00307    boost::shared_ptr&lt;boost::asio::streambuf&gt; request(<span class="keyword">new</span> boost::asio::streambuf);
<a name="l00308"></a>00308    std::ostream os(request.get());
<a name="l00309"></a>00309 
<a name="l00310"></a>00310    os &lt;&lt; command &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00311"></a>00311 
<a name="l00312"></a>00312    <span class="keywordflow">for</span> (header_map::const_iterator i = headers.begin(); i != headers.end(); ++i)
<a name="l00313"></a>00313    {
<a name="l00314"></a>00314       os &lt;&lt; i-&gt;first &lt;&lt; <span class="stringliteral">&quot;:&quot;</span> &lt;&lt; i-&gt;second &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00315"></a>00315    }
<a name="l00316"></a>00316 
<a name="l00317"></a>00317    os &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span> &lt;&lt; body &lt;&lt; char(0);
<a name="l00318"></a>00318 
<a name="l00319"></a>00319    <a class="code" href="class__logger_8hpp.html#a3e51e62f2c7305e966f31dd5f158862d">MLOG_CLASS_TRACE</a>(<span class="stringliteral">&quot;sending &quot;</span> &lt;&lt; command &lt;&lt; <span class="stringliteral">&quot; to stomp queue (headers: &quot;</span> &lt;&lt; <a class="code" href="namespacemoost_1_1utils.html#aa5e99a3bdd4b7dbfd6f08b2b61315e49">moost::utils::stringify</a>(headers) &lt;&lt; <span class="stringliteral">&quot;) [async=&quot;</span> &lt;&lt; (ec == 0) &lt;&lt; <span class="stringliteral">&quot;]&quot;</span>);
<a name="l00320"></a>00320 
<a name="l00321"></a>00321    <span class="keywordflow">if</span> (ec)
<a name="l00322"></a>00322    {
<a name="l00323"></a>00323       boost::asio::write(m_socket, *request, boost::asio::transfer_all(), *ec);
<a name="l00324"></a>00324    }
<a name="l00325"></a>00325    <span class="keywordflow">else</span>
<a name="l00326"></a>00326    {
<a name="l00327"></a>00327       boost::asio::async_write(m_socket, *request, boost::asio::transfer_all(),
<a name="l00328"></a>00328          boost::bind(&amp;<a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#aaad7c43115deda33f5015b4e7c862358">stomp_client::impl::handle_write</a>, shared_from_this(), request, boost::asio::placeholders::error));
<a name="l00329"></a>00329    }
<a name="l00330"></a>00330 }
<a name="l00331"></a>00331 
<a name="l00332"></a><a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#a38ee004848896aeca7cd8ccb8cce995d">00332</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#a38ee004848896aeca7cd8ccb8cce995d">stomp_client::impl::receive_from_queue</a>(std::string&amp; command, <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#abf1133c14b54e09e514c043daa611730">header_map</a>&amp; headers, std::string&amp; body)
<a name="l00333"></a>00333 {
<a name="l00334"></a>00334    std::istream is(&amp;m_response);
<a name="l00335"></a>00335 
<a name="l00336"></a>00336    <span class="keywordflow">while</span> (std::getline(is, command) &amp;&amp; command.empty())
<a name="l00337"></a>00337    {
<a name="l00338"></a>00338    }
<a name="l00339"></a>00339 
<a name="l00340"></a>00340    std::string header;
<a name="l00341"></a>00341 
<a name="l00342"></a>00342    <span class="keywordflow">while</span> (std::getline(is, header) &amp;&amp; !header.empty())
<a name="l00343"></a>00343    {
<a name="l00344"></a>00344       <span class="keywordtype">size_t</span> sep = header.find(<span class="charliteral">&#39;:&#39;</span>);
<a name="l00345"></a>00345       <span class="keyword">const</span> std::string&amp; key = header.substr(0, sep);
<a name="l00346"></a>00346 
<a name="l00347"></a>00347       <span class="keywordflow">if</span> (headers.count(key) == 0)
<a name="l00348"></a>00348       {
<a name="l00349"></a>00349          headers[key] = header.substr(sep + 1);
<a name="l00350"></a>00350       }
<a name="l00351"></a>00351    }
<a name="l00352"></a>00352 
<a name="l00353"></a>00353    std::getline(is, body, <span class="charliteral">&#39;\0&#39;</span>);
<a name="l00354"></a>00354 }
<a name="l00355"></a>00355 
<a name="l00356"></a><a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#ae64137d85698725859ed595ab2fd2312">00356</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#ae64137d85698725859ed595ab2fd2312">stomp_client::impl::keepalive</a>()
<a name="l00357"></a>00357 {
<a name="l00358"></a>00358    m_keepalive_timer.expires_from_now(m_keepalive_interval);
<a name="l00359"></a>00359    m_keepalive_timer.async_wait(boost::bind(&amp;<a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#acc461615dc1c7b57fe6587ec7b3d7240">stomp_client::impl::handle_keepalive</a>, shared_from_this(), boost::asio::placeholders::error));
<a name="l00360"></a>00360 }
<a name="l00361"></a>00361 
<a name="l00362"></a><a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#ae4c8a14953ce478484b1f01ca62062dd">00362</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#ae4c8a14953ce478484b1f01ca62062dd">stomp_client::impl::dead_conn_detect</a>()
<a name="l00363"></a>00363 {
<a name="l00364"></a>00364    m_dead_conn_timer.expires_from_now(boost::posix_time::milliseconds(500));
<a name="l00365"></a>00365    m_dead_conn_timer.async_wait(boost::bind(&amp;<a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#a4c58fd1eaede533292c0de68c1371a82">stomp_client::impl::handle_dead_conn</a>, shared_from_this(), boost::asio::placeholders::error));
<a name="l00366"></a>00366 }
<a name="l00367"></a>00367 
<a name="l00368"></a><a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#aaad7c43115deda33f5015b4e7c862358">00368</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#aaad7c43115deda33f5015b4e7c862358">stomp_client::impl::handle_write</a>(boost::shared_ptr&lt;boost::asio::streambuf&gt;, <span class="keyword">const</span> boost::system::error_code&amp; err)
<a name="l00369"></a>00369 {
<a name="l00370"></a>00370    <span class="keywordflow">if</span> (err)
<a name="l00371"></a>00371    {
<a name="l00372"></a>00372       <a class="code" href="class__logger_8hpp.html#ae709025be49b577c87232b445049fd9d">MLOG_CLASS_INFO</a>(<span class="stringliteral">&quot;error while writing to stomp queue: &quot;</span> &lt;&lt; err.message());
<a name="l00373"></a>00373       m_error_cb(err, <span class="stringliteral">&quot;error writing to stomp queue&quot;</span>);
<a name="l00374"></a>00374    }
<a name="l00375"></a>00375 }
<a name="l00376"></a>00376 
<a name="l00377"></a><a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#acc461615dc1c7b57fe6587ec7b3d7240">00377</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#acc461615dc1c7b57fe6587ec7b3d7240">stomp_client::impl::handle_keepalive</a>(<span class="keyword">const</span> boost::system::error_code&amp; err)
<a name="l00378"></a>00378 {
<a name="l00379"></a>00379    <span class="keywordflow">if</span> (err != boost::asio::error::operation_aborted)
<a name="l00380"></a>00380    {
<a name="l00381"></a>00381       <a class="code" href="class__logger_8hpp.html#a3e51e62f2c7305e966f31dd5f158862d">MLOG_CLASS_TRACE</a>(<span class="stringliteral">&quot;sending keepalive connect to stomp queue&quot;</span>);
<a name="l00382"></a>00382       send_to_queue_async(<span class="stringliteral">&quot;CONNECT&quot;</span>);
<a name="l00383"></a>00383       keepalive();
<a name="l00384"></a>00384    }
<a name="l00385"></a>00385 }
<a name="l00386"></a>00386 
<a name="l00387"></a><a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#abcc78d85dd27ed9cf8a6702cff6daa2f">00387</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#abcc78d85dd27ed9cf8a6702cff6daa2f">stomp_client::impl::handle_reconnect</a>(<span class="keyword">const</span> boost::system::error_code&amp; err)
<a name="l00388"></a>00388 {
<a name="l00389"></a>00389    <span class="keywordflow">if</span> (err != boost::asio::error::operation_aborted)
<a name="l00390"></a>00390    {
<a name="l00391"></a>00391       reconnect();
<a name="l00392"></a>00392    }
<a name="l00393"></a>00393 }
<a name="l00394"></a>00394 
<a name="l00395"></a><a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#a4c58fd1eaede533292c0de68c1371a82">00395</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#a4c58fd1eaede533292c0de68c1371a82">stomp_client::impl::handle_dead_conn</a>(<span class="keyword">const</span> boost::system::error_code&amp; err)
<a name="l00396"></a>00396 {
<a name="l00397"></a>00397    <span class="keywordflow">if</span> (err != boost::asio::error::operation_aborted)
<a name="l00398"></a>00398    {
<a name="l00399"></a>00399       <span class="keywordflow">if</span> (m_streams.max_msg_interval_exceeded())
<a name="l00400"></a>00400       {
<a name="l00401"></a>00401          <a class="code" href="class__logger_8hpp.html#ae709025be49b577c87232b445049fd9d">MLOG_CLASS_INFO</a>(<span class="stringliteral">&quot;max message interval exceeded, forcing reconnect&quot;</span>);
<a name="l00402"></a>00402          m_error_cb(make_error_code(<a class="code" href="namespacemoost_1_1mq_1_1error.html#afa15d2b77bc67b28ee46d11b2ffa3ee2ad35e91168424b6204d9e9780ccd32bdf">error::connection_lost</a>), <span class="stringliteral">&quot;max message interval exceeded&quot;</span>);
<a name="l00403"></a>00403 
<a name="l00404"></a>00404          <span class="comment">// this will trigger a reconnect</span>
<a name="l00405"></a>00405          m_state = state::reconnecting;
<a name="l00406"></a>00406          m_socket.close();
<a name="l00407"></a>00407       }
<a name="l00408"></a>00408       <span class="keywordflow">else</span>
<a name="l00409"></a>00409       {
<a name="l00410"></a>00410          dead_conn_detect();
<a name="l00411"></a>00411       }
<a name="l00412"></a>00412    }
<a name="l00413"></a>00413 }
<a name="l00414"></a>00414 
<a name="l00415"></a><a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#a00834701edbe8f08b0be5a033b627640">00415</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#a00834701edbe8f08b0be5a033b627640">stomp_client::impl::handle_stomp_error</a>(<span class="keyword">const</span> <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#abf1133c14b54e09e514c043daa611730">header_map</a>&amp; headers, <span class="keyword">const</span> std::string&amp; <span class="comment">/*body*/</span>)
<a name="l00416"></a>00416 {
<a name="l00417"></a>00417    header_map::const_iterator msg = headers.find(<span class="stringliteral">&quot;message&quot;</span>);
<a name="l00418"></a>00418 
<a name="l00419"></a>00419    <span class="keywordflow">if</span> (msg != headers.end())
<a name="l00420"></a>00420    {
<a name="l00421"></a>00421       header_map::const_iterator rcpt = headers.find(<span class="stringliteral">&quot;receipt-id&quot;</span>);
<a name="l00422"></a>00422 
<a name="l00423"></a>00423       <span class="keywordflow">if</span> (rcpt != headers.end())
<a name="l00424"></a>00424       {
<a name="l00425"></a>00425          <span class="keywordflow">if</span> (rcpt-&gt;second.compare(0, 10, <span class="stringliteral">&quot;subscribe:&quot;</span>) == 0)
<a name="l00426"></a>00426          {
<a name="l00427"></a>00427             <span class="keyword">const</span> std::string&amp; topic = rcpt-&gt;second.substr(10);
<a name="l00428"></a>00428             m_streams.erase(topic);
<a name="l00429"></a>00429             m_error_cb(make_error_code(<a class="code" href="namespacemoost_1_1mq_1_1error.html#afa15d2b77bc67b28ee46d11b2ffa3ee2aca138527ef959b060798d2f5c9934725">error::subscribe_failed</a>), topic);
<a name="l00430"></a>00430             <span class="keywordflow">return</span>;
<a name="l00431"></a>00431          }
<a name="l00432"></a>00432       }
<a name="l00433"></a>00433 
<a name="l00434"></a>00434       m_error_cb(make_error_code(<a class="code" href="namespacemoost_1_1mq_1_1error.html#afa15d2b77bc67b28ee46d11b2ffa3ee2a01f015ed5ef6512aa7ea46dd5274e8ba">error::queue_error</a>), msg-&gt;second);
<a name="l00435"></a>00435    }
<a name="l00436"></a>00436    <span class="keywordflow">else</span>
<a name="l00437"></a>00437    {
<a name="l00438"></a>00438       m_error_cb(make_error_code(<a class="code" href="namespacemoost_1_1mq_1_1error.html#afa15d2b77bc67b28ee46d11b2ffa3ee2a01f015ed5ef6512aa7ea46dd5274e8ba">error::queue_error</a>), <span class="stringliteral">&quot;unknown queue error&quot;</span>);
<a name="l00439"></a>00439    }
<a name="l00440"></a>00440 }
<a name="l00441"></a>00441 
<a name="l00442"></a><a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#a642ab72a8170426213a911bee5d61ccd">00442</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#a642ab72a8170426213a911bee5d61ccd">stomp_client::impl::handle_recv</a>(<span class="keyword">const</span> boost::system::error_code&amp; err)
<a name="l00443"></a>00443 {
<a name="l00444"></a>00444    <span class="keywordflow">if</span> (!<a class="code" href="classmoost_1_1mq_1_1stomp__client.html#adc140389e80953ea82f2d79352e2cbbb">is_connected</a>())
<a name="l00445"></a>00445    {
<a name="l00446"></a>00446       <span class="keywordflow">return</span>;
<a name="l00447"></a>00447    }
<a name="l00448"></a>00448 
<a name="l00449"></a>00449    <span class="keywordflow">if</span> (err)
<a name="l00450"></a>00450    {
<a name="l00451"></a>00451       <span class="keywordflow">if</span> (m_state != state::reconnecting)
<a name="l00452"></a>00452       {
<a name="l00453"></a>00453          <a class="code" href="class__logger_8hpp.html#ae709025be49b577c87232b445049fd9d">MLOG_CLASS_INFO</a>(<span class="stringliteral">&quot;error while receiving from stomp queue: &quot;</span> &lt;&lt; err.message());
<a name="l00454"></a>00454          m_error_cb(make_error_code(<a class="code" href="namespacemoost_1_1mq_1_1error.html#afa15d2b77bc67b28ee46d11b2ffa3ee2ad35e91168424b6204d9e9780ccd32bdf">error::connection_lost</a>), err.message());
<a name="l00455"></a>00455          m_state = state::reconnecting;
<a name="l00456"></a>00456       }
<a name="l00457"></a>00457 
<a name="l00458"></a>00458       m_keepalive_timer.cancel();
<a name="l00459"></a>00459       m_dead_conn_timer.cancel();
<a name="l00460"></a>00460       reconnect();
<a name="l00461"></a>00461 
<a name="l00462"></a>00462       <span class="keywordflow">return</span>;
<a name="l00463"></a>00463    }
<a name="l00464"></a>00464 
<a name="l00465"></a>00465    std::string command, body;
<a name="l00466"></a>00466    <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#abf1133c14b54e09e514c043daa611730">header_map</a> headers;
<a name="l00467"></a>00467    receive_from_queue(command, headers, body);
<a name="l00468"></a>00468 
<a name="l00469"></a>00469    <a class="code" href="class__logger_8hpp.html#a3e51e62f2c7305e966f31dd5f158862d">MLOG_CLASS_TRACE</a>(<span class="stringliteral">&quot;got &quot;</span> &lt;&lt; command &lt;&lt; <span class="stringliteral">&quot; from stomp queue (headers: &quot;</span> &lt;&lt; <a class="code" href="namespacemoost_1_1utils.html#aa5e99a3bdd4b7dbfd6f08b2b61315e49">moost::utils::stringify</a>(headers) &lt;&lt; <span class="stringliteral">&quot;)&quot;</span>);
<a name="l00470"></a>00470 
<a name="l00471"></a>00471    <span class="keywordflow">if</span> (command == <span class="stringliteral">&quot;MESSAGE&quot;</span>)
<a name="l00472"></a>00472    {
<a name="l00473"></a>00473       on_message(headers, body);
<a name="l00474"></a>00474    }
<a name="l00475"></a>00475    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (command == <span class="stringliteral">&quot;CONNECTED&quot;</span>)
<a name="l00476"></a>00476    {
<a name="l00477"></a>00477       <span class="comment">// ok, this is the normal keepalive response</span>
<a name="l00478"></a>00478    }
<a name="l00479"></a>00479    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (command == <span class="stringliteral">&quot;ERROR&quot;</span>)
<a name="l00480"></a>00480    {
<a name="l00481"></a>00481       handle_stomp_error(headers, body);
<a name="l00482"></a>00482    }
<a name="l00483"></a>00483    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (command == <span class="stringliteral">&quot;RECEIPT&quot;</span>)
<a name="l00484"></a>00484    {
<a name="l00485"></a>00485       <span class="comment">// there&#39;s no need to handle this, all went well</span>
<a name="l00486"></a>00486    }
<a name="l00487"></a>00487    <span class="keywordflow">else</span>
<a name="l00488"></a>00488    {
<a name="l00489"></a>00489       <a class="code" href="class__logger_8hpp.html#ac866e91d8004890d9ed31fcbcb3a0dbf">MLOG_CLASS_WARN</a>(<span class="stringliteral">&quot;got unexpected &quot;</span> &lt;&lt; command &lt;&lt; <span class="stringliteral">&quot; from stomp queue&quot;</span>);
<a name="l00490"></a>00490    }
<a name="l00491"></a>00491 
<a name="l00492"></a>00492    recv_more();
<a name="l00493"></a>00493 }
<a name="l00494"></a>00494 
<a name="l00495"></a><a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#a32a12d0a28b042937186612716e70b4c">00495</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#a32a12d0a28b042937186612716e70b4c">stomp_client::impl::on_message</a>(<span class="keyword">const</span> <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#abf1133c14b54e09e514c043daa611730">header_map</a>&amp; headers, <span class="keyword">const</span> std::string&amp; msg)
<a name="l00496"></a>00496 {
<a name="l00497"></a>00497    header_map::const_iterator hit = headers.find(<span class="stringliteral">&quot;destination&quot;</span>);
<a name="l00498"></a>00498 
<a name="l00499"></a>00499    <span class="keywordflow">if</span> (hit != headers.end())
<a name="l00500"></a>00500    {
<a name="l00501"></a>00501       <a class="code" href="structmoost_1_1mq_1_1stomp__client_1_1ack.html#a3e3458742c13808a443f754df5effcd9">stomp_client::ack::type</a> ack_type;
<a name="l00502"></a>00502 
<a name="l00503"></a>00503       <span class="keywordflow">if</span> (m_streams.push_message(hit-&gt;second, msg, ack_type))
<a name="l00504"></a>00504       {
<a name="l00505"></a>00505          <span class="keywordflow">if</span> (ack_type == <a class="code" href="structmoost_1_1mq_1_1stomp__client_1_1ack.html#a3e3458742c13808a443f754df5effcd9a6ff2eb68f1be75b4859605480d2ab8c9">stomp_client::ack::client</a>)
<a name="l00506"></a>00506          {
<a name="l00507"></a>00507             hit = headers.find(<span class="stringliteral">&quot;message-id&quot;</span>);
<a name="l00508"></a>00508 
<a name="l00509"></a>00509             <span class="keywordflow">if</span> (hit != headers.end())
<a name="l00510"></a>00510             {
<a name="l00511"></a>00511                <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#abf1133c14b54e09e514c043daa611730">header_map</a> ack_headers;
<a name="l00512"></a>00512                ack_headers.insert(*hit);
<a name="l00513"></a>00513                send_to_queue_async(<span class="stringliteral">&quot;ACK&quot;</span>, ack_headers);
<a name="l00514"></a>00514             }
<a name="l00515"></a>00515          }
<a name="l00516"></a>00516       }
<a name="l00517"></a>00517       <span class="keywordflow">else</span>
<a name="l00518"></a>00518       {
<a name="l00519"></a>00519          <a class="code" href="class__logger_8hpp.html#a0ac729e36a608d22b69d2a136901b503">MLOG_CLASS_DEBUG</a>(<span class="stringliteral">&quot;no stream found for topic: &quot;</span> + hit-&gt;second);
<a name="l00520"></a>00520       }
<a name="l00521"></a>00521    }
<a name="l00522"></a>00522    <span class="keywordflow">else</span>
<a name="l00523"></a>00523    {
<a name="l00524"></a>00524       <a class="code" href="class__logger_8hpp.html#ac866e91d8004890d9ed31fcbcb3a0dbf">MLOG_CLASS_WARN</a>(<span class="stringliteral">&quot;skipping message without destination&quot;</span>);
<a name="l00525"></a>00525    }
<a name="l00526"></a>00526 }
<a name="l00527"></a>00527 
<a name="l00528"></a><a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#a70c256c50b31ae2cdbcec718c6958ca6">00528</a> <span class="keywordtype">void</span> <a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#a70c256c50b31ae2cdbcec718c6958ca6">stomp_client::impl::recv_more</a>()
<a name="l00529"></a>00529 {
<a name="l00530"></a>00530    boost::asio::async_read_until(m_socket, m_response, <span class="keywordtype">char</span>(0),
<a name="l00531"></a>00531                                  boost::bind(&amp;<a class="code" href="classmoost_1_1mq_1_1stomp__client_1_1impl.html#a642ab72a8170426213a911bee5d61ccd">stomp_client::impl::handle_recv</a>, shared_from_this(),
<a name="l00532"></a>00532                                              boost::asio::placeholders::error));
<a name="l00533"></a>00533 }
<a name="l00534"></a>00534 
<a name="l00535"></a>00535 }}
</pre></div></div><!-- contents -->
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="stomp__client__impl_8cpp.html">stomp_client_impl.cpp</a>      </li>

    <li class="footer">Generated on Wed Feb 20 2013 05:56:08 for libmoost by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
